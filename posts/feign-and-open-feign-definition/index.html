<!DOCTYPE html><html lang="en" class="scroll-smooth"><head><meta charset="UTF-8"><style>:where(img){height:auto}</style><meta name="viewport" content="width=device-width"><link rel="icon" type="image" href="/astro/favicon.ico"><link rel="canonical" href="https://chou401.github.io/astro/posts/feign-and-open-feign-definition/"><meta name="generator" content="Astro v4.9.2"><!-- General Meta Tags --><title>Feign &amp; openFeign | 知道的越多，才知知道的越少</title><meta name="title" content="Feign &amp; openFeign | 知道的越多，才知知道的越少"><meta name="description" content="feign &amp; openFeign 介绍以及使用"><meta name="author" content="chou401"><link rel="sitemap" href="/sitemap-index.xml"><!-- Open Graph / Facebook --><meta property="og:title" content="Feign &amp; openFeign | 知道的越多，才知知道的越少"><meta property="og:description" content="feign &amp; openFeign 介绍以及使用"><meta property="og:url" content="https://chou401.github.io/astro/posts/feign-and-open-feign-definition/"><meta property="og:image" content="https://chou401.github.io/posts/feign--openfeign.png"><!-- Article Published/Modified time --><meta property="article:published_time" content="2024-02-22T15:00:03.000Z"><meta property="article:modified_time" content="2024-05-16T14:00:40.000Z"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://chou401.github.io/astro/posts/feign-and-open-feign-definition/"><meta property="twitter:title" content="Feign &amp; openFeign | 知道的越多，才知知道的越少"><meta property="twitter:description" content="feign &amp; openFeign 介绍以及使用"><meta property="twitter:image" content="https://chou401.github.io/posts/feign--openfeign.png"><!-- Google Font --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&amp;display=swap" rel="stylesheet"><meta name="theme-color" content=""><meta name="astro-view-transitions-enabled" content="true"><meta name="astro-view-transitions-fallback" content="animate"><script src="/astro/toggle-theme.js"></script><style>*,:before,:after{box-sizing:border-box;border:0 solid #e5e7eb}:before,:after{--tw-content:""}html,:host{-webkit-text-size-adjust:100%;tab-size:4;font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent;font-family:ui-sans-serif,system-ui,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}body{line-height:inherit;margin:0}hr{color:inherit;border-top-width:1px;height:0}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-feature-settings:normal;font-variation-settings:normal;font-family:IBM Plex Mono,monospace;font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-feature-settings:inherit;font-variation-settings:inherit;font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:#0000;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button{height:auto}::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dl,dd,h1,h2,h3,h4,h5,h6,hr,figure,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}ol,ul,menu{margin:0;padding:0;list-style:none}dialog{padding:0}textarea{resize:vertical}input::-moz-placeholder{opacity:1;color:#9ca3af}textarea::-moz-placeholder{opacity:1;color:#9ca3af}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}button,[role=button]{cursor:pointer}:disabled{cursor:default}img,svg,video,canvas,audio,iframe,embed,object{vertical-align:middle;display:block}img,video{max-width:100%;height:auto}[hidden]{display:none}:root,html[data-theme=light]{--color-fill:251,254,251;--color-text-base:40,39,40;--color-accent:0,108,172;--color-card:230,230,230;--color-card-muted:205,205,205;--color-border:236,233,233}html[data-theme=dark]{--color-fill:33,39,55;--color-text-base:234,237,243;--color-accent:255,107,1;--color-card:52,63,96;--color-card-muted:138,51,2;--color-border:171,75,8}#sun-svg,html[data-theme=dark] #moon-svg{display:none}#moon-svg,html[data-theme=dark] #sun-svg{display:block}body{--tw-bg-opacity:1;background-color:rgba(var(--color-fill),var(--tw-bg-opacity));--tw-text-opacity:1;color:rgba(var(--color-text-base),var(--tw-text-opacity));flex-direction:column;min-height:100svh;font-family:IBM Plex Mono,monospace;display:flex}body ::selection{background-color:rgba(var(--color-accent),var(--tw-bg-opacity));--tw-bg-opacity:.7;--tw-text-opacity:1;color:rgba(var(--color-fill),var(--tw-text-opacity))}body::selection{background-color:rgba(var(--color-accent),var(--tw-bg-opacity));--tw-bg-opacity:.7;--tw-text-opacity:1;color:rgba(var(--color-fill),var(--tw-text-opacity))}section,footer{max-width:48rem;margin-left:auto;margin-right:auto;padding-left:1rem;padding-right:1rem}a{outline-offset:1px;outline-width:2px;outline-color:rgb(var(--color-accent))}a:focus-visible{outline-style:dashed;text-decoration-line:none}svg{fill:rgb(var(--color-text-base));width:1.5rem;height:1.5rem;display:inline-block}.group:hover svg{fill:rgb(var(--color-accent))}svg.icon-tabler{--tw-scale-x:1.25;--tw-scale-y:1.25;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y));fill:#0000;stroke:currentColor;stroke-width:2px;opacity:.9;width:1.5rem;height:1.5rem;display:inline-block}.group:hover svg.icon-tabler{fill:#0000}@media (min-width:640px){svg.icon-tabler{--tw-scale-x:1.1;--tw-scale-y:1.1;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}}.prose :where(h1,h2,h3,h4,h5,h6,th):not(:where([class~=not-prose],[class~=not-prose] *)){--tw-text-opacity:1!important;color:rgba(var(--color-text-base),var(--tw-text-opacity))!important;margin-bottom:.75rem!important}.prose :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){font-style:italic}.prose :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){--tw-text-opacity:1!important;color:rgba(var(--color-text-base),var(--tw-text-opacity))!important}.prose :where(a):not(:where([class~=not-prose],[class~=not-prose] *)){text-underline-offset:8px;--tw-text-opacity:1!important;color:rgba(var(--color-text-base),var(--tw-text-opacity))!important;text-decoration-style:dashed!important}.prose :where(a):not(:where([class~=not-prose],[class~=not-prose] *)):hover{--tw-text-opacity:1;color:rgba(var(--color-accent),var(--tw-text-opacity))}.prose :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){--tw-border-opacity:.5;opacity:.8;border-left-color:rgba(var(--color-accent),var(--tw-border-opacity))!important}.prose :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){opacity:.7;--tw-text-opacity:1!important;color:rgba(var(--color-text-base),var(--tw-text-opacity))!important}.prose :where(strong):not(:where([class~=not-prose],[class~=not-prose] *)){--tw-text-opacity:1!important;color:rgba(var(--color-text-base),var(--tw-text-opacity))!important}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:rgba(var(--color-card),var(--tw-bg-opacity));--tw-bg-opacity:.75;border-radius:.25rem;padding:.25rem}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):before,.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):after{--tw-content:none!important;content:var(--tw-content)!important}.prose :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){--tw-text-opacity:1!important;color:rgba(var(--color-text-base),var(--tw-text-opacity))!important}.prose :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){overflow-x:clip;--tw-text-opacity:1!important;color:rgba(var(--color-text-base),var(--tw-text-opacity))!important}.prose * :where(li):not(:where([class~=not-prose],[class~=not-prose] *))::marker,.prose :where(li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:rgba(var(--color-accent),var(--tw-text-opacity))!important}.prose :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){--tw-text-opacity:1;color:rgba(var(--color-text-base),var(--tw-text-opacity))}.prose :where(th):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(td):not(:where([class~=not-prose],[class~=not-prose] *)){--tw-border-opacity:1;border-width:1px;border-color:rgba(var(--color-border),var(--tw-border-opacity))}.prose :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){--tw-border-opacity:1;border-width:2px;border-color:rgba(var(--color-border),var(--tw-border-opacity));margin-left:auto;margin-right:auto;margin-top:.5rem!important;margin-bottom:.5rem!important}.prose :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){--tw-border-opacity:1!important;border-color:rgba(var(--color-border),var(--tw-border-opacity))!important}.prose a{overflow-wrap:break-word}.prose a:hover{--tw-text-opacity:1!important;color:rgba(var(--color-accent),var(--tw-text-opacity))!important}.prose thead th:first-child,tbody td:first-child,tfoot td:first-child{padding-left:.571429em}.prose h2#table-of-contents{margin-bottom:.5rem}.prose details{cursor:pointer;-webkit-user-select:none;user-select:none;--tw-text-opacity:1;color:rgba(var(--color-text-base),var(--tw-text-opacity));display:inline-block}.prose summary{outline-offset:1px;outline-width:2px;outline-color:rgb(var(--color-accent))}.prose summary:focus-visible{outline-style:dashed;text-decoration-line:none}.prose h2#table-of-contents+p{display:none}html{overflow-y:scroll}::-webkit-scrollbar{width:.75rem}::-webkit-scrollbar-track{--tw-bg-opacity:1;background-color:rgba(var(--color-fill),var(--tw-bg-opacity))}::-webkit-scrollbar-thumb{--tw-bg-opacity:1;background-color:rgba(var(--color-card),var(--tw-bg-opacity))}::-webkit-scrollbar-thumb:hover{--tw-bg-opacity:1;background-color:rgba(var(--color-card-muted),var(--tw-bg-opacity))}code,blockquote{word-wrap:break-word}pre>code{white-space:pre}*,:before,:after,::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:#3b82f680;--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }.container{width:100%}@media (min-width:640px){.container{max-width:640px}}.prose{color:var(--tw-prose-body);max-width:65ch}.prose :where(p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em;margin-bottom:1.25em}.prose :where([class~=lead]):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-lead);margin-top:1.2em;margin-bottom:1.2em;font-size:1.25em;line-height:1.6}.prose :where(a):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-links);font-weight:500;text-decoration:underline}.prose :where(strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-bold);font-weight:600}.prose :where(a strong):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(blockquote strong):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(thead th strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em;margin-bottom:1.25em;padding-inline-start:1.625em;list-style-type:decimal}.prose :where(ol[type=A]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=A s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-alpha}.prose :where(ol[type=a s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-alpha}.prose :where(ol[type=I]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type=I s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:upper-roman}.prose :where(ol[type=i s]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:lower-roman}.prose :where(ol[type="1"]):not(:where([class~=not-prose],[class~=not-prose] *)){list-style-type:decimal}.prose :where(ul):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em;margin-bottom:1.25em;padding-inline-start:1.625em;list-style-type:disc}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-counters);font-weight:400}.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *))::marker{color:var(--tw-prose-bullets)}.prose :where(dt):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);margin-top:1.25em;font-weight:600}.prose :where(hr):not(:where([class~=not-prose],[class~=not-prose] *)){border-color:var(--tw-prose-hr);border-top-width:1px;margin-top:3em;margin-bottom:3em}.prose :where(blockquote):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-quotes);border-inline-start-width:.25rem;border-inline-start-color:var(--tw-prose-quote-borders);quotes:"“""”""‘""’";margin-top:1.6em;margin-bottom:1.6em;padding-inline-start:1em;font-style:italic;font-weight:500}.prose :where(blockquote p:first-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):before{content:open-quote}.prose :where(blockquote p:last-of-type):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:close-quote}.prose :where(h1):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);margin-top:0;margin-bottom:.888889em;font-size:2.25em;font-weight:800;line-height:1.11111}.prose :where(h1 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:900}.prose :where(h2):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);margin-top:2em;margin-bottom:1em;font-size:1.5em;font-weight:700;line-height:1.33333}.prose :where(h2 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:800}.prose :where(h3):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);margin-top:1.6em;margin-bottom:.6em;font-size:1.25em;font-weight:600;line-height:1.6}.prose :where(h3 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(h4):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);margin-top:1.5em;margin-bottom:.5em;font-weight:600;line-height:1.5}.prose :where(h4 strong):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-weight:700}.prose :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:2em;margin-bottom:2em}.prose :where(picture):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:2em;margin-bottom:2em;display:block}.prose :where(video):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:2em;margin-bottom:2em}.prose :where(kbd):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-kbd);box-shadow:0 0 0 1px rgb(var(--tw-prose-kbd-shadows)/10%),0 3px rgb(var(--tw-prose-kbd-shadows)/10%);padding-top:.1875em;padding-inline-end:.375em;padding-bottom:.1875em;border-radius:.3125rem;padding-inline-start:.375em;font-family:inherit;font-size:.875em;font-weight:500}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)){font-size:.875em;font-weight:600}.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):before,.prose :where(code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:"`"}.prose :where(a code):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(h1 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(h2 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.875em}.prose :where(h3 code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit;font-size:.9em}.prose :where(h4 code):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(blockquote code):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(thead th code):not(:where([class~=not-prose],[class~=not-prose] *)){color:inherit}.prose :where(pre):not(:where([class~=not-prose],[class~=not-prose] *)){background-color:var(--tw-prose-pre-bg);padding-top:.857143em;padding-inline-end:1.14286em;padding-bottom:.857143em;border-radius:.375rem;margin-top:1.71429em;margin-bottom:1.71429em;padding-inline-start:1.14286em;font-size:.875em;font-weight:400;line-height:1.71429;overflow-x:auto}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)){font-weight:inherit;color:inherit;font-size:inherit;font-family:inherit;line-height:inherit;background-color:#0000;border-width:0;border-radius:0;padding:0}.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):before,.prose :where(pre code):not(:where([class~=not-prose],[class~=not-prose] *)):after{content:none}.prose :where(table):not(:where([class~=not-prose],[class~=not-prose] *)){table-layout:auto;text-align:start;width:100%;margin-top:2em;margin-bottom:2em;font-size:.875em;line-height:1.71429}.prose :where(thead):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-width:1px;border-bottom-color:var(--tw-prose-th-borders)}.prose :where(thead th):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-headings);vertical-align:bottom;padding-inline-end:.571429em;padding-bottom:.571429em;padding-inline-start:.571429em;font-weight:600}.prose :where(tbody tr):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-width:1px;border-bottom-color:var(--tw-prose-td-borders)}.prose :where(tbody tr:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){border-bottom-width:0}.prose :where(tbody td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:baseline}.prose :where(tfoot):not(:where([class~=not-prose],[class~=not-prose] *)){border-top-width:1px;border-top-color:var(--tw-prose-th-borders)}.prose :where(tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){vertical-align:top}.prose :where(figure>*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0;margin-bottom:0}.prose :where(figcaption):not(:where([class~=not-prose],[class~=not-prose] *)){color:var(--tw-prose-captions);margin-top:.857143em;font-size:.875em;line-height:1.42857}.prose{--tw-prose-body:#374151;--tw-prose-headings:#111827;--tw-prose-lead:#4b5563;--tw-prose-links:#111827;--tw-prose-bold:#111827;--tw-prose-counters:#6b7280;--tw-prose-bullets:#d1d5db;--tw-prose-hr:#e5e7eb;--tw-prose-quotes:#111827;--tw-prose-quote-borders:#e5e7eb;--tw-prose-captions:#6b7280;--tw-prose-kbd:#111827;--tw-prose-kbd-shadows:17 24 39;--tw-prose-code:#111827;--tw-prose-pre-code:#e5e7eb;--tw-prose-pre-bg:#1f2937;--tw-prose-th-borders:#d1d5db;--tw-prose-td-borders:#e5e7eb;--tw-prose-invert-body:#d1d5db;--tw-prose-invert-headings:#fff;--tw-prose-invert-lead:#9ca3af;--tw-prose-invert-links:#fff;--tw-prose-invert-bold:#fff;--tw-prose-invert-counters:#9ca3af;--tw-prose-invert-bullets:#4b5563;--tw-prose-invert-hr:#374151;--tw-prose-invert-quotes:#f3f4f6;--tw-prose-invert-quote-borders:#374151;--tw-prose-invert-captions:#9ca3af;--tw-prose-invert-kbd:#fff;--tw-prose-invert-kbd-shadows:255 255 255;--tw-prose-invert-code:#fff;--tw-prose-invert-pre-code:#d1d5db;--tw-prose-invert-pre-bg:#00000080;--tw-prose-invert-th-borders:#4b5563;--tw-prose-invert-td-borders:#374151;font-size:1rem;line-height:1.75}.prose :where(picture>img):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0;margin-bottom:0}.prose :where(li):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.5em;margin-bottom:.5em}.prose :where(ol>li):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(ul>li):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:.375em}.prose :where(.prose>ul>li p):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.75em;margin-bottom:.75em}.prose :where(.prose>ul>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ul>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(.prose>ol>li>p:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em}.prose :where(.prose>ol>li>p:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:1.25em}.prose :where(ul ul,ul ol,ol ul,ol ol):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.75em;margin-bottom:.75em}.prose :where(dl):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:1.25em;margin-bottom:1.25em}.prose :where(dd):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:.5em;padding-inline-start:1.625em}.prose :where(hr+*):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(h2+*):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(h3+*):not(:where([class~=not-prose],[class~=not-prose] *)),.prose :where(h4+*):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(thead th:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(thead th:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(tbody td,tfoot td):not(:where([class~=not-prose],[class~=not-prose] *)){padding-top:.571429em;padding-inline-end:.571429em;padding-bottom:.571429em;padding-inline-start:.571429em}.prose :where(tbody td:first-child,tfoot td:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-start:0}.prose :where(tbody td:last-child,tfoot td:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){padding-inline-end:0}.prose :where(figure):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:2em;margin-bottom:2em}.prose :where(.prose>:first-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-top:0}.prose :where(.prose>:last-child):not(:where([class~=not-prose],[class~=not-prose] *)){margin-bottom:0}.display-none{display:none}.focus-outline{outline-offset:1px;outline-width:2px;outline-color:rgb(var(--color-accent))}.focus-outline:focus-visible{outline-style:dashed;text-decoration-line:none}.sr-only{clip:rect(0,0,0,0);white-space:nowrap;border-width:0;width:1px;height:1px;margin:-1px;padding:0;position:absolute;overflow:hidden}.pointer-events-none{pointer-events:none}.visible{visibility:visible}.invisible{visibility:hidden}.static{position:static}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-y-0{top:0;bottom:0}.-top-3{top:-.75rem}.-top-full{top:-100%}.left-0{left:0}.left-16{left:4rem}.right-3{right:.75rem}.z-50{z-index:50}.col-span-2{grid-column:span 2/span 2}.m-1{margin:.25rem}.mx-1{margin-left:.25rem;margin-right:.25rem}.mx-auto{margin-left:auto;margin-right:auto}.my-1{margin-top:.25rem;margin-bottom:.25rem}.my-2{margin-top:.5rem;margin-bottom:.5rem}.my-3{margin-top:.75rem;margin-bottom:.75rem}.my-4{margin-top:1rem;margin-bottom:1rem}.my-6{margin-top:1.5rem;margin-bottom:1.5rem}.my-8{margin-top:2rem;margin-bottom:2rem}.-mr-5{margin-right:-1.25rem}.mb-1{margin-bottom:.25rem}.mb-14{margin-bottom:3.5rem}.mb-2{margin-bottom:.5rem}.mb-28{margin-bottom:7rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.ml-2{margin-left:.5rem}.ml-4{margin-left:1rem}.mr-2{margin-right:.5rem}.mr-4{margin-right:1rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mt-8{margin-top:2rem}.mt-auto{margin-top:auto}.block{display:block}.inline-block{display:inline-block}.inline{display:inline}.flex{display:flex}.table{display:table}.grid{display:grid}.contents{display:contents}.hidden{display:none}.h-6{height:1.5rem}.w-44{width:11rem}.w-6{width:1.5rem}.w-full{width:100%}.min-w-\[1\.375rem\]{min-width:1.375rem}.max-w-3xl{max-width:48rem}.flex-1{flex:1}.rotate-90{--tw-rotate:90deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.scale-100{--tw-scale-x:1;--tw-scale-y:1;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.scale-110{--tw-scale-x:1.1;--tw-scale-y:1.1;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.scale-125{--tw-scale-x:1.25;--tw-scale-y:1.25;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.scale-75{--tw-scale-x:.75;--tw-scale-y:.75;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.scale-90{--tw-scale-x:.9;--tw-scale-y:.9;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.scale-95{--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.select-none{-webkit-user-select:none;user-select:none}.resize{resize:both}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.grid-rows-4{grid-template-rows:repeat(4,minmax(0,1fr))}.flex-col{flex-direction:column}.flex-col-reverse{flex-direction:column-reverse}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-center{align-items:center}.justify-start{justify-content:flex-start}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:.25rem}.gap-6{gap:1.5rem}.gap-x-2{-moz-column-gap:.5rem;column-gap:.5rem}.gap-y-2{row-gap:.5rem}.space-x-2>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(.5rem*var(--tw-space-x-reverse));margin-left:calc(.5rem*calc(1 - var(--tw-space-x-reverse)))}.self-end{align-self:flex-end}.scroll-smooth{scroll-behavior:smooth}.whitespace-nowrap{white-space:nowrap}.text-nowrap{text-wrap:nowrap}.rounded{border-radius:.25rem}.border{border-width:1px}.border-skin-fill{--tw-border-opacity:1;border-color:rgba(var(--color-text-base),var(--tw-border-opacity))}.border-skin-line{--tw-border-opacity:1;border-color:rgba(var(--color-border),var(--tw-border-opacity))}.border-opacity-40{--tw-border-opacity:.4}.bg-skin-accent{--tw-bg-opacity:1;background-color:rgba(var(--color-accent),var(--tw-bg-opacity))}.bg-skin-card{--tw-bg-opacity:1;background-color:rgba(var(--color-card),var(--tw-bg-opacity))}.bg-skin-fill{--tw-bg-opacity:1;background-color:rgba(var(--color-fill),var(--tw-bg-opacity))}.fill-skin-accent{fill:rgb(var(--color-accent))}.fill-skin-base{fill:rgb(var(--color-text-base))}.p-2{padding:.5rem}.p-3{padding:.75rem}.p-4{padding:1rem}.px-0{padding-left:0;padding-right:0}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.py-6{padding-top:1.5rem;padding-bottom:1.5rem}.pb-6{padding-bottom:1.5rem}.pl-10{padding-left:2.5rem}.pl-2{padding-left:.5rem}.pr-2{padding-right:.5rem}.pr-3{padding-right:.75rem}.text-center{text-align:center}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-9xl{font-size:8rem;line-height:1}.text-base{font-size:1rem;line-height:1.5rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:.75rem;line-height:1rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.lowercase{text-transform:lowercase}.capitalize{text-transform:capitalize}.italic{font-style:italic}.leading-4{line-height:1rem}.tracking-wider{letter-spacing:.05em}.text-skin-accent{--tw-text-opacity:1;color:rgba(var(--color-accent),var(--tw-text-opacity))}.text-skin-base{--tw-text-opacity:1;color:rgba(var(--color-text-base),var(--tw-text-opacity))}.text-skin-inverted{--tw-text-opacity:1;color:rgba(var(--color-fill),var(--tw-text-opacity))}.underline{text-decoration-line:underline}.decoration-dashed{text-decoration-style:dashed}.decoration-wavy{text-decoration-style:wavy}.decoration-2{text-decoration-thickness:2px}.underline-offset-4{text-underline-offset:4px}.underline-offset-8{text-underline-offset:8px}.opacity-50{opacity:.5}.opacity-75{opacity:.75}.opacity-80{opacity:.8}.filter{filter:var(--tw-blur)var(--tw-brightness)var(--tw-contrast)var(--tw-grayscale)var(--tw-hue-rotate)var(--tw-invert)var(--tw-saturate)var(--tw-sepia)var(--tw-drop-shadow)}.transition-all{transition-property:all;transition-duration:.15s;transition-timing-function:cubic-bezier(.4,0,.2,1)}.transition-opacity{transition-property:opacity;transition-duration:.15s;transition-timing-function:cubic-bezier(.4,0,.2,1)}.duration-75{transition-duration:75ms}.placeholder\:italic::placeholder{font-style:italic}.placeholder\:text-opacity-75::placeholder{--tw-text-opacity:.75}.hover\:-top-0:hover{top:0}.hover\:-top-0\.5:hover{top:-.125rem}.hover\:rotate-12:hover{--tw-rotate:12deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.hover\:rotate-6:hover{--tw-rotate:6deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.hover\:text-skin-accent:hover{--tw-text-opacity:1;color:rgba(var(--color-accent),var(--tw-text-opacity))}.hover\:text-skin-base:hover{--tw-text-opacity:1;color:rgba(var(--color-text-base),var(--tw-text-opacity))}.hover\:underline:hover{text-decoration-line:underline}.hover\:opacity-75:hover{opacity:.75}.focus\:border-skin-accent:focus{--tw-border-opacity:1;border-color:rgba(var(--color-accent),var(--tw-border-opacity))}.focus\:outline-none:focus{outline-offset:2px;outline:2px solid #0000}.focus-visible\:no-underline:focus-visible{text-decoration-line:none}.focus-visible\:underline-offset-0:focus-visible{text-underline-offset:0px}.group:hover .group-hover\:inline-block{display:inline-block}.prose-img\:border-0 :where(img):not(:where([class~=not-prose],[class~=not-prose] *)){border-width:0}@media (min-width:640px){.sm\:static{position:static}.sm\:my-0{margin-top:0;margin-bottom:0}.sm\:my-8{margin-top:2rem;margin-bottom:2rem}.sm\:mb-3{margin-bottom:.75rem}.sm\:ml-0{margin-left:0}.sm\:ml-2{margin-left:.5rem}.sm\:mt-0{margin-top:0}.sm\:inline{display:inline}.sm\:flex{display:flex}.sm\:hidden{display:none}.sm\:w-1\/2{width:50%}.sm\:w-auto{width:auto}.sm\:scale-100{--tw-scale-x:1;--tw-scale-y:1;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.sm\:flex-row{flex-direction:row}.sm\:flex-row-reverse{flex-direction:row-reverse}.sm\:items-end{align-items:flex-end}.sm\:items-center{align-items:center}.sm\:justify-end{justify-content:flex-end}.sm\:gap-4{gap:1rem}.sm\:gap-x-5{-moz-column-gap:1.25rem;column-gap:1.25rem}.sm\:space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem*var(--tw-space-x-reverse));margin-left:calc(1rem*calc(1 - var(--tw-space-x-reverse)))}.sm\:p-1{padding:.25rem}.sm\:px-2{padding-left:.5rem;padding-right:.5rem}.sm\:text-3xl{font-size:1.875rem;line-height:2.25rem}}.astro-route-announcer{clip:rect(0 0 0 0);clip-path:inset(50%);white-space:nowrap;width:1px;height:1px;position:absolute;top:0;left:0;overflow:hidden}#skip-to-content:where(.astro-3ef6ksr2){z-index:50;--tw-bg-opacity:1;background-color:rgba(var(--color-accent),var(--tw-bg-opacity));--tw-text-opacity:1;color:rgba(var(--color-fill),var(--tw-text-opacity));padding:.5rem .75rem;transition-property:all;transition-duration:.15s;transition-timing-function:cubic-bezier(.4,0,.2,1);position:absolute;top:-100%;left:4rem}#skip-to-content:where(.astro-3ef6ksr2):focus{top:1rem}.nav-container:where(.astro-3ef6ksr2){flex-direction:column;justify-content:space-between;align-items:center;max-width:48rem;margin-left:auto;margin-right:auto;display:flex}@media (min-width:640px){.nav-container:where(.astro-3ef6ksr2){flex-direction:row}}.top-nav-wrap:where(.astro-3ef6ksr2){justify-content:space-between;align-items:flex-start;width:100%;padding:1rem;display:flex;position:relative}@media (min-width:640px){.top-nav-wrap:where(.astro-3ef6ksr2){align-items:center;padding-top:2rem;padding-bottom:2rem}}.logo:where(.astro-3ef6ksr2){padding-top:.25rem;padding-bottom:.25rem;font-size:1.25rem;font-weight:600;line-height:1.75rem;position:absolute}@media (min-width:640px){.logo:where(.astro-3ef6ksr2){font-size:1.5rem;line-height:2rem;position:static}}.hamburger-menu:where(.astro-3ef6ksr2){align-self:flex-end;padding:.5rem}@media (min-width:640px){.hamburger-menu:where(.astro-3ef6ksr2){display:none}}.hamburger-menu:where(.astro-3ef6ksr2) svg:where(.astro-3ef6ksr2){--tw-scale-x:1.25;--tw-scale-y:1.25;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y));fill:rgb(var(--color-text-base));width:1.5rem;height:1.5rem}nav:where(.astro-3ef6ksr2){flex-direction:column;align-items:center;width:100%;display:flex}@media (min-width:640px){nav:where(.astro-3ef6ksr2){flex-direction:row;justify-content:flex-end;margin-left:.5rem}nav:where(.astro-3ef6ksr2)>:not([hidden]):where(.astro-3ef6ksr2)~:not([hidden]):where(.astro-3ef6ksr2){--tw-space-x-reverse:0;margin-right:calc(1rem*var(--tw-space-x-reverse));margin-left:calc(1rem*calc(1 - var(--tw-space-x-reverse)))}nav:where(.astro-3ef6ksr2){padding-top:0;padding-bottom:0}}nav:where(.astro-3ef6ksr2) ul:where(.astro-3ef6ksr2){-moz-column-gap:.5rem;grid-template-rows:repeat(4,minmax(0,1fr));grid-template-columns:repeat(2,minmax(0,1fr));gap:.5rem;width:11rem;margin-top:1rem;display:grid}@media (min-width:640px){nav:where(.astro-3ef6ksr2) ul:where(.astro-3ef6ksr2){-moz-column-gap:1.25rem;gap:0 1.25rem;width:auto;margin-top:0;margin-left:0}}nav:where(.astro-3ef6ksr2) ul:where(.astro-3ef6ksr2) li:where(.astro-3ef6ksr2){grid-column:span 2/span 2;justify-content:center;align-items:center;display:flex}nav:where(.astro-3ef6ksr2) ul:where(.astro-3ef6ksr2) li:where(.astro-3ef6ksr2) a:where(.astro-3ef6ksr2){text-align:center;width:100%;padding:.75rem 1rem;font-weight:500}nav:where(.astro-3ef6ksr2) ul:where(.astro-3ef6ksr2) li:where(.astro-3ef6ksr2) a:where(.astro-3ef6ksr2):hover{--tw-text-opacity:1;color:rgba(var(--color-accent),var(--tw-text-opacity))}@media (min-width:640px){nav:where(.astro-3ef6ksr2) ul:where(.astro-3ef6ksr2) li:where(.astro-3ef6ksr2) a:where(.astro-3ef6ksr2){margin-top:0;margin-bottom:0;padding:.25rem .5rem}}nav:where(.astro-3ef6ksr2) ul:where(.astro-3ef6ksr2) li:where(.astro-3ef6ksr2):nth-last-child(2) a:where(.astro-3ef6ksr2){width:auto}nav:where(.astro-3ef6ksr2) ul:where(.astro-3ef6ksr2) li:where(.astro-3ef6ksr2):last-child,nav:where(.astro-3ef6ksr2) ul:where(.astro-3ef6ksr2) li:where(.astro-3ef6ksr2):nth-last-child(2){grid-column:span 1/span 1}nav:where(.astro-3ef6ksr2) a:where(.astro-3ef6ksr2).active{text-underline-offset:4px;text-decoration-line:underline;text-decoration-style:wavy;text-decoration-thickness:2px}nav:where(.astro-3ef6ksr2) a:where(.astro-3ef6ksr2).active svg:where(.astro-3ef6ksr2){fill:rgb(var(--color-accent))}nav:where(.astro-3ef6ksr2) button:where(.astro-3ef6ksr2){padding:.25rem}nav:where(.astro-3ef6ksr2) button:where(.astro-3ef6ksr2) svg:where(.astro-3ef6ksr2){fill:rgb(var(--color-text-base));width:1.5rem;height:1.5rem}nav:where(.astro-3ef6ksr2) button:where(.astro-3ef6ksr2) svg:where(.astro-3ef6ksr2):hover{fill:rgb(var(--color-accent))}#theme-btn:where(.astro-3ef6ksr2){padding:.75rem}@media (min-width:640px){#theme-btn:where(.astro-3ef6ksr2){padding:.25rem}}#theme-btn:where(.astro-3ef6ksr2) svg:where(.astro-3ef6ksr2){--tw-scale-x:1.25;--tw-scale-y:1.25;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}#theme-btn:where(.astro-3ef6ksr2) svg:where(.astro-3ef6ksr2):hover{--tw-rotate:12deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}@media (min-width:640px){#theme-btn:where(.astro-3ef6ksr2) svg:where(.astro-3ef6ksr2){--tw-scale-x:1;--tw-scale-y:1;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}}.menu-icon:where(.astro-3ef6ksr2) line:where(.astro-3ef6ksr2){transition-property:opacity;transition-duration:75ms;transition-timing-function:cubic-bezier(.4,0,.2,1)}.menu-icon:where(.astro-3ef6ksr2) .close:where(.astro-3ef6ksr2),.menu-icon:where(.astro-3ef6ksr2).is-active .line:where(.astro-3ef6ksr2){opacity:0}.menu-icon:where(.astro-3ef6ksr2).is-active .close:where(.astro-3ef6ksr2){opacity:1}.social-icons:where(.astro-upu6fzxr){flex-wrap:wrap;justify-content:center;gap:.25rem}.link-button:where(.astro-upu6fzxr){padding:.5rem}.link-button:where(.astro-upu6fzxr):hover{--tw-rotate:6deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}@media (min-width:640px){.link-button:where(.astro-upu6fzxr){padding:.25rem}}footer:where(.astro-sz7xmlte){width:100%}.footer-wrapper:where(.astro-sz7xmlte){flex-direction:column;justify-content:space-between;align-items:center;padding-top:1.5rem;padding-bottom:1.5rem;display:flex}@media (min-width:640px){.footer-wrapper:where(.astro-sz7xmlte){flex-direction:row-reverse;padding-top:1rem;padding-bottom:1rem}}.link-button:where(.astro-sz7xmlte){margin-top:.25rem;margin-bottom:.25rem;padding:.5rem}.link-button:where(.astro-sz7xmlte):hover{--tw-rotate:6deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.link-button:where(.astro-sz7xmlte) svg:where(.astro-sz7xmlte){--tw-scale-x:1.25;--tw-scale-y:1.25;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}.copyright-wrapper:where(.astro-sz7xmlte){white-space:nowrap;flex-direction:column;align-items:center;margin-top:.5rem;margin-bottom:.5rem;display:flex}@media (min-width:640px){.copyright-wrapper:where(.astro-sz7xmlte){flex-direction:row}}.separator:where(.astro-sz7xmlte){display:none}@media (min-width:640px){.separator:where(.astro-sz7xmlte){display:inline}}#main-content:where(.astro-hsp6otuf){width:100%;max-width:48rem;margin-left:auto;margin-right:auto;padding-bottom:1rem;padding-left:1rem;padding-right:1rem}#main-content:where(.astro-hsp6otuf) h1:where(.astro-hsp6otuf){font-size:1.5rem;font-weight:600;line-height:2rem}@media (min-width:640px){#main-content:where(.astro-hsp6otuf) h1:where(.astro-hsp6otuf){font-size:1.875rem;line-height:2.25rem}}#main-content:where(.astro-hsp6otuf) p:where(.astro-hsp6otuf){margin-top:.5rem;margin-bottom:1.5rem;font-style:italic}.breadcrumb:where(.astro-ilhxcym7){width:100%;max-width:48rem;margin:2rem auto .25rem;padding-left:1rem;padding-right:1rem}.breadcrumb:where(.astro-ilhxcym7) ul:where(.astro-ilhxcym7) li:where(.astro-ilhxcym7){display:inline}.breadcrumb:where(.astro-ilhxcym7) ul:where(.astro-ilhxcym7) li:where(.astro-ilhxcym7) a:where(.astro-ilhxcym7){text-transform:capitalize;opacity:.7}.breadcrumb:where(.astro-ilhxcym7) ul:where(.astro-ilhxcym7) li:where(.astro-ilhxcym7) span:where(.astro-ilhxcym7){opacity:.7}.breadcrumb:where(.astro-ilhxcym7) ul:where(.astro-ilhxcym7) li:where(.astro-ilhxcym7):not(:last-child) a:where(.astro-ilhxcym7):hover{opacity:1}a:where(.astro-blwjyjpt){text-decoration-line:underline;text-decoration-style:dashed;position:relative}a:where(.astro-blwjyjpt):hover{--tw-text-opacity:1;color:rgba(var(--color-accent),var(--tw-text-opacity));top:-.125rem}a:where(.astro-blwjyjpt):focus-visible{padding:.25rem}a:where(.astro-blwjyjpt) svg:where(.astro-blwjyjpt){--tw-scale-x:.95;--tw-scale-y:.95;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y));--tw-text-opacity:1;color:rgba(var(--color-text-base),var(--tw-text-opacity));opacity:.8;width:1.5rem;height:1.5rem;margin-right:-1.25rem}.group:where(.astro-blwjyjpt):hover a:where(.astro-blwjyjpt) svg:where(.astro-blwjyjpt){fill:rgb(var(--color-accent))}@keyframes astroFadeInOut{0%{opacity:1}to{opacity:0}}@keyframes astroFadeIn{0%{opacity:0}}@keyframes astroFadeOut{to{opacity:0}}@keyframes astroSlideFromRight{0%{transform:translate(100%)}}@keyframes astroSlideFromLeft{0%{transform:translate(-100%)}}@keyframes astroSlideToRight{to{transform:translate(100%)}}@keyframes astroSlideToLeft{to{transform:translate(-100%)}}@media (prefers-reduced-motion){::view-transition-group(*){animation:none!important}::view-transition-old(*){animation:none!important}::view-transition-new(*){animation:none!important}[data-astro-transition-scope]{animation:none!important}}.pagination-wrapper:where(.astro-d776pwuy){justify-content:center;margin-top:auto;margin-bottom:2rem;display:flex}.disabled:where(.astro-d776pwuy){pointer-events:none;-webkit-user-select:none;user-select:none;opacity:.5}.disabled:where(.astro-d776pwuy):hover{--tw-text-opacity:1;color:rgba(var(--color-text-base),var(--tw-text-opacity))}.group:where(.astro-d776pwuy):hover .disabled:where(.astro-d776pwuy){fill:rgb(var(--color-text-base))}.group:where(.astro-d776pwuy):hover .disabled-svg:where(.astro-d776pwuy){fill:rgb(var(--color-text-base))!important}.social-icons:where(.astro-wkojbtzc){flex-flow:column wrap;justify-content:center;align-items:center;gap:.25rem;display:flex}@media (min-width:640px){.social-icons:where(.astro-wkojbtzc){align-items:flex-start}}.link-button:where(.astro-wkojbtzc){--tw-scale-x:.9;--tw-scale-y:.9;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y));padding:.5rem}.link-button:where(.astro-wkojbtzc):hover{--tw-rotate:6deg;transform:translate(var(--tw-translate-x),var(--tw-translate-y))rotate(var(--tw-rotate))skew(var(--tw-skew-x))skewY(var(--tw-skew-y))scaleX(var(--tw-scale-x))scaleY(var(--tw-scale-y))}@media (min-width:640px){.link-button:where(.astro-wkojbtzc){padding:.25rem}}main:where(.astro-vj4tpspi){width:100%;max-width:48rem;margin-left:auto;margin-right:auto;padding-bottom:3rem;padding-left:1rem;padding-right:1rem}.post-title:where(.astro-vj4tpspi){--tw-text-opacity:1;color:rgba(var(--color-accent),var(--tw-text-opacity));font-size:1.5rem;font-weight:600;line-height:2rem}</style><script type="module" src="/astro/static/hoisted.sO-65EBM.js"></script><style>[data-astro-transition-scope=astro-plk3gbjq-1]{view-transition-name:feign--openfeign}@layer astro{::view-transition-old(feign--openfeign){animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}::view-transition-new(feign--openfeign){animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back]::view-transition-old(feign--openfeign){animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back]::view-transition-new(feign--openfeign){animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}}[data-astro-transition-fallback=old] [data-astro-transition-scope=astro-plk3gbjq-1],[data-astro-transition-fallback=old][data-astro-transition-scope=astro-plk3gbjq-1]{animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition-fallback=new] [data-astro-transition-scope=astro-plk3gbjq-1],[data-astro-transition-fallback=new][data-astro-transition-scope=astro-plk3gbjq-1]{animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back][data-astro-transition-fallback=old] [data-astro-transition-scope=astro-plk3gbjq-1],[data-astro-transition=back][data-astro-transition-fallback=old][data-astro-transition-scope=astro-plk3gbjq-1]{animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back][data-astro-transition-fallback=new] [data-astro-transition-scope=astro-plk3gbjq-1],[data-astro-transition=back][data-astro-transition-fallback=new][data-astro-transition-scope=astro-plk3gbjq-1]{animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}</style><style>[data-astro-transition-scope=astro-36ssibgs-2]{view-transition-name:java}@layer astro{::view-transition-old(java){animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}::view-transition-new(java){animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back]::view-transition-old(java){animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back]::view-transition-new(java){animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}}[data-astro-transition-fallback=old] [data-astro-transition-scope=astro-36ssibgs-2],[data-astro-transition-fallback=old][data-astro-transition-scope=astro-36ssibgs-2]{animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition-fallback=new] [data-astro-transition-scope=astro-36ssibgs-2],[data-astro-transition-fallback=new][data-astro-transition-scope=astro-36ssibgs-2]{animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back][data-astro-transition-fallback=old] [data-astro-transition-scope=astro-36ssibgs-2],[data-astro-transition=back][data-astro-transition-fallback=old][data-astro-transition-scope=astro-36ssibgs-2]{animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back][data-astro-transition-fallback=new] [data-astro-transition-scope=astro-36ssibgs-2],[data-astro-transition=back][data-astro-transition-fallback=new][data-astro-transition-scope=astro-36ssibgs-2]{animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}</style><style>[data-astro-transition-scope=astro-36ssibgs-3]{view-transition-name:feign}@layer astro{::view-transition-old(feign){animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}::view-transition-new(feign){animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back]::view-transition-old(feign){animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back]::view-transition-new(feign){animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}}[data-astro-transition-fallback=old] [data-astro-transition-scope=astro-36ssibgs-3],[data-astro-transition-fallback=old][data-astro-transition-scope=astro-36ssibgs-3]{animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition-fallback=new] [data-astro-transition-scope=astro-36ssibgs-3],[data-astro-transition-fallback=new][data-astro-transition-scope=astro-36ssibgs-3]{animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back][data-astro-transition-fallback=old] [data-astro-transition-scope=astro-36ssibgs-3],[data-astro-transition=back][data-astro-transition-fallback=old][data-astro-transition-scope=astro-36ssibgs-3]{animation-name:astroFadeOut;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}[data-astro-transition=back][data-astro-transition-fallback=new] [data-astro-transition-scope=astro-36ssibgs-3],[data-astro-transition=back][data-astro-transition-fallback=new][data-astro-transition-scope=astro-36ssibgs-3]{animation-name:astroFadeIn;animation-duration:.18s;animation-timing-function:cubic-bezier(.76,0,.24,1);animation-fill-mode:both}</style></head> <body>  <header class="astro-3ef6ksr2"> <a id="skip-to-content" href="#main-content" class="astro-3ef6ksr2">Skip to content</a> <div class="astro-3ef6ksr2 nav-container"> <div class="astro-3ef6ksr2 top-nav-wrap"> <a href="/astro" class="astro-3ef6ksr2 logo whitespace-nowrap"> 知道的越多，才知知道的越少 </a> <nav id="nav-menu" class="astro-3ef6ksr2"> <button class="astro-3ef6ksr2 focus-outline hamburger-menu" aria-label="Open Menu" aria-expanded="false" aria-controls="menu-items"> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="astro-3ef6ksr2 menu-icon"> <line x1="7" y1="12" x2="21" y2="12" class="line astro-3ef6ksr2"></line> <line x1="3" y1="6" x2="21" y2="6" class="line astro-3ef6ksr2"></line> <line x1="12" y1="18" x2="21" y2="18" class="line astro-3ef6ksr2"></line> <line x1="18" y1="6" x2="6" y2="18" class="astro-3ef6ksr2 close"></line> <line x1="6" y1="6" x2="18" y2="18" class="astro-3ef6ksr2 close"></line> </svg> </button> <ul id="menu-items" class="astro-3ef6ksr2 display-none sm:flex"> <li class="astro-3ef6ksr2"> <a href="/astro/posts/" class="astro-3ef6ksr2">
Posts
</a> </li> <li class="astro-3ef6ksr2"> <a href="/astro/tags/" class="astro-3ef6ksr2">
Tags
</a> </li> <!-- <li>
            <a href="/about/" class={activeNav === "about" ? "active" : ""}>
              About
            </a>
          </li> --> <li class="astro-3ef6ksr2"> <a href="/astro/search/" class="astro-3ef6ksr2 focus-outline flex group hover:text-skin-accent inline-block p-3 sm:p-1" aria-label="search" title="Search"> <svg xmlns="http://www.w3.org/2000/svg" class="astro-3ef6ksr2 scale-125 sm:scale-100"><path d="M19.023 16.977a35.13 35.13 0 0 1-1.367-1.384c-.372-.378-.596-.653-.596-.653l-2.8-1.337A6.962 6.962 0 0 0 16 9c0-3.859-3.14-7-7-7S2 5.141 2 9s3.14 7 7 7c1.763 0 3.37-.66 4.603-1.739l1.337 2.8s.275.224.653.596c.387.363.896.854 1.384 1.367l1.358 1.392.604.646 2.121-2.121-.646-.604c-.379-.372-.885-.866-1.391-1.36zM9 14c-2.757 0-5-2.243-5-5s2.243-5 5-5 5 2.243 5 5-2.243 5-5 5z" class="astro-3ef6ksr2"></path> </svg> <span class="astro-3ef6ksr2 sr-only">Search</span> </a> </li>  </ul> </nav> </div> </div> <div class="max-w-3xl mx-auto px-4"> <hr class="border-skin-line" aria-hidden="true"> </div> </header>   <div class="astro-vj4tpspi flex justify-start max-w-3xl mx-auto px-2 w-full"> <button class="astro-vj4tpspi flex focus-outline hover:opacity-75 mb-2 mt-8" onclick='history.length===1?window.location="/":history.back();
'> <svg xmlns="http://www.w3.org/2000/svg" class="astro-vj4tpspi"><path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class="astro-vj4tpspi"></path> </svg><span class="astro-vj4tpspi">Go back</span> </button> </div> <main id="main-content" class="astro-vj4tpspi"> <h1 class="astro-vj4tpspi post-title" data-astro-transition-scope="astro-plk3gbjq-1">Feign &amp; openFeign</h1> <div class="astro-vj4tpspi flex items-center my-2 opacity-80 space-x-2"><svg xmlns="http://www.w3.org/2000/svg" class="inline-block fill-skin-base h-6 min-w-[1.375rem] scale-100 w-6" aria-hidden="true"><path d="M7 11h2v2H7zm0 4h2v2H7zm4-4h2v2h-2zm0 4h2v2h-2zm4-4h2v2h-2zm0 4h2v2h-2z"></path><path d="M5 22h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2zM19 8l.001 12H5V8h14z"></path></svg><span class="italic text-base">Updated:</span><span class="italic text-base"><time datetime="2024-05-16T14:00:40.000Z">May 16, 2024</time><span aria-hidden="true"> | </span><span class="sr-only">&nbsp;at&nbsp;</span><span class="text-nowrap">02:00 PM</span></span></div> <article id="article" role="article" class="astro-vj4tpspi max-w-3xl mx-auto mt-8 prose"> <h2 id="table-of-contents">Table of contents</h2>
<p></p><details><summary>Open Table of contents</summary><p></p>
<ul>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFfeign">什么是Feign</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AFopenfeign">什么是openFeign</a></li>
<li><a href="#feign%E4%B8%8Eopenfeign%E7%9A%84%E5%AF%B9%E6%AF%94">Feign与OpenFeign的对比</a></li>
<li><a href="#openfeign%E4%BD%BF%E7%94%A8">openFeign使用</a></li>
<li><a href="#openfeign%E8%B6%85%E6%97%B6%E5%A4%84%E7%90%86">OpenFeign超时处理</a></li>
<li><a href="#openfeign%E6%97%A5%E5%BF%97%E5%A2%9E%E5%BC%BA">OpenFeign日志增强</a></li>
<li><a href="#openfeign-%E5%AE%9E%E7%8E%B0-requestinterceptor">OpenFeign 实现 RequestInterceptor</a>
<ul>
<li><a href="#requestinterceptor-%E5%AE%9E%E7%8E%B0%E7%B1%BB">RequestInterceptor 实现类</a></li>
<li><a href="#%E4%BD%BF-requestinterceptor-%E7%94%9F%E6%95%88">使 RequestInterceptor 生效</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E5%A2%9E%E5%8A%A0%E6%8B%A6%E6%88%AA%E5%99%A8%E7%94%A8%E4%BA%8E%E8%8E%B7%E5%8F%96%E8%AF%B7%E6%B1%82%E5%A4%B4%E4%B8%AD%E7%9A%84%E6%95%B0%E6%8D%AE">服务提供者增加拦截器（用于获取请求头中的数据）</a></li>
<li><a href="#%E7%BB%93%E5%90%88-hystrix-%E9%99%90%E6%B5%81%E4%BD%BF%E7%94%A8%E7%9A%84%E5%9D%91">结合 Hystrix 限流使用的坑</a>
<ul>
<li><a href="#%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90">原因分析</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">解决方案</a></li>
<li><a href="#hystrix-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%92%8C%E4%BF%A1%E5%8F%B7%E9%87%8F%E9%9A%94%E7%A6%BB%E5%8C%BA%E5%88%AB">hystrix 线程池和信号量隔离区别</a></li>
<li><a href="#%E7%BA%BF%E7%A8%8B%E5%92%8C%E4%BF%A1%E5%8F%B7%E9%87%8F%E9%9A%94%E7%A6%BB%E7%9A%84%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">线程和信号量隔离的使用场景</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#openfeign-%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6">openfeign 核心组件</a></li>
<li><a href="#openfeign-%E5%A6%82%E4%BD%95%E6%89%AB%E6%8F%8F%E6%89%80%E6%9C%89-feignclient%E5%9F%BA%E4%BA%8E%E4%BD%8E%E7%89%88%E6%9C%AC-springcloud-20200x%E7%89%88%E6%9C%AC%E4%B9%8B%E5%89%8D">openfeign 如何扫描所有 FeignClient（基于低版本 SpringCloud 2020.0.x版本之前）</a>
<ul>
<li><a href="#feignclient%E8%A7%A3%E6%9E%90">@FeignClient解析</a>
<ul>
<li><a href="#feignclient%E6%B3%A8%E8%A7%A3%E8%A7%A3%E9%87%8A">@FeignClient注解解释</a></li>
<li><a href="#feignclient-%E6%B3%A8%E8%A7%A3%E4%BD%9C%E7%94%A8">@FeignClient 注解作用</a>
<ul>
<li><a href="#%E4%BD%BF%E7%94%A8-ribbonclient-%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5">使用 @RibbonClient 自定义负载均衡策略</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#enablefeignclients-%E8%A7%A3%E6%9E%90">@EnableFeignClients 解析</a>
<ul>
<li><a href="#feignclientsregistrar-%E7%B1%BB">FeignClientsRegistrar 类</a>
<ul>
<li><a href="#%E6%B3%A8%E5%86%8C%E9%BB%98%E8%AE%A4%E9%85%8D%E7%BD%AE">注册默认配置</a></li>
<li><a href="#%E6%B3%A8%E5%86%8C%E6%89%80%E6%9C%89%E7%9A%84-feignclient">注册所有的 FeignClient</a></li>
<li><a href="#%E8%8E%B7%E5%8F%96%E5%8C%85%E6%89%AB%E6%8F%8F%E8%B7%AF%E5%BE%84">获取包扫描路径</a></li>
<li><a href="#%E6%89%AB%E6%8F%8F%E6%89%80%E6%9C%89%E7%9A%84-feignclient">扫描所有的 FeignClient</a></li>
<li><a href="#%E6%B3%A8%E5%86%8Cfeignclient">注册FeignClient</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#feignclient-%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%B1%BB">FeignClient 的动态代理类</a>
<ul>
<li><a href="#feignclientfactorybean-%E5%88%9B%E5%BB%BA%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%B1%BB%E7%9A%84%E5%85%A5%E5%8F%A3">FeignClientFactoryBean 创建动态代理类的入口</a></li>
<li><a href="#feignbuilder%E7%9A%84%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B">Feign.Builder的构建过程</a>
<ul>
<li><a href="#feigncontext-%E4%B8%8A%E4%B8%8B%E6%96%87%E7%9A%84%E8%8E%B7%E5%8F%96">FeignContext 上下文的获取</a></li>
<li><a href="#%E4%BB%8E-feignclient-%E4%B8%AD%E8%8E%B7%E5%8F%96-feignbuilder">从 FeignClient 中获取 Feign.Builder</a></li>
<li><a href="#%E5%A4%84%E7%90%86%E9%85%8D%E7%BD%AE%E4%BF%A1%E6%81%AF">处理配置信息</a></li>
<li><a href="#%E4%BD%BF%E7%94%A8-feignbuilder-%E6%9E%84%E5%BB%BA%E5%87%BA%E4%B8%80%E4%B8%AA-feignclient">使用 Feign.Builder 构建出一个 FeignClient</a>
<ul>
<li><a href="#loadbalancerfeignclient-%E5%9C%A8%E5%93%AA%E9%87%8C%E6%B3%A8%E5%85%A5%E5%88%B0-spring-%E5%AE%B9%E5%99%A8">LoadBalancerFeignClient 在哪里注入到 Spring 容器</a></li>
<li><a href="#hystrixtargeter-%E5%9C%A8%E5%93%AA%E9%87%8C%E6%B3%A8%E5%85%A5%E5%88%B0-spring-%E5%AE%B9%E5%99%A8">HystrixTargeter 在哪里注入到 Spring 容器</a></li>
<li><a href="#hystrixtargetertarget%E6%96%B9%E6%B3%95">HystrixTargeter#target()方法</a></li>
<li><a href="#reflectivefeignnewinstance%E7%94%9F%E6%88%90%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%B1%BB">ReflectiveFeign#newInstance()生成动态代理类</a></li>
<li><a href="#parsehandlersbynameapply%E8%A7%A3%E6%9E%90feignclient%E4%B8%AD%E7%9A%84%E6%96%B9%E6%B3%95">ParseHandlersByName#apply()解析FeignClient中的方法</a></li>
<li><a href="#springmvccontract%E7%BB%84%E4%BB%B6%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86">SpringMvcContract组件的工作原理</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#openfeign%E5%A4%84%E7%90%86http%E8%AF%B7%E6%B1%82">OpenFeign处理HTTP请求</a>
<ul>
<li><a href="#%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E7%9A%84%E5%85%A5%E5%8F%A3">动态代理处理请求的入口</a></li>
<li><a href="#synchronousmethodhandler-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E6%9C%BA%E5%88%B6">SynchronousMethodHandler 处理请求机制</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E8%AF%B7%E6%B1%82%E6%A8%A1%E7%89%88springmvccontract-%E8%A7%A3%E6%9E%90%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0">创建请求模版（SpringMvcContract 解析方法参数）</a></li>
<li><a href="#%E6%89%A7%E8%A1%8C%E8%AF%B7%E6%B1%82%E5%B9%B6%E8%A7%A3%E7%A0%81%E8%BF%94%E5%9B%9E%E5%80%BC">执行请求并解码返回值</a>
<ul>
<li><a href="#%E5%BA%94%E7%94%A8%E6%89%80%E6%9C%89%E7%9A%84-requestinterceptor">应用所有的 RequestInterceptor</a></li>
<li><a href="#loadbalancerfeignclient-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%89%A7%E8%A1%8C%E8%AF%B7%E6%B1%82%E8%AF%A6%E8%BF%B0">LoadBalancerFeignClient 负载均衡执行请求详述</a></li>
<li><a href="#%E6%8C%87%E5%AE%9Adecoder%E6%97%B6%E5%AF%B9%E8%AF%B7%E6%B1%82%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C%E8%A7%A3%E7%A0%81">指定Decoder时对请求返回结果解码</a></li>
<li><a href="#%E9%BB%98%E8%AE%A4%E6%83%85%E5%86%B5%E4%B8%8Bfeign%E6%8E%A5%E6%94%B6%E5%88%B0%E6%9C%8D%E5%8A%A1%E8%BF%94%E5%9B%9E%E7%9A%84%E7%BB%93%E6%9E%9C%E5%90%8E%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86">默认情况下，Feign接收到服务返回的结果后，如何处理？</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#openfeign%E6%96%B0%E7%89%88%E6%9C%AC%E5%92%8C%E6%97%A7%E7%89%88%E6%9C%AC%E4%B9%8B%E9%97%B4%E7%9A%84%E5%B7%AE%E5%BC%82%E9%AB%98%E7%89%88%E6%9C%ACopenfeign%E5%BA%95%E5%B1%82%E4%B8%8D%E4%BD%BF%E7%94%A8ribbon%E5%81%9A%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">OpenFeign新版本和旧版本之间的差异（高版本OpenFeign底层不使用Ribbon做负载均衡）</a>
<ul>
<li><a href="#feignclientsregistrar%E5%BC%80%E5%90%AF%E5%AF%B9feignclient%E7%9A%84%E6%89%AB%E6%8F%8F">@FeignClientsRegistrar开启对FeignClient的扫描</a></li>
<li><a href="#%E4%B8%BAfeignclient%E7%94%9F%E6%88%90%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%B1%BB">为FeignClient生成动态代理类</a></li>
<li><a href="#client%E5%A4%84%E7%90%86%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%A0%B8%E5%BF%83%E5%8C%BA%E5%88%AB">Client处理负载均衡（核心区别）</a></li>
</ul>
</li>
</ul>
<p></p></details><p></p>
<h2 id="什么是feign">什么是Feign</h2>
<p>Netflix Feign 是 Netflix 公司发布的一种实现负载均衡和服务调用的开源组件。Spring Cloud 将其与 Netflix 中的其他开源服务组件（例如 Eureka、Ribbon 以及 Hystrix 等）一起整合进 Spring Cloud Netflix 模块中，整合后全称为 Spring Cloud Netflix Feign Feign 对 <a href="http://c.biancheng.net/springcloud/ribbon.html">Ribbon</a>进行了集成，利用 Ribbon 维护了一份可用服务清单，并通过 Ribbon 实现了客户端的负载均衡。Feign 是一种声明式服务调用组件，它在 RestTemplate 的基础上做了进一步的封装。通过 Feign，我们只需要声明一个接口并通过注解进行简单的配置（类似于 Dao 接口上面的 Mapper 注解一样）即可实现对 HTTP 接口的绑定。通过 Feign，我们可以像调用本地方法一样来调用远程服务，而完全感觉不到这是在进行远程调用。Feign 支持多种注解，例如 Feign 自带的注解以及 JAX-RS 注解等，但遗憾的是 Feign 本身并不支持 Spring MVC 注解，这无疑会给广大 Spring 用户带来不便。</p>
<h2 id="什么是openfeign">什么是openFeign</h2>
<p>2019 年 Netflix 公司宣布 Feign 组件正式进入停更维护状态，于是 Spring 官方便推出了一个名为 OpenFeign 的组件作为 Feign 的替代方案。</p>
<p>OpenFeign 全称 Spring Cloud OpenFeign，它是 Spring 官方推出的一种声明式服务调用与负载均衡组件，它的出现就是为了替代进入停更维护状态的 Feign。OpenFeign 是 Spring Cloud 对 Feign 的二次封装，它具有 Feign 的所有功能，并在 Feign 的基础上增加了对 Spring MVC 注解的支持，例如 @RequestMapping、@GetMapping 和 @PostMapping 等。</p>
<p>常用注解</p>





























<table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@FeignClient</td><td>该注解用于通知 OpenFeign 组件对 @RequestMapping 注解下的接口进行解析，并通过动态代理的方式产生实现类，实现负载均衡和服务调用。</td></tr><tr><td>EnableFeignClients</td><td>该注解用于开启 OpenFeign 功能，当 Spring Cloud 应用启动时，OpenFeign 会扫描标有 @FeignClient 注解的接口，生成代理并注册到 Spring 容器中。</td></tr><tr><td>@RequestMapping</td><td>Spring MVC 注解，在 Spring MVC 中使用该注解映射请求，通过它来指定控制器（Controller）可以处理哪些 URL 请求，相当于 Servlet 中 web.xml 的配置。</td></tr><tr><td>@GetMapping</td><td>Spring MVC 注解，用来映射 GET 请求，它是一个组合注解，相当于 @RequestMapping(method = RequestMethod.GET) 。</td></tr><tr><td>@PostMapping</td><td>Spring MVC 注解，用来映射 POST 请求，它是一个组合注解，相当于 @RequestMapping(method = RequestMethod.POST) 。</td></tr></tbody></table>
<h2 id="feign与openfeign的对比">Feign与OpenFeign的对比</h2>
<p><strong>相同点：</strong></p>
<ul>
<li>Feign 和 OpenFeign 都是 Spring Cloud 下的远程调用和负载均衡组件。</li>
<li>Feign 和 OpenFeign 作用一样，都可以实现服务的远程调用和负载均衡。</li>
<li>Feign 和 OpenFeign 都对 Ribbon 进行了集成，都利用 Ribbon 维护了可用服务清单，并通过 Ribbon 实现了客户端的负载均衡。</li>
<li>Feign 和 OpenFeign 都是在服务消费者（客户端）定义服务绑定接口并通过注解的方式进行配置，以实现远程服务的调用。</li>
</ul>
<p><strong>不同点：</strong></p>
<ul>
<li>Feign 和 OpenFeign 的依赖项不同，Feign 的依赖为 spring-cloud-starter-feign，而 OpenFeign 的依赖为 spring-cloud-starter-openfeign。</li>
<li>Feign 和 OpenFeign 支持的注解不同，Feign 支持 Feign 注解和 JAX-RS 注解，但不支持 Spring MVC 注解；OpenFeign 除了支持 Feign 注解和 JAX-RS 注解外，还支持 Spring MVC 注解。</li>
</ul>
<h2 id="openfeign使用">openFeign使用</h2>
<p>引入依赖</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="xml"><code><span class="line"><span style="color:#7F848E;font-style:italic">&lt;!-- openfeign依赖 --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">      &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;org.springframework.cloud&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">      &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;spring-cloud-starter-openfeign&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">&lt;!-- openfeign优化请求连接池依赖 --&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">     &lt;</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;io.github.openfeign&lt;/</span><span style="color:#E06C75">groupId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">     &lt;</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;feign-httpclient&lt;/</span><span style="color:#E06C75">artifactId</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">dependency</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"></span></code></pre>
<p>定义远程调用接口</p>
<ul>
<li>在 @FeignClient 注解中，value 属性的取值为：服务提供者的服务名，即服务提供者配置文件（application.yml）中 spring.application.name 的取值。</li>
<li>接口中定义的每个方法都与服务提供者中 Controller 定义的服务方法对应。</li>
<li>openfeign本身并不具备fallback降级属性，需要搭配降级框架如（hystrix或sentinel）。如果未引入降级框架，即使声明fallback降级服务类，在远程调用发生异常时，也不会触发。</li>
</ul>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Component</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">FeignClient</span><span style="color:#E06C75">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "service5"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> FeignService</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">     @</span><span style="color:#E5C07B">GetMapping</span><span style="color:#E06C75">(</span><span style="color:#98C379">"/api/v1/service5"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#E5C07B">     List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Integer</span><span style="color:#ABB2BF">&gt;</span><span style="color:#61AFEF"> get</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<p>启动类添加注解@EnableFeignClients</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">EnableFeignClients</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">EnableEurekaClient</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">SpringBootApplication</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Service3Application</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">     public</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> main</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">[] </span><span style="color:#E06C75;font-style:italic">args</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        SpringApplication</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">run</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Service3Application</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, args);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<h2 id="openfeign超时处理">OpenFeign超时处理</h2>
<p>openFeign 客户端的默认超时时间为 1 秒钟，如果服务端处理请求的时间超过 1 秒就会报错。为了避免这样的情况，我们需要对 OpenFeign 客户端的超时时间进行控制。</p>
<p>yml 添加如下进行配置</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="yml"><code><span class="line"><span style="color:#E06C75">ribbon</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  ReadTimeout</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">6000</span><span style="color:#7F848E;font-style:italic"> #建立连接所用的时间，适用于网络状况正常的情况下，两端两端连接所用的时间</span></span>
<span class="line"><span style="color:#E06C75">  ConnectionTimeout</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">6000</span><span style="color:#7F848E;font-style:italic"> #建立连接后，服务器读取到可用资源的时间</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">feign</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  client</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    httpclient</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      enabled</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span><span style="color:#7F848E;font-style:italic"> # 开启 HttpClient优化连接池</span></span>
<span class="line"><span style="color:#E06C75">  compression</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    request</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      enabled</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span><span style="color:#7F848E;font-style:italic"> # 开启请求数据的压缩功能</span></span>
<span class="line"><span style="color:#E06C75">      mime-types</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">text/xml,application/xml, application/json</span><span style="color:#7F848E;font-style:italic"> # 压缩类型</span></span>
<span class="line"><span style="color:#E06C75">      min-request-size</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">1024</span><span style="color:#7F848E;font-style:italic"> # 最小压缩值标准，当数据大于 1024 才会进行压缩</span></span>
<span class="line"><span style="color:#E06C75">    response</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      enabled</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span><span style="color:#7F848E;font-style:italic"> # 开启响应数据压缩功能</span></span>
<span class="line"></span></code></pre>
<h2 id="openfeign日志增强">OpenFeign日志增强</h2>
<p>yml 添加日志级别声明</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="yml"><code><span class="line"><span style="color:#E06C75">logging</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  level</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    com.ftc.service3.FeignService</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">debug</span><span style="color:#7F848E;font-style:italic"> #feign日志以什么样的级别监控该接口</span></span>
<span class="line"></span></code></pre>
<p>说明：</p>
<ul>
<li>com.ftc.service3.FeignService 是开启 @FeignClient 注解的接口（即服务绑定接口）的完整类名。也可以只配置部分路径，表示监控该路径下的所有服务绑定接口</li>
<li>debug：表示监听该接口的日志级别。</li>
</ul>
<p>创建日志配置类</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> ConfigBean</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * OpenFeign 日志增强</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    * 配置 OpenFeign 记录哪些内容</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    */</span></span>
<span class="line"><span style="color:#ABB2BF">  @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#E5C07B">  Logger</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Level</span><span style="color:#61AFEF"> feginLoggerLevel</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#E5C07B"> Logger</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Level</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">FULL</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">  }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<p>该配置的作用是通过配置的 Logger.Level 对象告诉 OpenFeign 记录哪些日志内容。Logger.Level 的具体级别如下：</p>
<ul>
<li>NONE：不记录任何信息。</li>
<li>BASIC：仅记录请求方法、URL 以及响应状态码和执行时间。</li>
<li>HEADERS：除了记录 BASIC 级别的信息外，还会记录请求和响应的头信息。</li>
<li>FULL：记录所有请求与响应的明细，包括头信息、请求体、元数据等等。</li>
</ul>
<h2 id="openfeign-实现-requestinterceptor">OpenFeign 实现 RequestInterceptor</h2>
<p>在一些业务场景中，微服务间相互调用需要做鉴权，以保证我们服务的安全性。即：服务 A 调用服务 B 的时候需要将服务 B 的一些鉴权信息传递给服务 B，从而保证服务 B 的调用也可以通过鉴权，进而保证整个服务调用链的安全。</p>
<p>通过 RequestInterceptor 拦截器拦截 openfeign 服务请求，将上游服务的请求头或者请求体中的数据封装到我们的 openfeign 调用的请求模版中，从而实现上游数据的传递。</p>
<h3 id="requestinterceptor-实现类">RequestInterceptor 实现类</h3>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Slf4j</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyFeignRequestInterceptor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> RequestInterceptor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * 这里可以实现对请求的拦截，对请求添加一些额外信息之类的</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   *</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * </span><span style="color:#C678DD;font-style:italic">@param</span><span style="color:#E06C75;font-style:italic"> requestTemplate</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   */</span></span>
<span class="line"><span style="color:#ABB2BF">  @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">  public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> apply</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">RequestTemplate</span><span style="color:#E06C75;font-style:italic"> requestTemplate</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 1. obtain request</span></span>
<span class="line"><span style="color:#C678DD">    final</span><span style="color:#E5C07B"> ServletRequestAttributes</span><span style="color:#E06C75"> attributes</span><span style="color:#56B6C2"> =</span><span style="color:#ABB2BF"> (ServletRequestAttributes) </span><span style="color:#E5C07B">RequestContextHolder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRequestAttributes</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 2. 兼容hystrix限流后，获取不到ServletRequestAttributes的问题（使拦截器直接失效）</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Objects</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isNull</span><span style="color:#ABB2BF">(attributes)) {</span></span>
<span class="line"><span style="color:#E5C07B">      log</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">error</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"MyFeignRequestInterceptor is invalid!"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#E5C07B">    HttpServletRequest</span><span style="color:#E06C75"> request</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> attributes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRequest</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 2. obtain request headers，and put it into openFeign RequestTemplate</span></span>
<span class="line"><span style="color:#E5C07B">    Enumeration</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">headerNames</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> request</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getHeaderNames</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">Objects</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nonNull</span><span style="color:#ABB2BF">(headerNames)) {</span></span>
<span class="line"><span style="color:#C678DD">      while</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">headerNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasMoreElements</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> name</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> headerNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nextElement</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> value</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> request</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getHeader</span><span style="color:#ABB2BF">(name);</span></span>
<span class="line"><span style="color:#E5C07B">        requestTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">header</span><span style="color:#ABB2BF">(name, value);</span></span>
<span class="line"><span style="color:#ABB2BF">      }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // todo 需要传递请求参数时放开</span></span>
<span class="line"><span style="color:#D19A66">    3.</span><span style="color:#ABB2BF"> obtain request body, and put it into openFeign </span><span style="color:#E5C07B">RequestTemplate</span></span>
<span class="line"><span style="color:#E5C07B">    Enumeration</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt; </span><span style="color:#E06C75">bodyNames</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> request</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getParameterNames</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    StringBuffer</span><span style="color:#E06C75"> body</span><span style="color:#56B6C2"> =</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> StringBuffer</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> (bodyNames </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#C678DD">      while</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">bodyNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasMoreElements</span><span style="color:#ABB2BF">()) {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> name</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> bodyNames</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">nextElement</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> value</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> request</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getParameter</span><span style="color:#ABB2BF">(name);</span></span>
<span class="line"><span style="color:#E5C07B">        body</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(name).</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"="</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(value).</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"&amp;"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">      }</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">body</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">length</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">) {</span></span>
<span class="line"><span style="color:#E5C07B">      body</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">deleteCharAt</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">body</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">length</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">-</span><span style="color:#D19A66"> 1</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">      requestTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">body</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">body</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toString</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">      log</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">info</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"openfeign interceptor body:{}"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">body</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toString</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">  }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<h3 id="使-requestinterceptor-生效">使 RequestInterceptor 生效</h3>
<ol>
<li>
<p>代码方式全局生效</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyConfiguration</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> RequestInterceptor</span><span style="color:#61AFEF"> requestInterceptor</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> MyFeignRequestInterceptor</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
</li>
<li>
<p>配置方式全局生效</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="yml"><code><span class="line"><span style="color:#E06C75">feign</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  client</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    config</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      default</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">        connectTimeout</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">5000</span></span>
<span class="line"><span style="color:#E06C75">        readTimeout</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">5000</span></span>
<span class="line"><span style="color:#E06C75">        loggerLevel</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">full</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        # 拦截器配置（和@Bean的方式二选一）</span></span>
<span class="line"><span style="color:#E06C75">        requestInterceptors</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">          - </span><span style="color:#98C379">com.chou401.feign.config.MyFeignRequestInterceptor</span></span>
<span class="line"></span></code></pre>
</li>
<li>
<p>代码方式针对某个服务生效</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">FeignClient</span><span style="color:#E06C75">(</span><span style="color:#D19A66">value</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "service-a"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> configuration</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> MyFeignRequestInterceptor</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> ServiceClient</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
</li>
<li>
<p>配置方式针对某个服务生效</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="yml"><code><span class="line"><span style="color:#E06C75">feign</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  client</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    config</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      SERVICE-A</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">        connectTimeout</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">5000</span></span>
<span class="line"><span style="color:#E06C75">        readTimeout</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">5000</span></span>
<span class="line"><span style="color:#E06C75">        loggerLevel</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">full</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        # 拦截器配置（和@Bean的方式二选一）</span></span>
<span class="line"><span style="color:#E06C75">        requestInterceptors</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#ABB2BF">          - </span><span style="color:#98C379">com.chou401.feign.config.MyFeignRequestInterceptor</span></span>
<span class="line"></span></code></pre>
</li>
</ol>
<h3 id="服务提供者增加拦截器用于获取请求头中的数据">服务提供者增加拦截器（用于获取请求头中的数据）</h3>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Slf4j</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MvcInterceptor</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> HandlerInterceptor</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> preHandle</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">HttpServletRequest</span><span style="color:#E06C75;font-style:italic"> request</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">HttpServletResponse</span><span style="color:#E06C75;font-style:italic"> response</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Object</span><span style="color:#E06C75;font-style:italic"> handler</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> token</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> request</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getHeader</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"token"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">        log</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">info</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"obtain token is : {}"</span><span style="color:#ABB2BF">, token);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MvcInterceptorConfig</span><span style="color:#C678DD"> implements</span><span style="color:#E5C07B"> WebMvcConfigurer</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> addInterceptors</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">InterceptorRegistry</span><span style="color:#E06C75;font-style:italic"> registry</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">        registry</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addInterceptor</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> MvcInterceptor</span><span style="color:#ABB2BF">())</span></span>
<span class="line"><span style="color:#ABB2BF">                .</span><span style="color:#61AFEF">addPathPatterns</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"/**"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<h3 id="结合-hystrix-限流使用的坑">结合 Hystrix 限流使用的坑</h3>
<p>application.yaml 配置文件开启限流</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#E06C75">feign</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  hystrix</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    enabled</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span></span>
<span class="line"><span style="color:#E06C75">hystrix</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  command</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    default</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      execution</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">        isolation</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">          thread</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">            timeoutInMilliseconds</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">30000</span></span>
<span class="line"></span></code></pre>
<p>做完上述配置后，<strong>Feign 接口的熔断机制为：线程模式</strong>。如果我们自定义了一个 <code>RequestInterceptor</code> 实现类，就会导致 hystrix 熔断机制失效，接口调用异常（404、null）。</p>
<h4 id="原因分析">原因分析</h4>
<ul>
<li>在 Feign 调用之前，会先走到 RequestInterceptor 拦截器，拦截器中使用了 <code>ServletRequestAttributes</code> 获取请求数据。</li>
<li>默认 Feign 使用的是线程池模式，当开始熔断的时候，负责熔断的线程和执行 Feign 接口的线程不是同一个线程，ServletRequestAttributes 取到的将会是空值。</li>
</ul>
<h4 id="解决方案">解决方案</h4>
<p>将 hystrix 熔断方式从线程模式改为信号量模式</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#E06C75">feign</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  hystrix</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    enabled</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">true</span></span>
<span class="line"><span style="color:#E06C75">hystrix</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">  command</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">    default</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">      execution</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">        isolation</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">          thread</span><span style="color:#ABB2BF">:</span></span>
<span class="line"><span style="color:#E06C75">            timeoutInMilliseconds</span><span style="color:#ABB2BF">: </span><span style="color:#D19A66">30000</span></span>
<span class="line"><span style="color:#E06C75">          strategy</span><span style="color:#ABB2BF">: </span><span style="color:#98C379">SEMAPHORE</span></span>
<span class="line"></span></code></pre>
<h4 id="hystrix-线程池和信号量隔离区别">hystrix 线程池和信号量隔离区别</h4>








































<table><thead><tr><th></th><th>线程池</th><th>信号量</th></tr></thead><tbody><tr><td>线程</td><td>请求线程和调用 provider 线程不是同一条线程</td><td>请求线程和调用 provider 线程是同一条线程</td></tr><tr><td>开销</td><td>排队、调用、上下文切换等</td><td>无线程切换，开销低</td></tr><tr><td>异步</td><td>支持</td><td>不支持</td></tr><tr><td>并发支持</td><td>支持：最大线程池大小</td><td>支持： 最大信号量上限</td></tr><tr><td>传递 Header</td><td>不支持</td><td>支持</td></tr><tr><td>支持超时</td><td>支持</td><td>不支持</td></tr></tbody></table>
<h4 id="线程和信号量隔离的使用场景">线程和信号量隔离的使用场景</h4>
<blockquote>
<p><strong>线程池隔离</strong></p>
</blockquote>
<ul>
<li>请求并发量大，并且耗时长（一般是计算量大或者读数据库）</li>
<li>采用线程池隔离，可以保证大量的容器线程可用，不会由于其他服务原因，一直处于阻塞或者等待状态，快速失败返回</li>
</ul>
<blockquote>
<p><strong>信号量隔离</strong></p>
</blockquote>
<ul>
<li>请求并发量大，并且耗时短（一般是计算量小，或读缓存）</li>
<li>采用信号量隔离时的服务返回往往非常快，不会占用容器线程太长时间</li>
<li>其减少了线程切换的一些开销，提高了缓存服务的效率</li>
</ul>
<h2 id="openfeign-核心组件">openfeign 核心组件</h2>
<p>使用 Feign 最核心的是要构造一个 FeignClient，里面包含了一系列的组件：</p>
<ol>
<li>Encoder（SpringEncoder）
Encoder 编码器，当我们调用接口时，如果传递的参数是一个对象，Feign 需要对这个对象进行 encode 编码，做 JSON 序列化，即：encoder 负责将 Java 对象装换成 JSON 字符串。</li>
<li>Decoder（ResponseEntityDecoder）
Decoder 解码器，当接口收到一个 JSON 对象后，Feign 需要对这个对象进行 decode 解码，即：decoder 负责将 JSON 字符串转换成 JavaBean 对象。</li>
<li>Contract（SpringMvcContract）
一般来说 Feign 的@FeignClient 注解需要和 Spring Web MVC 支持的@PathVariable、@RequestMapping、@pRequestParam 等注解结合起来使用，但是 Feign 本身是不支持 Spring Web MVC 注解的，所以需要有一个契约组件（Contract），负责解释 Spring MVC 的注解，让 Feign 可以和 Spring MVC 注解结合起来使用。</li>
<li>Logger（Slf4jLogger）
Logger 为打印 Feign 接口请求调用日志的日志组件，默认为 Slf4jLogger。</li>
</ol>
<h2 id="openfeign-如何扫描所有-feignclient基于低版本-springcloud-20200x版本之前">openfeign 如何扫描所有 FeignClient（基于低版本 SpringCloud 2020.0.x版本之前）</h2>
<p>基于的 SpringCloud 版本</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="xml"><code><span class="line"><span style="color:#ABB2BF"> &lt;</span><span style="color:#E06C75">properties</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">spring-boot.version</span><span style="color:#ABB2BF">&gt;2.3.7.RELEASE&lt;/</span><span style="color:#E06C75">spring-boot.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">spring-cloud.version</span><span style="color:#ABB2BF">&gt;Hoxton.SR9&lt;/</span><span style="color:#E06C75">spring-cloud.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">    &lt;</span><span style="color:#E06C75">spring-cloud-alibaba.version</span><span style="color:#ABB2BF">&gt;2.2.6.RELEASE&lt;/</span><span style="color:#E06C75">spring-cloud-alibaba.version</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"><span style="color:#ABB2BF">&lt;/</span><span style="color:#E06C75">properties</span><span style="color:#ABB2BF">&gt;</span></span>
<span class="line"></span></code></pre>
<p>我们知道 openfeign 有两个注解：@EnableFeignClients 和 @FeignClient，其中：</p>
<blockquote>
<p>@EnableFeignClients：用来开启 openfeign</p>
<p>@FeignClient：标记要用 openfeign 来拦截的请求接口</p>
</blockquote>
<p>为什么 Service-B 服务中定义了一个 ServiceAClient 接口（继承自 Service-A 的 api 接口），某 Controller 或 Service 中通过 @Autowired 注入一个 ServiceAClient 接口的实例，就可以通过 openfeign 做负载均衡去调用 Service-A服务？</p>
<h3 id="feignclient解析">@FeignClient解析</h3>
<h4 id="feignclient注解解释">@FeignClient注解解释</h4>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#ABB2BF"> @</span><span style="color:#C678DD">interface</span><span style="color:#E5C07B"> FeignClient</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 微服务名</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">AliasFor</span><span style="color:#E06C75">(</span><span style="color:#98C379">"name"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> value</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#98C379"> ""</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 已经废弃，直接使用 name 即可</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /** @deprecated */</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Deprecated</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> serviceId</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#98C379"> ""</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 存在多个相同 FeignClient 时，可以使用 contextId 做唯一约束</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> contextId</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#98C379"> ""</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">AliasFor</span><span style="color:#E06C75">(</span><span style="color:#98C379">"value"</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> name</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#98C379"> ""</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 对应 Spring 的 @Qualifier 注解，在定义 @FeignClient 时，指定 qualifier</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 在 @Autowired 注入 FeignClient 时，使用 @Qualifier 注解</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    /** @deprecated */</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Deprecated</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> qualifier</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#98C379"> ""</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75">[] </span><span style="color:#61AFEF">qualifiers</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#E06C75"> {}</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 用于配置指定服务的地址 / IP，相当于直接请求这个服务，不经过 Ribbon 的负载均衡</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> url</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#98C379"> ""</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 当调用请求发生 404 错误时，如果 decode404 的值为 true，会执行 decode 解码用 404 代替抛出 FeignException 异常，否则直接抛出异常</span></span>
<span class="line"><span style="color:#C678DD">    boolean</span><span style="color:#61AFEF"> decode404</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // OpenFeign 的配置类，在配置类中可以自定义 Feign 的 Encoder、Decoder、LogLevel、Contract 等</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">[] </span><span style="color:#61AFEF">configuration</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#E06C75"> {}</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 定义容错的处理类（回退逻辑），fallback 类必须实现 FeignClient 的接口</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> fallback</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#E5C07B"> void</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 也是容错的处理，但是可以知道熔断的异常信息</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> fallbackFactory</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#E5C07B"> void</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // path 定义当前 FeignClient 访问接口时的统一前缀，比如接口地址是 /user/get，如果定义了前缀是 user，那么具体方法上的路径就只需要写 /get 即可</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#61AFEF"> path</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#98C379"> ""</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    boolean</span><span style="color:#61AFEF"> primary</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<h4 id="feignclient-注解作用">@FeignClient 注解作用</h4>
<p>用 @FeignClient 注解标注一个接口后，OpenFeign 会对这个接口创建一个对应的动态代理 —&gt; REST Client（发送 RESTful 请求的客户端），然后可以将这个 REST Client 注入其他的组件（比如 SerivceBController），如果弃用了 Ribbon，就会采用负载均衡的方式，来进行 http 请求的发送。</p>
<h5 id="使用-ribbonclient-自定义负载均衡策略">使用 @RibbonClient 自定义负载均衡策略</h5>
<p>可以用 @RibbonClient 标准一个配置类，在 @RibbonClient 注解的 configuration 属性中可以指定配置类，自定义自己的 Ribbon 的 ILoadBalancer，@RibbonClient 的名称要和 @FeignClient 的名称一样</p>
<p><strong>在 SpringBoot 扫描不到的目录下新建一个配置类：</strong></p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> MyConfiguration</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> IRule</span><span style="color:#61AFEF"> getRule</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> MyRule</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> IPing</span><span style="color:#61AFEF"> getPing</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> MyPing</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<p><strong>在 SpringBoot 可以扫描到的目录新建一个配置类（被 @RibbonClient 注解标注）：</strong>
由于 @FeignClient 中填的name()/value() 是 Service-A，所以 @RibbonClient 的 value() 也必须是 Service-A，表示针对调用服务 Service-A 时做负载均衡。</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Cinfiguration</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">RibbonClient</span><span style="color:#E06C75">(</span><span style="color:#D19A66">name</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "Service-A"</span><span style="color:#ABB2BF">,</span><span style="color:#D19A66"> configuration</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> MyConfiguration</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> ServiceAConfiguration</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<h3 id="enablefeignclients-解析">@EnableFeignClients 解析</h3>
<p><code>@EnableFeignClients</code> 注解用于开启 openfeign，可以猜测，@EnableFeignClients 注解会触发 openfeign 的核心机制：扫描所有包下面的 @FeignClient 注解的接口、生成 @FeignClient 标注接口的动态代理类。</p>
<p>基于这两个猜测解析 @EnableFeignClients。</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Retention</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">RetentionPolicy</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">RUNTIME</span><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Target</span><span style="color:#E06C75">({</span><span style="color:#E5C07B">ElementType</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">TYPE</span><span style="color:#E06C75">})</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Documented</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Import</span><span style="color:#E06C75">({</span><span style="color:#E5C07B">FeignClientsRegistrar</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">})</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#ABB2BF"> @</span><span style="color:#C678DD">interface</span><span style="color:#E5C07B"> EnableFeignClients</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75">[] </span><span style="color:#61AFEF">value</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#E06C75"> {}</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75">[] </span><span style="color:#61AFEF">basePackages</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#E06C75"> {}</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">[] </span><span style="color:#61AFEF">basePackageClasses</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#E06C75"> {}</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">[] </span><span style="color:#61AFEF">defaultConfiguration</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#E06C75"> {}</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">[] </span><span style="color:#61AFEF">clients</span><span style="color:#E06C75">() </span><span style="color:#C678DD">default</span><span style="color:#E06C75"> {}</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><code>@EnableFeignClients</code> 注解中通过 <code>@Import</code> 导入了一个 <code>FeignClientsRegistrar</code> 类，FeignClientsRegistrar 负责 FeignClient 的注册（即：扫描指定包下的 @FeignClient 注解标注的接口、生成 FeignClient 动态代理类、触发后面的其他流程）。</p>
<h4 id="feignclientsregistrar-类">FeignClientsRegistrar 类</h4>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202402291451526.png" alt="202402291451526" loading="lazy" decoding="async"></p>
<p>由于 <code>FeignClientsRegistrar</code> 实现自 <code>ImportBeanDefinitionRegistrar</code>，结合 <a href="spring-deifinition-integrated-impl.md">SpringBoot 的自动配置</a>，得知，在 SpringBoot 启动过程中会进入到 FeignClientsRegistrar#registerBeanDefinitions(AnnotationMetadata metadata, BeanDefinitionRegistry registry) 方法。</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> registerBeanDefinitions</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">AnnotationMetadata</span><span style="color:#E06C75"> metadata</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> BeanDefinitionRegistry</span><span style="color:#E06C75"> registry) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 注册默认配置</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerDefaultConfiguration</span><span style="color:#ABB2BF">(metadata, registry);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 注册所有的 FeignClient</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerFeignClients</span><span style="color:#ABB2BF">(metadata, registry);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><code>registerBeanDefinitions()</code> 方法是 Feign 的核心入口方法，其中会做两件事：注册默认的配置、注册所有的 FeignClient。</p>
<h5 id="注册默认配置">注册默认配置</h5>
<p><code>registerDefaultConfiguration()</code> 方法负责注册 openfeign 的默认配置。具体代码执行流程如下：</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> registerDefaultConfiguration</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">AnnotationMetadata</span><span style="color:#E06C75"> metadata</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> BeanDefinitionRegistry</span><span style="color:#E06C75"> registry) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取 @EnableFeignClients 注解中的全部属性</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> defaultAttrs </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAnnotationAttributes</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">EnableFeignClients</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">(), </span><span style="color:#D19A66">true</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (defaultAttrs </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> defaultAttrs</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">containsKey</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"defaultConfiguration"</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasEnclosingClass</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">            name </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "default."</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getEnclosingClassName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 默认这里，name 为启动类全路径名</span></span>
<span class="line"><span style="color:#E06C75">            name </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "default."</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClassName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 将以name 作为 beanName 的 BeanDefinition 注册到 BeanDefinitionRegistry 中</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerClientConfiguration</span><span style="color:#ABB2BF">(registry, name, </span><span style="color:#E5C07B">defaultAttrs</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"defaultConfiguration"</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> registerClientConfiguration</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">BeanDefinitionRegistry</span><span style="color:#E06C75"> registry</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75"> name</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75"> configuration) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 构建 BeanDefinition</span></span>
<span class="line"><span style="color:#E5C07B">    BeanDefinitionBuilder</span><span style="color:#E06C75"> builder </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> BeanDefinitionBuilder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">genericBeanDefinition</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">FeignClientSpecification</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    builder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addConstructorArgValue</span><span style="color:#ABB2BF">(name);</span></span>
<span class="line"><span style="color:#E5C07B">    builder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addConstructorArgValue</span><span style="color:#ABB2BF">(configuration);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 注册 BeanDefinition</span></span>
<span class="line"><span style="color:#E5C07B">    registry</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerBeanDefinition</span><span style="color:#ABB2BF">(name </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "."</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> FeignClientSpecification</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getSimpleName</span><span style="color:#ABB2BF">(), </span><span style="color:#E5C07B">builder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanDefinition</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>方法流程解析：</p>
<blockquote>
<p>1.首先获取 @EnableFeignClients 注解的全部属性</p>
<p>2.如果属性不为空，并且属性中包含 defaultConfiguration，则默认字符串 <code>default.</code> 和启动类全路径名拼接到一起</p>
<p>3.然后再拼接上 <code>.FeignClientSpecification</code>，作为 beanName，构建出一个 BeanDefinition，将其注册到 BeanDefinitionRegistry 中。</p>
</blockquote>
<h5 id="注册所有的-feignclient">注册所有的 FeignClient</h5>
<p>registerFeignClients()方法负责注册所有的FeignClient</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> registerFeignClients</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">AnnotationMetadata</span><span style="color:#E06C75"> metadata</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> BeanDefinitionRegistry</span><span style="color:#E06C75"> registry) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取类扫描器</span></span>
<span class="line"><span style="color:#E5C07B">    ClassPathScanningCandidateComponentProvider</span><span style="color:#E06C75"> scanner </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getScanner</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    scanner</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setResourceLoader</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">resourceLoader</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取 @EnableFeignClients 注解中的全部属性</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> attrs </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAnnotationAttributes</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">EnableFeignClients</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 给类扫描器添加 Filter，只扫描 @FeignClient 注解</span></span>
<span class="line"><span style="color:#E5C07B">    AnnotationTypeFilter</span><span style="color:#E06C75"> annotationTypeFilter </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> AnnotationTypeFilter</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">FeignClient</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取 @EnableFeignClients 注解中的 clients 属性值，默认为空</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75">[] clients </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> attrs </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#C678DD"> ?</span><span style="color:#D19A66"> null</span><span style="color:#C678DD"> :</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Class</span><span style="color:#E06C75">[])((</span><span style="color:#E5C07B">Class</span><span style="color:#E06C75">[])</span><span style="color:#E5C07B">attrs</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"clients"</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> basePackages</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (clients </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> clients</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> 0</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        final</span><span style="color:#E5C07B"> Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> clientClasses </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> HashSet</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        basePackages </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> HashSet</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        Class</span><span style="color:#E06C75">[] var9 </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> clients</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> var10 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> clients</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75">(</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> var11 </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> var11 </span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75"> var10</span><span style="color:#ABB2BF">;</span><span style="color:#ABB2BF"> ++</span><span style="color:#E06C75">var11) {</span></span>
<span class="line"><span style="color:#E5C07B">            Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> clazz </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> var9[var11]</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">            ((Set)basePackages)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ClassUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPackageName</span><span style="color:#ABB2BF">(clazz));</span></span>
<span class="line"><span style="color:#E5C07B">            clientClasses</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">clazz</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getCanonicalName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        AbstractClassTestingTypeFilter</span><span style="color:#E06C75"> filter </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> AbstractClassTestingTypeFilter</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#C678DD">            protected</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> match</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ClassMetadata</span><span style="color:#E06C75;font-style:italic"> metadata</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">                String</span><span style="color:#E06C75"> cleaned</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClassName</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">replaceAll</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"</span><span style="color:#56B6C2">\\</span><span style="color:#98C379">$"</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"."</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">                return</span><span style="color:#E5C07B"> clientClasses</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">contains</span><span style="color:#ABB2BF">(cleaned);</span></span>
<span class="line"><span style="color:#ABB2BF">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        scanner</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addIncludeFilter</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> AllTypeFilter</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Arrays</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">asList</span><span style="color:#ABB2BF">(filter, annotationTypeFilter)));</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        scanner</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addIncludeFilter</span><span style="color:#ABB2BF">(annotationTypeFilter);</span></span>
<span class="line"><span style="color:#E06C75">        basePackages </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBasePackages</span><span style="color:#ABB2BF">(metadata);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    Iterator</span><span style="color:#E06C75"> var17 </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> ((Set)basePackages)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">iterator</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    while</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">var17</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasNext</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> basePackage </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (String)</span><span style="color:#E5C07B">var17</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">next</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 遍历扫描到的所有包含 @FeignClient 注解的接口（BeanDefinition）</span></span>
<span class="line"><span style="color:#E5C07B">        Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanDefinition</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> candidateComponents </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> scanner</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">findCandidateComponents</span><span style="color:#ABB2BF">(basePackage);</span></span>
<span class="line"><span style="color:#E5C07B">        Iterator</span><span style="color:#E06C75"> var21 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> candidateComponents</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">iterator</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        while</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">var21</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasNext</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            BeanDefinition</span><span style="color:#E06C75"> candidateComponent </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (BeanDefinition)</span><span style="color:#E5C07B">var21</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">next</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (candidateComponent </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> AnnotatedBeanDefinition) {</span></span>
<span class="line"><span style="color:#E5C07B">                AnnotatedBeanDefinition</span><span style="color:#E06C75"> beanDefinition </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (AnnotatedBeanDefinition)candidateComponent</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">                AnnotationMetadata</span><span style="color:#E06C75"> annotationMetadata </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> beanDefinition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMetadata</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 如果标注了 @FeignClient 注解的 Class 不是接口类型，则触发断言</span></span>
<span class="line"><span style="color:#E5C07B">                Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTrue</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">annotationMetadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isInterface</span><span style="color:#ABB2BF">(), </span><span style="color:#98C379">"@FeignClient can only be specified on an interface"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 获取 @FeignClient 注解的全部属性</span></span>
<span class="line"><span style="color:#E5C07B">                Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> attributes </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> annotationMetadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAnnotationAttributes</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">FeignClient</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getCanonicalName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 从 @FeignClient 注解中获取要调用的服务名</span></span>
<span class="line"><span style="color:#E5C07B">                String</span><span style="color:#E06C75"> name </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClientName</span><span style="color:#ABB2BF">(attributes);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 将要调用的服务名称 + @FeignClient 的配置属性，在 BeanDefinitionRegistry 中注册一下</span></span>
<span class="line"><span style="color:#E5C07B">                this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerClientConfiguration</span><span style="color:#ABB2BF">(registry, name, </span><span style="color:#E5C07B">attributes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"configuration"</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                // 注册 FeignClient</span></span>
<span class="line"><span style="color:#E5C07B">                this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerFeignClient</span><span style="color:#ABB2BF">(registry, annotationMetadata, attributes);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><strong>方法逻辑解析：</strong></p>
<blockquote>
<p>1.首先获取@EnableFeignClients注解的所有属性，主要为了拿到扫描包路径（basePackages）；</p>
<p>2.因为一般不会在@EnableFeignClients注解中配置clients属性，所以会进入到clients属性为空时的逻辑；</p>
<p>3.然后通过getScanner()方法获取扫描器：ClassPathScanningCandidateComponentProvider，并将上下文AnnotationConfigServletWebServerApplicationContext作为扫描器的ResourceLoader；</p>
<p>4.接着给扫描器ClassPathScanningCandidateComponentProvider添加一个注解过滤器（AnnotationTypeFilter），只过滤出包含@FeignClient注解的BeanDefinition；</p>
<p>5.再通过getBasePackages(metadata)方法获取@EnableFeingClients注解中的指定的包扫描路径 或 扫描类；如果没有获取到，则默认扫描启动类所在的包路径；</p>
<p>6.然后进入到核心逻辑：通过scanner.findCandidateComponents(basePackage)方法从包路径下扫描出所有标注了@FeignClient注解并符合条件装配的接口；</p>
<p>7.最后将FeignClientConfiguration 在BeanDefinitionRegistry中注册一下，再对FeignClient做真正的注册操作。</p>
</blockquote>
<h5 id="获取包扫描路径">获取包扫描路径</h5>
<p>FeignClientsRegistrar#getBasePackages(metadata)方法负责获取包路径：</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Set</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">String</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> getBasePackages</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">AnnotationMetadata</span><span style="color:#E06C75"> importingClassMetadata) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取 @EnableFeignClients 注解的全部属性</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> attributes </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> importingClassMetadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAnnotationAttributes</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">EnableFeignClients</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getCanonicalName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> basePackages </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> HashSet</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75">[] var4 </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75">[])((</span><span style="color:#E5C07B">String</span><span style="color:#E06C75">[])</span><span style="color:#E5C07B">attributes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"value"</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    int</span><span style="color:#E06C75"> var5 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> var4</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    int</span><span style="color:#E06C75"> var6</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> pkg</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75">(var6 </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> var6 </span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75"> var5</span><span style="color:#ABB2BF">;</span><span style="color:#ABB2BF"> ++</span><span style="color:#E06C75">var6) {</span></span>
<span class="line"><span style="color:#E06C75">        pkg </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> var4[var6]</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">StringUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasText</span><span style="color:#ABB2BF">(pkg)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            basePackages</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(pkg);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 指定包路径</span></span>
<span class="line"><span style="color:#E06C75">    var4 </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75">[])((</span><span style="color:#E5C07B">String</span><span style="color:#E06C75">[])</span><span style="color:#E5C07B">attributes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"basePackages"</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    var5 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> var4</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75">(var6 </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> var6 </span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75"> var5</span><span style="color:#ABB2BF">;</span><span style="color:#ABB2BF"> ++</span><span style="color:#E06C75">var6) {</span></span>
<span class="line"><span style="color:#E06C75">        pkg </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> var4[var6]</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">StringUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasText</span><span style="color:#ABB2BF">(pkg)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            basePackages</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(pkg);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 指定类名场景下，获取指定类所在的包</span></span>
<span class="line"><span style="color:#E5C07B">    Class</span><span style="color:#E06C75">[] var8 </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Class</span><span style="color:#E06C75">[])((</span><span style="color:#E5C07B">Class</span><span style="color:#E06C75">[])</span><span style="color:#E5C07B">attributes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"basePackageClasses"</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    var5 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> var8</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75">(var6 </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> var6 </span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75"> var5</span><span style="color:#ABB2BF">;</span><span style="color:#ABB2BF"> ++</span><span style="color:#E06C75">var6) {</span></span>
<span class="line"><span style="color:#E5C07B">        Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> clazz </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> var8[var6]</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">        basePackages</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ClassUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPackageName</span><span style="color:#ABB2BF">(clazz));</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">basePackages</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 如果没有 @EnableFeignClient 注解没有指定扫描的包路径或类，则返回启动类所在的包</span></span>
<span class="line"><span style="color:#E5C07B">        basePackages</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ClassUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPackageName</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">importingClassMetadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClassName</span><span style="color:#ABB2BF">()));</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> basePackages</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><strong>方法执行逻辑解析：</strong></p>
<blockquote>
<p>1.首先获取@EnableFeignClients注解中的全部属性；</p>
<p>2.如果指定了basePackages，则采用basePackages指定的目录作为包扫描路径；</p>
<p>3.如果指定了一些basePackageClasses，则采用basePackageClasses指定的类们所在的目录 作为包扫描路径；</p>
<p>4.如果既没有指定basePackages，也没有指定basePackageClasses，则采用启动类所在的目录作为包扫描路径。默认是这种情况。</p>
</blockquote>
<h5 id="扫描所有的-feignclient">扫描所有的 FeignClient</h5>
<p>ClassPathScanningCandidateComponentProvider#findCandidateComponents(String basePackage)方法负责扫描出指定目录下的所有标注了@FeignClient注解的Class类（包括interface、正常的Class）。</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Set</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">BeanDefinition</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> findCandidateComponents</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> basePackage) {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">componentsIndex</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">indexSupportsIncludeFilters</span><span style="color:#ABB2BF">()</span><span style="color:#C678DD"> ?</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addCandidateComponentsFromIndex</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">componentsIndex</span><span style="color:#ABB2BF">, basePackage)</span><span style="color:#C678DD"> :</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">scanCandidateComponents</span><span style="color:#ABB2BF">(basePackage);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#7F848E;font-style:italic">// basePackage：启动类所在的目录</span></span>
<span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> Set</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">BeanDefinition</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> scanCandidateComponents</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> basePackage) {</span></span>
<span class="line"><span style="color:#E5C07B">    Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">BeanDefinition</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> candidates </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> LinkedHashSet</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> packageSearchPath </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "classpath*:"</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">resolveBasePackage</span><span style="color:#ABB2BF">(basePackage)</span><span style="color:#56B6C2"> +</span><span style="color:#98C379"> '/'</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">resourcePattern</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 扫描出指定路径下的所有 Class 文件</span></span>
<span class="line"><span style="color:#E5C07B">        Resource</span><span style="color:#E06C75">[] resources </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getResourcePatternResolver</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getResources</span><span style="color:#ABB2BF">(packageSearchPath);</span></span>
<span class="line"><span style="color:#C678DD">        boolean</span><span style="color:#E06C75"> traceEnabled </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isTraceEnabled</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        boolean</span><span style="color:#E06C75"> debugEnabled </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isDebugEnabled</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        Resource</span><span style="color:#E06C75">[] var7 </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> resources</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">        int</span><span style="color:#E06C75"> var8 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> resources</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">length</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 遍历每个 Class 文件</span></span>
<span class="line"><span style="color:#C678DD">        for</span><span style="color:#E06C75">(</span><span style="color:#C678DD">int</span><span style="color:#E06C75"> var9 </span><span style="color:#56B6C2">=</span><span style="color:#D19A66"> 0</span><span style="color:#ABB2BF">;</span><span style="color:#E06C75"> var9 </span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75"> var8</span><span style="color:#ABB2BF">;</span><span style="color:#ABB2BF"> ++</span><span style="color:#E06C75">var9) {</span></span>
<span class="line"><span style="color:#E5C07B">            Resource</span><span style="color:#E06C75"> resource </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> var7[var9]</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (traceEnabled) {</span></span>
<span class="line"><span style="color:#E5C07B">                this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">trace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Scanning "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> resource);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">resource</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isReadable</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">                try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">                    MetadataReader</span><span style="color:#E06C75"> metadataReader </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMetadataReaderFactory</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getMetadataReader</span><span style="color:#ABB2BF">(resource);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                    // 根据 Scanner 中的 @FeignClient 过滤器，过滤出所有被 @FeignClient 注解标注的 Class</span></span>
<span class="line"><span style="color:#C678DD">                    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isCandidateComponent</span><span style="color:#ABB2BF">(metadataReader)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">                        ScannedGenericBeanDefinition</span><span style="color:#E06C75"> sbd </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ScannedGenericBeanDefinition</span><span style="color:#E06C75">(metadataReader)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">                        sbd</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setSource</span><span style="color:#ABB2BF">(resource);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                        // 这里默认都返回 true，获取 Scanner 时重写了这个方法</span></span>
<span class="line"><span style="color:#C678DD">                        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isCandidateComponent</span><span style="color:#ABB2BF">((AnnotatedBeanDefinition)sbd)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">                            if</span><span style="color:#E06C75"> (debugEnabled) {</span></span>
<span class="line"><span style="color:#E5C07B">                                this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">debug</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Identified candidate component class: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> resource);</span></span>
<span class="line"><span style="color:#E06C75">                            }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                            // 最终标注了 @FeignClient 注解的 Class 都会放到这里，并返回</span></span>
<span class="line"><span style="color:#E5C07B">                            candidates</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(sbd);</span></span>
<span class="line"><span style="color:#E06C75">                        } </span><span style="color:#C678DD">else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (debugEnabled) {</span></span>
<span class="line"><span style="color:#E5C07B">                            this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">debug</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Ignored because not a concrete top-level class: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> resource);</span></span>
<span class="line"><span style="color:#E06C75">                        }</span></span>
<span class="line"><span style="color:#E06C75">                    } </span><span style="color:#C678DD">else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (traceEnabled) {</span></span>
<span class="line"><span style="color:#E5C07B">                        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">trace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Ignored because not matching any filter: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> resource);</span></span>
<span class="line"><span style="color:#E06C75">                    }</span></span>
<span class="line"><span style="color:#E06C75">                } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Throwable</span><span style="color:#E06C75;font-style:italic"> var13</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">                    throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanDefinitionStoreException</span><span style="color:#E06C75">(</span><span style="color:#98C379">"Failed to read candidate component class: "</span><span style="color:#56B6C2"> +</span><span style="color:#E06C75"> resource</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> var13)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"><span style="color:#E06C75">            } </span><span style="color:#C678DD">else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (traceEnabled) {</span></span>
<span class="line"><span style="color:#E5C07B">                this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">trace</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"Ignored because not readable: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> resource);</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E06C75"> candidates</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">IOException</span><span style="color:#E06C75;font-style:italic"> var14</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanDefinitionStoreException</span><span style="color:#E06C75">(</span><span style="color:#98C379">"I/O failure during classpath scanning"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> var14)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><strong>方法逻辑解析：</strong></p>
<blockquote>
<p>1.首先扫描出指定路径下的所有Class文件；</p>
<p>2.接着遍历每个Class文件，使用Scanner中的@FeignClient过滤器过滤出所有被@FeignClient注解标注的Class；</p>
<p>3.最后将过滤出的所有Class返回。</p>
</blockquote>
<p>细看一下 <code>isCandidateComponent(MetadataReader metadataReader)</code> 方法：</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> isCandidateComponent</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">MetadataReader</span><span style="color:#E06C75"> metadataReader) throws IOException {</span></span>
<span class="line"><span style="color:#E5C07B">    Iterator</span><span style="color:#E06C75"> var2 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">excludeFilters</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">iterator</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    TypeFilter</span><span style="color:#E06C75"> tf</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    do</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">var2</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasNext</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // includeFilters 是在获取到 Scanner 之后添加的</span></span>
<span class="line"><span style="color:#E06C75">            var2 </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">includeFilters</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">iterator</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">            do</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">                if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">var2</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasNext</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">                    return</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">                }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">                tf </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (TypeFilter)</span><span style="color:#E5C07B">var2</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">next</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 判断 Class 是否被 @FeignClient 注解标注</span></span>
<span class="line"><span style="color:#E06C75">            } </span><span style="color:#C678DD">while</span><span style="color:#E06C75">(</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">tf</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">match</span><span style="color:#ABB2BF">(metadataReader, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMetadataReaderFactory</span><span style="color:#ABB2BF">())</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            //条件装配</span></span>
<span class="line"><span style="color:#C678DD">            return</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isConditionMatch</span><span style="color:#ABB2BF">(metadataReader);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">        tf </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (TypeFilter)</span><span style="color:#E5C07B">var2</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">next</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">while</span><span style="color:#E06C75">(</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">tf</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">match</span><span style="color:#ABB2BF">(metadataReader, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMetadataReaderFactory</span><span style="color:#ABB2BF">())</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#D19A66"> false</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>AbstractTypeHierarchyTraversingFilter#match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory)</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> match</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">MetadataReader</span><span style="color:#E06C75"> metadataReader</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> MetadataReaderFactory</span><span style="color:#E06C75"> metadataReaderFactory) throws IOException {</span></span>
<span class="line"><span style="color:#C678DD">  if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">matchSelf</span><span style="color:#ABB2BF">(metadataReader)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#D19A66"> true</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"><span style="color:#ABB2BF">  ...</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">AnnotationTypeFilter#</span><span style="color:#61AFEF">matchSelf</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">MetadataReader</span><span style="color:#E06C75"> metadataReader)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E06C75">```java</span></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> boolean</span><span style="color:#61AFEF"> matchSelf</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">MetadataReader</span><span style="color:#E06C75"> metadataReader) {</span></span>
<span class="line"><span style="color:#E5C07B">    AnnotationMetadata</span><span style="color:#E06C75"> metadata </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> metadataReader</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getAnnotationMetadata</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasAnnotation</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">annotationType</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">())</span><span style="color:#56B6C2"> ||</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">considerMetaAnnotations</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasMetaAnnotation</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">annotationType</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<h5 id="注册feignclient">注册FeignClient</h5>
<p>扫描到所有的FeignClient之后，需要将其注入到Spring中，<code>FeignClientsRegistrar#registerFeignClient()</code> 方法负责这个操作；</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> registerFeignClient</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">BeanDefinitionRegistry</span><span style="color:#E06C75"> registry</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> AnnotationMetadata</span><span style="color:#E06C75"> annotationMetadata</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Map</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">String</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> Object</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> attributes) {</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> className </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> annotationMetadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClassName</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 构建 FeignClient 对应的 BeanDefinition</span></span>
<span class="line"><span style="color:#E5C07B">    BeanDefinitionBuilder</span><span style="color:#E06C75"> definition </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> BeanDefinitionBuilder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">genericBeanDefinition</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">FeignClientFactoryBean</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">validate</span><span style="color:#ABB2BF">(attributes);</span></span>
<span class="line"><span style="color:#E5C07B">    definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addPropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"url"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getUrl</span><span style="color:#ABB2BF">(attributes));</span></span>
<span class="line"><span style="color:#E5C07B">    definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addPropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"path"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPath</span><span style="color:#ABB2BF">(attributes));</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> name </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getName</span><span style="color:#ABB2BF">(attributes);</span></span>
<span class="line"><span style="color:#E5C07B">    definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addPropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"name"</span><span style="color:#ABB2BF">, name);</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> contextId </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getContextId</span><span style="color:#ABB2BF">(attributes);</span></span>
<span class="line"><span style="color:#E5C07B">    definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addPropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"contextId"</span><span style="color:#ABB2BF">, contextId);</span></span>
<span class="line"><span style="color:#E5C07B">    definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addPropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"type"</span><span style="color:#ABB2BF">, className);</span></span>
<span class="line"><span style="color:#E5C07B">    definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addPropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"decode404"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">attributes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"decode404"</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">    definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addPropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"fallback"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">attributes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"fallback"</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">    definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">addPropertyValue</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"fallbackFactory"</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">attributes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"fallbackFactory"</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E5C07B">    definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setAutowireMode</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">2</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> alias </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> contextId </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> "FeignClient"</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    AbstractBeanDefinition</span><span style="color:#E06C75"> beanDefinition </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> definition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBeanDefinition</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    beanDefinition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setAttribute</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"factoryBeanObjectType"</span><span style="color:#ABB2BF">, className);</span></span>
<span class="line"><span style="color:#C678DD">    boolean</span><span style="color:#E06C75"> primary </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Boolean)</span><span style="color:#E5C07B">attributes</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"primary"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    beanDefinition</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setPrimary</span><span style="color:#ABB2BF">(primary);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 如果 FeignClient 配置了别名，则采用别名作为 beanName</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> qualifier </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getQualifier</span><span style="color:#ABB2BF">(attributes);</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">StringUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasText</span><span style="color:#ABB2BF">(qualifier)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        alias </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> qualifier</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    BeanDefinitionHolder</span><span style="color:#E06C75"> holder </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BeanDefinitionHolder</span><span style="color:#E06C75">(beanDefinition</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> className</span><span style="color:#ABB2BF">,</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> String</span><span style="color:#E06C75">[]{alias})</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 将 FeignClient 注册到 Spring 的临时容器</span></span>
<span class="line"><span style="color:#E5C07B">    BeanDefinitionReaderUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">registerBeanDefinition</span><span style="color:#ABB2BF">(holder, registry);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>注册FeignClient实际就是构建一个FeignClient对应的BeanDefinition，然后将FeignClient的一些属性配置设置为BeanDefinition的property，最后将BeanDefinition注册到Spring的临时容器。在处理FeignClient的属性配置时，如果@FeignClient中配置了qualifier，则使用qualifier作为beanName。</p>
<p>到这里已经完成了包的扫描、FeignClient的解析、FeignClient数据以BeanDefinition的形式存储到spring框架中的BeanDefinitionRegistry中。</p>
<h3 id="feignclient-的动态代理类">FeignClient 的动态代理类</h3>
<p>在<code>AbstractApplicationContext#refresh()</code>方法中最后调用的<code>finishBeanFactoryInitialization(beanFactory)</code>方法中会将所有类全部注入到Spring容器中；在将ServiceBController注入到Spring容器过程中，会将其成员ServiceAClient也注入到Spring容器中，<code>AbstractAutowireCapableBeanFactory#populateBean()</code>方法会处理ServiceAClient，进而调用到<code>AutowiredAnnotationBeanPostProcessor#postProcessProperties()</code>方法对ServiceAClient做一个注入操作。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011534065.png" alt="202403011534065" loading="lazy" decoding="async"></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011541600.png" alt="202403011541600" loading="lazy" decoding="async"></p>
<p>走到<code>AbstractBeanFactory#getBean(String)</code>方法获取ServiceBController依赖的成员类型ServiceAClient。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011542177.png" alt="202403011542177" loading="lazy" decoding="async"></p>
<p>由于我们在注册FeignClient到Spring容器时，构建的BeanDefinition的beanClas是FeignClientFactoryBean。</p>
<p>FeignClientFactoryBean是一个工厂，保存了@FeignClient注解的所有属性值，在Spring容器初始化的过程中，其会根据之前扫描出的FeignClient信息构建FeignClient的动态代理类。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011547458.png" alt="202403011547458" loading="lazy" decoding="async"></p>
<p>从debug的堆栈信息我们可以看到是FeignClientFactoryBean#getObject()方法负责获取/创建动态代理类。</p>
<h4 id="feignclientfactorybean-创建动态代理类的入口">FeignClientFactoryBean 创建动态代理类的入口</h4>
<p>我们都知道要通过注册到 Spring 容器中的 FeignClient 的 BeanDefinition 的 beanClass 属性是 FeignClientFactoryBean，所以大概率和 FeignClientFactoryBean 是相关的，怎么找呐？连蒙带猜~</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#E5C07B"> Feign</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Builder</span><span style="color:#61AFEF"> feign</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">FeignContext</span><span style="color:#E06C75"> context) {</span></span>
<span class="line"><span style="color:#E5C07B">    FeignLoggerFactory</span><span style="color:#E06C75"> loggerFactory </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (FeignLoggerFactory)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">FeignLoggerFactory</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Logger</span><span style="color:#E06C75"> logger </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> loggerFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">type</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Feign</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Builder</span><span style="color:#E06C75"> builder </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> ((</span><span style="color:#E5C07B">Feign</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Builder</span><span style="color:#E06C75">)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">Feign</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Builder</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">logger</span><span style="color:#ABB2BF">(logger).</span><span style="color:#61AFEF">encoder</span><span style="color:#ABB2BF">((Encoder)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">Encoder</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)).</span><span style="color:#61AFEF">decoder</span><span style="color:#ABB2BF">((Decoder)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">Decoder</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">)).</span><span style="color:#61AFEF">contract</span><span style="color:#ABB2BF">((Contract)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">Contract</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 处理 Feign.Builder 的配置信息</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configureFeign</span><span style="color:#ABB2BF">(context, builder);</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> builder</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>注意到 FeignClientFactoryBean 的 feign(FeignContext context) 方法，方法会构造一个 Feign.Builder，Builder，这不就是构造器模式嘛，基于 Feign.Builder 可以构造对应的 FeignClient。</p>
<p>再看哪里调用了 feign() 方法，找到 getTarget() 方法。</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">T</span><span style="color:#56B6C2">&gt;</span><span style="color:#E5C07B"> T</span><span style="color:#61AFEF"> getTarget</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    FeignContext</span><span style="color:#E06C75"> context </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (FeignContext)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">applicationContext</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">FeignContext</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Feign</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Builder</span><span style="color:#E06C75"> builder </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">feign</span><span style="color:#ABB2BF">(context);</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">StringUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasText</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">startsWith</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"http"</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "http://"</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#56B6C2"> =</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">cleanPath</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">loadBalance</span><span style="color:#ABB2BF">(builder, context, </span><span style="color:#C678DD">new</span><span style="color:#ABB2BF"> Target.</span><span style="color:#61AFEF">HardCodedTarget</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">type</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#ABB2BF">));</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">StringUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">hasText</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#ABB2BF">)</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#56B6C2"> !</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">startsWith</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"http"</span><span style="color:#ABB2BF">)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#56B6C2"> =</span><span style="color:#98C379"> "http://"</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        String</span><span style="color:#E06C75"> url </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">url</span><span style="color:#56B6C2"> +</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">cleanPath</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">        Client</span><span style="color:#E06C75"> client </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Client)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getOptional</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">Client</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (client </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (client </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> LoadBalancerFeignClient) {</span></span>
<span class="line"><span style="color:#E06C75">                client </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> ((LoadBalancerFeignClient)client)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDelegate</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">            if</span><span style="color:#E06C75"> (client </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> FeignBlockingLoadBalancerClient) {</span></span>
<span class="line"><span style="color:#E06C75">                client </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> ((FeignBlockingLoadBalancerClient)client)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDelegate</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">            builder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">client</span><span style="color:#ABB2BF">(client);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">        Targeter</span><span style="color:#E06C75"> targeter </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Targeter)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">Targeter</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> targeter</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">target</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">, builder, context, </span><span style="color:#C678DD">new</span><span style="color:#ABB2BF"> Target.</span><span style="color:#61AFEF">HardCodedTarget</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">type</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">, url));</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>对于有一定开发的经验而言，见到 Target 这一类东西，基本可以确定就是动态代理。</p>
<p>再往上追，看哪里调用了 getTarget() 方法？进入到 getObject() 方法。</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> getObject</span><span style="color:#E06C75">() throws Exception {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getTarget</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>而getObject()方法是FactoryBean接口中定义的方法。</p>
<p>到这里可以确定 FeignClientFactoryBean#getObject() 方法，在 Spring 容器初始化时，会被作为入口来调用，进而创建一个 ServiceAClient 的动态代理，返回给 Spring 容器并注册到 Spring 容器里去。</p>
<h4 id="feignbuilder的构建过程">Feign.Builder的构建过程</h4>
<p>上面我们得出结论：FeignClient 是通过 Feign.Builder 来构建的，生成 FeignClient 动态代理的入口是 FeignClientFactoryBean#getObject()，这里我们看一下 Feign.Builder 是如何构建的？</p>
<h5 id="feigncontext-上下文的获取">FeignContext 上下文的获取</h5>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011636380.png" alt="202403011636380" loading="lazy" decoding="async"></p>
<p>调用FeignClientFactoryBean#getObject()创建/获取FeignClient动态代理类时，首先要通过</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E5C07B">FeignContext</span><span style="color:#E06C75"> context </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> applicationContext</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">FeignContext</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span></code></pre>
<p>获取 feign 的上下文 FeignClient。
这里的 applicationContext 是 AnnotationConfigServletWebApplicationContext。</p>
<blockquote>
<p>ribbon里有一个SpringClientFactory，就是对每个服务的调用，都会有一个独立的ILoadBalancer，IoadBalancer里面的IRule、IPing都是独立的组件，也就是说ribbon要调用的每个服务都对应一个独立的spring容器；从那个独立的spring容器中，可以取出某个服务关联的属于自己的LoadBalancer、IRule、IPing等。</p>
</blockquote>
<p>FeignClient 也是类似的上下文：</p>
<blockquote>
<p>我们如果要调用一个服务的话，ServiceA，那么那个服务（ServiceA）就会关联一个独立的spring容器；关联着自己独立的一些组件，比如说独立的Logger组件，独立的Decoder组件，独立的Encoder组件；FeignContext则代表了一个独立的容器工厂，里面记录了每个服务对应的容器AnnotationConfigApplicationContext。</p>
<ul>
<li>因此，可以对不同的@FeignClient自定义不同的Configuration。</li>
</ul>
</blockquote>
<p><strong>FeignContext在哪里注入到Spring容器的？</strong>
FeignClient 位于 spring-cloud-openfeign-core 项目，我们在这个项目下结合 SpringBoot 自动装配的特性找 XxxAutoConfiguration 和 XxxConfiguration，最终找到 FeignAutoConfiguration。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011646192.png" alt="202403011646192" loading="lazy" decoding="async"></p>
<p>FeignAutoConfiguration中使用@Bean方法将FeignContext注入到Spring容器。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011649023.png" alt="202403011649023" loading="lazy" decoding="async"></p>
<p>FeignContext 继承自 NamedContextFactory，内部负责对每个服务都维护一个对应的spring容器（以map存储，一个服务对应一个spring容器），此处和 Ribbon 一样。</p>
<p>进入到 feign() 方法中，以获取 FeignLoggerFactory 为例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011654599.png" alt="202403011654599" loading="lazy" decoding="async"></p>
<p>get(FeignContext context, Class type)方法要做的事情如下：</p>
<blockquote>
<ul>
<li>根据服务名称（ServiceA）去FeignContext里面去获取对应的FeignLoggerFactory；</li>
<li>其实就是根据ServiceA服务名称，先获取对应的spring容器，然后从那个spring容器中，获取自己独立的一个FeignLoggerFactory；</li>
</ul>
</blockquote>
<p>默认使用的 FeignLoggerFactory 是在 spring-cloud-openfeign-core 项目的 FeignClientsConfiguration 类中加载的 DefaultFeignLoggerFactory，而 DefaultFeignLoggerFactory 中默认创建的是Slf4jLogger。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011704244.png" alt="202403011704244" loading="lazy" decoding="async"></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011705898.png" alt="202403011705898" loading="lazy" decoding="async"></p>
<h5 id="从-feignclient-中获取-feignbuilder">从 FeignClient 中获取 Feign.Builder</h5>
<p>这里和上面获取 FeignLoggerFactory 一样，在 spring-cloud-openfeign-core 项目的 FeignClientsConfiguration 类中会找到两个 Feign.Builder（一个和 Hystrix 相关，另外一个 Retryer 相关的(请求超时、失败重试)）的注册逻辑：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011729059.png" alt="202403011729059" loading="lazy" decoding="async"></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011731270.png" alt="202403011731270" loading="lazy" decoding="async"></p>
<p>由于默认 feign.hystrix.enabled 属性为 false，所以默认注入的 Feign.Builder 是 Feign.builder().retryer(retryer)。</p>
<h5 id="处理配置信息">处理配置信息</h5>
<p>回到 feign() 方法，其中调用的 <code>configureFeign(context, builder)</code> 方法负责处理 Feign 的相关配置（即：使用 application.yml 中配置的参数，来设置 Feign.Builder）。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011745579.png" alt="202403011745579" loading="lazy" decoding="async"></p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> void</span><span style="color:#61AFEF"> configureFeign</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">FeignContext</span><span style="color:#E06C75"> context</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Feign</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Builder</span><span style="color:#E06C75"> builder) {</span></span>
<span class="line"><span style="color:#E5C07B">    FeignClientProperties</span><span style="color:#E06C75"> properties </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (FeignClientProperties)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">applicationContext</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getBean</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">FeignClientProperties</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    FeignClientConfigurer</span><span style="color:#E06C75"> feignClientConfigurer </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (FeignClientConfigurer)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getOptional</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">FeignClientConfigurer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">setInheritParentContext</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">feignClientConfigurer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">inheritParentConfiguration</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (properties </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">inheritParentContext</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">properties</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isDefaultToProperties</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configureUsingConfiguration</span><span style="color:#ABB2BF">(context, builder);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 读取 application.yml 文件中针对所有服务 default 的配置</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configureUsingProperties</span><span style="color:#ABB2BF">((</span><span style="color:#E5C07B">FeignClientProperties</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">FeignClientConfiguration</span><span style="color:#ABB2BF">)</span><span style="color:#E5C07B">properties</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getConfig</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">properties</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDefaultConfig</span><span style="color:#ABB2BF">()), builder);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 读取 application.yml 文件中针对当前服务的配置</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configureUsingProperties</span><span style="color:#ABB2BF">((</span><span style="color:#E5C07B">FeignClientProperties</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">FeignClientConfiguration</span><span style="color:#ABB2BF">)</span><span style="color:#E5C07B">properties</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getConfig</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">contextId</span><span style="color:#ABB2BF">), builder);</span></span>
<span class="line"><span style="color:#E06C75">        } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configureUsingProperties</span><span style="color:#ABB2BF">((</span><span style="color:#E5C07B">FeignClientProperties</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">FeignClientConfiguration</span><span style="color:#ABB2BF">)</span><span style="color:#E5C07B">properties</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getConfig</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">properties</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDefaultConfig</span><span style="color:#ABB2BF">()), builder);</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configureUsingProperties</span><span style="color:#ABB2BF">((</span><span style="color:#E5C07B">FeignClientProperties</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">FeignClientConfiguration</span><span style="color:#ABB2BF">)</span><span style="color:#E5C07B">properties</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getConfig</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">contextId</span><span style="color:#ABB2BF">), builder);</span></span>
<span class="line"><span style="color:#E5C07B">            this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configureUsingConfiguration</span><span style="color:#ABB2BF">(context, builder);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configureUsingConfiguration</span><span style="color:#ABB2BF">(context, builder);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><strong>逻辑解析：</strong></p>
<blockquote>
<ol>
<li>FeignClientProperties是针对FeignClient的配置；</li>
<li>先读取application.yml中的feign.client打头的一些参数，包括了connectionTimeout、readTimeout之类的参数；如果application.yml中没有配置feign.client相关参数，则使用默认配置（Retryer retryer、ErrorDecoder、Request.Options等）；</li>
<li>然后读取application.yml中针对当前要调用服务的配置。</li>
</ol>
<p>所以如果在 application.yml 文件中同时配置了针对全部服务和单个服务的配置，则针对单个服务的配置优先级更高，因为在代码解析中它是放在后面解析的，会覆盖前面解析的内容。</p>
</blockquote>
<h5 id="使用-feignbuilder-构建出一个-feignclient">使用 Feign.Builder 构建出一个 FeignClient</h5>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403041111641.png" alt="202403041111641" loading="lazy" decoding="async"></p>
<p>如果在 @FeignClient 上，没有配置 url 属性，也就是没有指定服务的 url 地址，那么 Feign 就会自动跟 Ribbon 关联起来，采用 Ribbon 来进行负载均衡，直接拿出 @FeignClient 中配置的 name() 为 Ribbon 准备对应的 url 地址：<code>http://ServiceA</code>。</p>
<p>此外如果在 @FeignClient 注解中配置了 <code>path 属性</code>，就表示要访问的是这个 ServiceA 服务的莫一类接口，比如：@FeignClient(value=“ServiceA”, path=“/user”)，在拼接请求 URL 地址的时候，就会拼接成：<code>http://ServiceA/user</code>。</p>
<p><code>FeignClientFactoryBean#loadBalance()</code> 方法是一个基于 Ribbon 进行负载均衡的 FeignClient 动态代理生成方法：</p>
<blockquote>
<p>入参：</p>
<ol>
<li>Feign.Builder builder —&gt; FeignClient构造器</li>
<li>FeignContext context —&gt; Feign上下文</li>
<li>HardCodedTarget<t> target，target是一个HardCodedTarget，硬编码的Target，里面包含了接口类型（com.zhss.service.ServiceAClient）、服务名称（ServiceA）、url地址（<a href="http://ServiceA">http://ServiceA</a>）</t></li>
</ol>
</blockquote>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">protected</span><span style="color:#56B6C2"> &lt;</span><span style="color:#E06C75">T</span><span style="color:#56B6C2">&gt;</span><span style="color:#E5C07B"> T</span><span style="color:#61AFEF"> loadBalance</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Feign</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Builder</span><span style="color:#E06C75"> builder</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> FeignContext</span><span style="color:#E06C75"> context</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Target</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">HardCodedTarget</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">T</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> target) {</span></span>
<span class="line"><span style="color:#E5C07B">    Client</span><span style="color:#E06C75"> client </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Client)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getOptional</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">Client</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (client </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        builder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">client</span><span style="color:#ABB2BF">(client);</span></span>
<span class="line"><span style="color:#E5C07B">        Targeter</span><span style="color:#E06C75"> targeter </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Targeter)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(context, </span><span style="color:#E5C07B">Targeter</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> targeter</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">target</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">, builder, context, target);</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">        throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> IllegalStateException</span><span style="color:#E06C75">(</span><span style="color:#98C379">"No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?"</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><code>loadBalance()</code> 方法中首先会获取 Client 和 Targeter：</p>
<ul>
<li>通过 <code>Client client = getOptional(context, Client.class)</code> 方法获取 Client，返回的是 <code>LoadBalancerFeignClient</code>，（高版本是 FeignBlockingLoadBalancerClient）</li>
<li>通过 <code>Targeter targeter = get(context, Targeter.class)</code> 方法获取 Targeter：，返回的是 <code>HystrixTargeter</code></li>
</ul>
<h6 id="loadbalancerfeignclient-在哪里注入到-spring-容器">LoadBalancerFeignClient 在哪里注入到 Spring 容器</h6>
<p>进入到 LoadBalancerFeignClient 类中看哪里调用了它唯一一个构造函数</p>
<p>找到 LoadBalancerFeignClient 有三个地方调用了它的构造函数，new 了一个实例：</p>
<ul>
<li>DefaultFeignLoadBalancedConfiguration</li>
<li>HttpClientFeignLoadBalancedConfiguration</li>
<li>OkHttpFeignLoadBalancedConfiguration</li>
</ul>
<p>再结合默认的配置，只有 DefaultFeignLoadBalancedConfiguration 中的 Client 符合条件装配</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#D19A66">    proxyBeanMethods</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> false</span></span>
<span class="line"><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">class</span><span style="color:#E5C07B"> DefaultFeignLoadBalancedConfiguration</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#61AFEF">    DefaultFeignLoadBalancedConfiguration</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">ConditionalOnMissingBean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Client</span><span style="color:#61AFEF"> feignClient</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">CachingSpringLoadBalancerFactory</span><span style="color:#E06C75;font-style:italic"> cachingFactory</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">SpringClientFactory</span><span style="color:#E06C75;font-style:italic"> clientFactory</span><span style="color:#ABB2BF">)</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> LoadBalancerFeignClient</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#ABB2BF"> Client.</span><span style="color:#61AFEF">Default</span><span style="color:#ABB2BF">((SSLSocketFactory)</span><span style="color:#D19A66">null</span><span style="color:#ABB2BF">, (HostnameVerifier)</span><span style="color:#D19A66">null</span><span style="color:#ABB2BF">), cachingFactory, clientFactory);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<p>可以通过引入 Apache HttpClient 的 Maven 依赖使用 HttpClientFeignLoadBalancedConfiguration，或引入 OkHttpClient 的 Maven 依赖并在 application.yml 文件中指定 feign.okhttp.enabled 属性为 true 使用 OkHttpFeignLoadBalancedConfiguration。</p>
<h6 id="hystrixtargeter-在哪里注入到-spring-容器">HystrixTargeter 在哪里注入到 Spring 容器</h6>
<p>在 <code>FeignAutoConfiguration</code> 类中可以找到 Targeter 注入到 Spring 容器的逻辑</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#D19A66">    proxyBeanMethods</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> false</span></span>
<span class="line"><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">ConditionalOnMissingClass</span><span style="color:#E06C75">({</span><span style="color:#98C379">"feign.hystrix.HystrixFeign"</span><span style="color:#E06C75">})</span></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> DefaultFeignTargeterConfiguration</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    protected</span><span style="color:#61AFEF"> DefaultFeignTargeterConfiguration</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">ConditionalOnMissingBean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Targeter</span><span style="color:#61AFEF"> feignTargeter</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> DefaultTargeter</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Configuration</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#D19A66">    proxyBeanMethods</span><span style="color:#56B6C2"> =</span><span style="color:#D19A66"> false</span></span>
<span class="line"><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">ConditionalOnClass</span><span style="color:#E06C75">(</span></span>
<span class="line"><span style="color:#D19A66">    name</span><span style="color:#56B6C2"> =</span><span style="color:#E06C75"> {</span><span style="color:#98C379">"feign.hystrix.HystrixFeign"</span><span style="color:#E06C75">}</span></span>
<span class="line"><span style="color:#E06C75">)</span></span>
<span class="line"><span style="color:#C678DD">protected</span><span style="color:#C678DD"> static</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> HystrixFeignTargeterConfiguration</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">    protected</span><span style="color:#61AFEF"> HystrixFeignTargeterConfiguration</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">ConditionalOnMissingBean</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Targeter</span><span style="color:#61AFEF"> feignTargeter</span><span style="color:#ABB2BF">()</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> HystrixTargeter</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<blockquote>
<p>默认是创建 HystrixTargeter：</p>
<ol>
<li>如果有 feign.hystrix.HystrixFeign 这个类的话，那么就会构造一个 HystrixTargeter 出来</li>
<li>如果没有 feign.hystrix.HystrixFeign 这个类的话，那么就会构造一个 DefaultTargeter 出来</li>
</ol>
</blockquote>
<p>HystrixTargeter 是用来让 Feign 和 Hystrix 整合使用的，在发送请求的时候可以基于 Hystrix 实现熔断、限流、降级。</p>
<ul>
<li>生产环境如果启用 <code>feign.hystrix.HystrixFeign</code>，则 Feign.Builder 也会变成 HystrixFeign.Builder，默认还是 Feign 自己的 Feign.Builder。</li>
</ul>
<h6 id="hystrixtargetertarget方法">HystrixTargeter#target()方法</h6>
<p>继续往下走，进入到 <code>HystrixTargeter#target()</code> 方法，具体代码执行流程如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403041658903.png" alt="202403041658903" loading="lazy" decoding="async"></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403041659749.png" alt="202403041659749" loading="lazy" decoding="async"></p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Feign</span><span style="color:#61AFEF"> build</span><span style="color:#E06C75">() {</span></span>
<span class="line"><span style="color:#E5C07B">    Client</span><span style="color:#E06C75"> client </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Client)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">client</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Retryer</span><span style="color:#E06C75"> retryer </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Retryer)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">retryer</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取所有的 RequestInterceptor</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">RequestInterceptor</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> requestInterceptors </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (List)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">requestInterceptors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">stream</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">map</span><span style="color:#ABB2BF">((ri) </span><span style="color:#C678DD">-&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#ABB2BF"> (RequestInterceptor)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(ri, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">    }).</span><span style="color:#61AFEF">collect</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Collectors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toList</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Logger</span><span style="color:#E06C75"> logger </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Logger)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">logger</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Contract</span><span style="color:#E06C75"> contract </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Contract)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">contract</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Request</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Options</span><span style="color:#E06C75"> options </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Request</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Options</span><span style="color:#E06C75">)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">options</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Encoder</span><span style="color:#E06C75"> encoder </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Encoder)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">encoder</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    Decoder</span><span style="color:#E06C75"> decoder </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (Decoder)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">decoder</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    InvocationHandlerFactory</span><span style="color:#E06C75"> invocationHandlerFactory </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (InvocationHandlerFactory)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">invocationHandlerFactory</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    QueryMapEncoder</span><span style="color:#E06C75"> queryMapEncoder </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (QueryMapEncoder)</span><span style="color:#E5C07B">Capability</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">enrich</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">queryMapEncoder</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">capabilities</span><span style="color:#ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 将 FeignClient 的一些信息放到 Handler 中</span></span>
<span class="line"><span style="color:#E5C07B">    SynchronousMethodHandler</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Factory</span><span style="color:#E06C75"> synchronousMethodHandlerFactory </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E06C75"> SynchronousMethodHandler</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">Factory</span><span style="color:#ABB2BF">(client, retryer, requestInterceptors, logger, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">logLevel</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">decode404</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">closeAfterDecode</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">propagationPolicy</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">forceDecoding</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">    ReflectiveFeign</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">ParseHandlersByName</span><span style="color:#E06C75"> handlersByName </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E06C75"> ReflectiveFeign</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">ParseHandlersByName</span><span style="color:#ABB2BF">(contract, options, encoder, decoder, queryMapEncoder, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">errorDecoder</span><span style="color:#ABB2BF">, synchronousMethodHandlerFactory);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // ReflectiveFeign 负责生成动态代理类</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ReflectiveFeign</span><span style="color:#E06C75">(handlersByName</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> invocationHandlerFactory</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> queryMapEncoder)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><code>Feign#target()</code> 方法中主要做两件事：</p>
<ol>
<li>build() 方法将Feign.Builder 中所有东西集成在一起，构建成一个 ReflectiveFeign</li>
<li>ReflectiveFeign#newInstance() 方法负责生成动态代理</li>
</ol>
<h6 id="reflectivefeignnewinstance生成动态代理类">ReflectiveFeign#newInstance()生成动态代理类</h6>
<p>ReflectiveFeign#newInstance() 源码如下</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#56B6C2"> &lt;</span><span style="color:#E06C75">T</span><span style="color:#56B6C2">&gt;</span><span style="color:#E5C07B"> T</span><span style="color:#61AFEF"> newInstance</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Target</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">T</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> target) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 基于我们配置的Contract、Encoder等一堆组件，加上Target对象（知道是ServiceAClient接口），去进行接口的所有spring mvc注解的解析，以及接口中各个方法的一些解析，获取了这个接口中有哪些方法</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> MethodHandler</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> nameToHandler </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> targetToHandlersByName</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">apply</span><span style="color:#ABB2BF">(target);</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Method</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> MethodHandler</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> methodToHandler </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> LinkedHashMap</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Method</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> MethodHandler</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">DefaultMethodHandler</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> defaultMethodHandlers </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> LinkedList</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">DefaultMethodHandler</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 遍历ServiceAClient接口中的每个方法</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Method</span><span style="color:#E06C75"> method </span><span style="color:#C678DD">:</span><span style="color:#E5C07B"> target</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">type</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getMethods</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">method</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getDeclaringClass</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> ==</span><span style="color:#E5C07B"> Object</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            continue</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">        } </span><span style="color:#C678DD">else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Util</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isDefault</span><span style="color:#ABB2BF">(method)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">            DefaultMethodHandler</span><span style="color:#E06C75"> handler </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> DefaultMethodHandler</span><span style="color:#E06C75">(method)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">            defaultMethodHandlers</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">add</span><span style="color:#ABB2BF">(handler);</span></span>
<span class="line"><span style="color:#E5C07B">            methodToHandler</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(method, handler);</span></span>
<span class="line"><span style="color:#E06C75">        } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 将ServiceAClient接口中的每个方法，加上对应的nameToHandler中存放的对应的SynchronousMethodHandler（异步化的方法代理处理组件），放到一个map中去</span></span>
<span class="line"><span style="color:#E5C07B">            methodToHandler</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(method, </span><span style="color:#E5C07B">nameToHandler</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Feign</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configKey</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">target</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">type</span><span style="color:#ABB2BF">(), method)));</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // JDK动态代理）基于一个factory工厂，创建了一个InvocationHandler</span></span>
<span class="line"><span style="color:#E5C07B">    InvocationHandler</span><span style="color:#E06C75"> handler </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> factory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(target, methodToHandler);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 基于JDK的动态代理，创建出来了一个动态代理类：Proxy，其实现ServiceAClient接口</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // new Class&lt;?&gt;[]{target.type()}，这个就是ServiceAClient接口</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // InvocationHandler：对上面proxy动态代理类所有方法的调用，都会走这个InvocationHandler的拦截方法，由这个InvocationHandler中的一个方法来提供所有方法的一个实现的逻辑</span></span>
<span class="line"><span style="color:#E5C07B">    T</span><span style="color:#E06C75"> proxy </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> (T) </span><span style="color:#E5C07B">Proxy</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">newProxyInstance</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">target</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">type</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">getClassLoader</span><span style="color:#ABB2BF">(),</span></span>
<span class="line"><span style="color:#C678DD">        new</span><span style="color:#E5C07B"> Class</span><span style="color:#ABB2BF">&lt;</span><span style="color:#C678DD">?</span><span style="color:#ABB2BF">&gt;[] {</span><span style="color:#E5C07B">target</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">type</span><span style="color:#ABB2BF">()}, handler);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 上述代码段中，就是 JDK 动态代理的体现，动态生成一个没有名字的匿名类，这个类实现了 ServiceAClient（FeignClient）接口，基于这个匿名类创建一个对象（T proxy），这就是所谓的动态代理，后续所有对这个 T proxy 对象所有接口方法的调用，都会交给 InvocationHandler 处理，此处的 InvocationHandler 是 ReflectiveFeign 的内部类 FeignInvocationHandler</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">DefaultMethodHandler</span><span style="color:#E06C75"> defaultMethodHandler </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> defaultMethodHandlers) {</span></span>
<span class="line"><span style="color:#E5C07B">        defaultMethodHandler</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">bindTo</span><span style="color:#ABB2BF">(proxy);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> proxy</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>方法中有两个Map类型的局部变量：nameToHandler、methodToHandler：</p>
<blockquote>
<ol>
<li>nameToHandler 释义：接口中的每个方法的名称，对应一个处理这个方法的SynchronousMethodHandler；由ReflectiveFeign的内部类ParseHandlersByName的apply(target)方法获取。</li>
<li>methodToHandler 释义：接口中的每个方法（Method对象），对应一个处理这个方法的SynchronousMethodHandler；</li>
</ol>
</blockquote>
<h6 id="parsehandlersbynameapply解析feignclient中的方法">ParseHandlersByName#apply()解析FeignClient中的方法</h6>
<p><code>ParseHandlersByName#apply()</code> 方法会对我们定义的 ServiceAClient 接口进行解析，解析里面有哪些方法，然后为每个方法创建一个 SynchronousMethodHandler 出来，也就是说某个 SynchronousMethodHandler 专门用来处理那个方法的请求调用。</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Map</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">String</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> MethodHandler</span><span style="color:#56B6C2">&gt;</span><span style="color:#61AFEF"> apply</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Target</span><span style="color:#E06C75"> target) {</span></span>
<span class="line"><span style="color:#E5C07B">    List</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">MethodMetadata</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> metadata </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> contract</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">parseAndValidateMetadata</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">target</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">type</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> MethodHandler</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> LinkedHashMap</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> MethodHandler</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">MethodMetadata</span><span style="color:#E06C75"> md </span><span style="color:#C678DD">:</span><span style="color:#E06C75"> metadata) {</span></span>
<span class="line"><span style="color:#E5C07B">    BuildTemplateByResolvingArgs</span><span style="color:#E06C75"> buildTemplate</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">md</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">formParams</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">isEmpty</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> &amp;&amp;</span><span style="color:#E5C07B"> md</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">template</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">bodyTemplate</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> ==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        buildTemplate </span><span style="color:#56B6C2">=</span></span>
<span class="line"><span style="color:#C678DD">            new</span><span style="color:#61AFEF"> BuildFormEncodedTemplateFromArgs</span><span style="color:#E06C75">(md</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> encoder</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> queryMapEncoder</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> target)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">else</span><span style="color:#C678DD"> if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">md</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">bodyIndex</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        buildTemplate </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BuildEncodedTemplateFromArgs</span><span style="color:#E06C75">(md</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> encoder</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> queryMapEncoder</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> target)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E06C75">        buildTemplate </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> BuildTemplateByResolvingArgs</span><span style="color:#E06C75">(md</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> queryMapEncoder</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> target)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">md</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isIgnored</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        result</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">md</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configKey</span><span style="color:#ABB2BF">(), args </span><span style="color:#C678DD">-&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">        throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> IllegalStateException</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">md</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configKey</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">+</span><span style="color:#98C379"> " is not a method handled by feign"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#ABB2BF">        });</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">        result</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">md</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configKey</span><span style="color:#ABB2BF">(),</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">            // 为每个方法创建对应的 MethodHandler</span></span>
<span class="line"><span style="color:#E5C07B">            factory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(target, md, buildTemplate, options, decoder, errorDecoder));</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> result</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>其中 <code>factory.create</code> 会为所有标注了 SpringMvc 注解的方法都生成一个对应的 SynchronousMethodHandler。</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> MethodHandler</span><span style="color:#61AFEF"> create</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Target</span><span style="color:#56B6C2">&lt;</span><span style="color:#C678DD">?</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> target</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">                            // 解析这个方法，针对这个方法生成一个 SynchronousMethodHandler</span></span>
<span class="line"><span style="color:#E5C07B">                            MethodMetadata</span><span style="color:#E06C75"> md</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E5C07B">                            RequestTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Factory</span><span style="color:#E06C75"> buildTemplateFromArgs</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E5C07B">                            Options</span><span style="color:#E06C75"> options</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E5C07B">                            Decoder</span><span style="color:#E06C75"> decoder</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E5C07B">                            ErrorDecoder</span><span style="color:#E06C75"> errorDecoder) {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> SynchronousMethodHandler</span><span style="color:#E06C75">(target</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> client</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> retryer</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> requestInterceptors</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> logger</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E06C75">        logLevel</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> md</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> buildTemplateFromArgs</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> options</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> decoder</span><span style="color:#ABB2BF">,</span></span>
<span class="line"><span style="color:#E06C75">        errorDecoder</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> decode404</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> closeAfterDecode</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> propagationPolicy</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> forceDecoding)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><code>SpringMvcContract.parseAndValidateMetadata()</code> 方法负责解析 FeignClient 接口中每个标注了 SpringMvc 注解的方法，即：Feign 依靠 Contract 组件（SpringMvcContract）来解析接口上的 SpringMvc 注解。</p>
<blockquote>
<p>针对 FeignClient 接口中的每个标注了 springMVC 注解的方法都会被 springMvcContract 组件解析，针对每个方法最后都生成一个 MethodMetadata，代表方法的一些元数据，包括：</p>
<ol>
<li>方法的定义：比如：ServiceAClient#deleteUser(Long)</li>
<li>方法的返回类型：比如：class java.lang.String</li>
<li>发送 HTTP 请求的模版：比如：DELETE /user/{id} HTTP/1.1</li>
</ol>
</blockquote>
<h6 id="springmvccontract组件的工作原理">SpringMvcContract组件的工作原理</h6>
<p>看一下 <code>SpringMvcContract.parseAndValidateMetadata()</code> 如何解析 FeignClient 中的每个方法</p>
<p>以如下方法为例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403041746106.png" alt="202403041746106" loading="lazy" decoding="async"></p>
<p>解析逻辑如下：</p>
<blockquote>
<ol>
<li>解析@RequestMapping注解，看看里面的method属性是什么？是GET/UPDATE/DELETE，然后在HTTP template里就加上GET/UPDATE/DELETE；（示例为DELETE）</li>
<li>找到接口上定义的@RequestMapping注解，解析里面的value值，拿到请求路径（/user），此时HTTP template变成：DELETE /user</li>
<li>再次解析deleteUser()方法上的@RequestMapping注解，找到里面的value，获取到/{id}，拼接到HTTP template里去：DELETE /user/{id}</li>
<li>接着硬编码拼死一个HTTP协议，http 1.1，HTTP template：DELETE /user/{id} HTTP/1.1</li>
<li>indexToName：解析@PathVariable注解，第一个占位符（index是0）要替换成方法入参里的id这个参数的值</li>
<li>假如后面来调用这个deleteUser()方法，传递进来的id = 1.那么此时就会拿出之前解析好的HTTP template：DELETE /user/{id} HTTP/1.1。然后用传递进来的id = 1替换掉第一个占位符的值，DELETE /user/1 HTTP/1.1</li>
</ol>
</blockquote>
<h3 id="openfeign处理http请求">OpenFeign处理HTTP请求</h3>
<h4 id="动态代理处理请求的入口">动态代理处理请求的入口</h4>
<p>我们知道所有对动态代理对象（T Proxy）的所有接口方法的调用，都会交给 <code>InvocationHandler</code> 来处理，此处的 <code>InvocationHandler</code> 是 <code>ReflectiveFeign</code> 的内部类 <code>FeignInvocationHandler</code>。针对 FeignClient 的每个方法都会对应一个 <code>SynchronousMethodHandler</code>。</p>
<p>以 <code>http://localhost:9090/ServiceB/user/sayHello/1?name=zhangsan&amp;age=18</code> 请求调用为例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051440325.png" alt="202403051440325" loading="lazy" decoding="async"></p>
<p>请求调用 ServiceBController 的 greeting() 方法后，要调用 ServiceAClient#sayHello() 方法时，请求会进到 ServiceAClient 的动态代理类，进而请求交给 ReflectiveFeign 的内部类 FeignInvocationHandler 来处理，在结合 JDK 动态代理的特性，方法会交给 invoke() 方法执行，所以动态代理处理请求的入口为：<code>ReflectiveFeign</code> 的内部类 <code>FeignInvocationHandler</code> 的 invoke() 方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051446826.png" alt="202403051446826" loading="lazy" decoding="async"></p>
<p>方法逻辑：</p>
<blockquote>
<ol>
<li>针对父类 Object 的 equals、hashCode、toString 方法直接处理</li>
<li>其他方法则从 dispatch 中获取 Method 对应的 MethodHandler，然后将方法的执行交给 MethodHandler 来处理</li>
<li>dispatch 是一个以 Method 为 key，MethodHandler 为 value 的 Map 类型（Map&lt;Method， MethodHandler&gt;），其是在构建 FeignInvocationHandler 时，记录了每个 FeignClient 对应的所有方法 MethodHandler 的映射</li>
</ol>
</blockquote>
<p>invoke() 方法中通过方法名找到 Method 对应的 MethodHandler，这里的 MethodHandler 为 SynchronousMethodHandler，然后将 args 参数交给它来处理请求</p>
<h4 id="synchronousmethodhandler-处理请求机制">SynchronousMethodHandler 处理请求机制</h4>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">  public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> invoke</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75">[] argv) throws Throwable {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 创建一个请求模版</span></span>
<span class="line"><span style="color:#E5C07B">    RequestTemplate</span><span style="color:#E06C75"> template </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> buildTemplateFromArgs</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(argv);</span></span>
<span class="line"><span style="color:#E5C07B">    Options</span><span style="color:#E06C75"> options </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> findOptions</span><span style="color:#E06C75">(argv)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Retryer</span><span style="color:#E06C75"> retryer </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">retryer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">clone</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">    while</span><span style="color:#E06C75"> (</span><span style="color:#D19A66">true</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">      try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">        // 执行请求并返回 decode 后的结果</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#61AFEF"> executeAndDecode</span><span style="color:#E06C75">(template</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> options)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">      } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">RetryableException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">        try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">          retryer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">continueOrPropagate</span><span style="color:#ABB2BF">(e);</span></span>
<span class="line"><span style="color:#E06C75">        } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">RetryableException</span><span style="color:#E06C75;font-style:italic"> th</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">          Throwable</span><span style="color:#E06C75"> cause </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> th</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getCause</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#C678DD">          if</span><span style="color:#E06C75"> (propagationPolicy </span><span style="color:#56B6C2">==</span><span style="color:#E06C75"> UNWRAP </span><span style="color:#56B6C2">&amp;&amp;</span><span style="color:#E06C75"> cause </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#E06C75"> cause</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">          } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">            throw</span><span style="color:#E06C75"> th</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">          }</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        if</span><span style="color:#E06C75"> (logLevel </span><span style="color:#56B6C2">!=</span><span style="color:#E5C07B"> Logger</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Level</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">NONE</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">          logger</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">logRetry</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">configKey</span><span style="color:#ABB2BF">(), logLevel);</span></span>
<span class="line"><span style="color:#E06C75">        }</span></span>
<span class="line"><span style="color:#C678DD">        continue</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">      }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"></span></code></pre>
<p><code>SynchronousMethodHandler#invoke()</code> 方法中主要包括两大块：创建请求模版、执行请求并返回 decode 后的结果。</p>
<p>这里的重试机制，其实就是依靠 Retryer#continueOrPropagate() 方法中对重试次数的判断，超过最大重试次数抛异常结束流程。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051634061.png" alt="202403051634061" loading="lazy" decoding="async"></p>
<h5 id="创建请求模版springmvccontract-解析方法参数">创建请求模版（SpringMvcContract 解析方法参数）</h5>
<p>在上文中我们聊到会用 SpringMvcContract 解析Spring mvc 的注解，最终拿到方法的对应的请求（RequestTemplate）是 <code>GET /user/sayHello/{id} HTTP/1.1</code>，但是要生成一个可以访问的请求地址，需要再基于 SpringMvcContract 去解析 @RequestParam 注解，将方法的入参，绑定到 HTTP 请求参数里去，最终将请求处理为 <code>GET /user/sayHello/1?name=zhangsan&amp;age=18 HTTP/1.1</code></p>
<p>而 <code>RequestTemplate template = buildTemplateFromArgs.create(argv)</code> 负责做这个操作，ReflectiveFeign#create(Object[] argv)：</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> RequestTemplate</span><span style="color:#61AFEF"> create</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Object</span><span style="color:#E06C75">[] argv) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 获取 REST 请求模版</span></span>
<span class="line"><span style="color:#E5C07B">  RequestTemplate</span><span style="color:#E06C75"> mutable </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> RequestTemplate</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">from</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">template</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E5C07B">  mutable</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">feignTarget</span><span style="color:#ABB2BF">(target);</span></span>
<span class="line"><span style="color:#C678DD">  if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">urlIndex</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">    int</span><span style="color:#E06C75"> urlIndex </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">urlIndex</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#61AFEF">    checkArgument</span><span style="color:#E06C75">(argv[urlIndex] </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">,</span><span style="color:#98C379"> "URI parameter %s was null"</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> urlIndex)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    mutable</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">target</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">valueOf</span><span style="color:#ABB2BF">(argv[urlIndex]));</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"><span style="color:#E5C07B">  Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> varBuilder </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E5C07B"> LinkedHashMap</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 遍历 REST 请求要调用方法标记了 springmvc 注解的参数</span></span>
<span class="line"><span style="color:#C678DD">  for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">Entry</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">Integer</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Collection</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">&gt;&gt;</span><span style="color:#E06C75"> entry </span><span style="color:#C678DD">:</span><span style="color:#E5C07B"> metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">indexToName</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">entrySet</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">    int</span><span style="color:#E06C75"> i </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> entry</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getKey</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> value </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> argv[</span><span style="color:#E5C07B">entry</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getKey</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">]</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (value </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) { </span><span style="color:#7F848E;font-style:italic">// Null values are skipped.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">      // 使用 SpringMvcContract 解析出方法参数对应的 value 值</span></span>
<span class="line"><span style="color:#C678DD">      if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">indexToExpander</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">containsKey</span><span style="color:#ABB2BF">(i)</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">        value </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> expandElements</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">indexToExpander</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(i),</span><span style="color:#E06C75"> value)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">      }</span></span>
<span class="line"><span style="color:#C678DD">      for</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">String</span><span style="color:#E06C75"> name </span><span style="color:#C678DD">:</span><span style="color:#E5C07B"> entry</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getValue</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">        varBuilder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">put</span><span style="color:#ABB2BF">(name, value);</span></span>
<span class="line"><span style="color:#E06C75">      }</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 构建出完整的 REST 请求</span></span>
<span class="line"><span style="color:#E5C07B">  RequestTemplate</span><span style="color:#E06C75"> template </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> resolve</span><span style="color:#E06C75">(argv</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> mutable</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> varBuilder)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 处理表单内容</span></span>
<span class="line"><span style="color:#C678DD">  if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">queryMapIndex</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // add query map parameters after initial resolve so that they take</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // precedence over any predefined values</span></span>
<span class="line"><span style="color:#E5C07B">    Object</span><span style="color:#E06C75"> value </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> argv[</span><span style="color:#E5C07B">metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">queryMapIndex</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">]</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">    Map</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">String</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> queryMap </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> toQueryMap</span><span style="color:#E06C75">(value)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    template </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> addQueryMapQueryParameters</span><span style="color:#E06C75">(queryMap</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> template)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 处理请求头内容</span></span>
<span class="line"><span style="color:#C678DD">  if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">headerMapIndex</span><span style="color:#ABB2BF">()</span><span style="color:#56B6C2"> !=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">    template </span><span style="color:#56B6C2">=</span></span>
<span class="line"><span style="color:#61AFEF">        addHeaderMapHeaders</span><span style="color:#E06C75">((</span><span style="color:#E5C07B">Map</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">String</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> Object</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75">) argv[</span><span style="color:#E5C07B">metadata</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">headerMapIndex</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">]</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> template)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">  return</span><span style="color:#E06C75"> template</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>以解析 <code>@PathVariable("id") Long id</code> 为例，SpringMvcContract 解析逻辑如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051717607.png" alt="202403051717607" loading="lazy" decoding="async"></p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">private</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> expandElements</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Expander</span><span style="color:#E06C75"> expander</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75"> value) {</span></span>
<span class="line"><span style="color:#C678DD">  if</span><span style="color:#E06C75"> (value </span><span style="color:#C678DD">instanceof</span><span style="color:#E06C75"> Iterable) {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#61AFEF"> expandIterable</span><span style="color:#E06C75">(expander</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> (Iterable) value)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"><span style="color:#C678DD">  return</span><span style="color:#E5C07B"> expander</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">expand</span><span style="color:#ABB2BF">(value);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051723717.png" alt="202403051723717" loading="lazy" decoding="async"></p>
<p>最后解析出 <code>@PathVariable("id") Long id</code> 对应的值为 1，然后将所有的标注了 SpringMVC 注解的参数都解析完之后，将参数名和对应的 value 值放到一个命名为 <code>varBuilder</code> 的 Map 中：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051728793.png" alt="202403051728793" loading="lazy" decoding="async"></p>
<p>接着需要根据 varBuilder 的内容构建出一个完整的 REST 请求（即：将 SpringMVC 注解标注的参数全部用 value 值替换、添加到请求中）</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051736823.png" alt="202403051736823" loading="lazy" decoding="async"></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051744919.png" alt="202403051744919" loading="lazy" decoding="async"></p>
<p><code>RequestTemplate resolve(Map&lt;String, ?&gt; variables)</code> 中负责解析并构建完整的 RequestTemplate，进到方法中的 urlTemplate 为 <code>/user/sayHello/{id}</code>，variables 为上面的 varBuilder：<code>{"id":1,"name":"zhangsan","age":18}</code>。</p>
<p>方法中首先将 <code>"id":1</code> 替换 <code>urlTemplate（/user/sayHello/{id}）</code> 中的 {id}，得出 expanded 为 <code>/user/sayHello/1</code>，然后再将查询参数 <code>"name":"zhangsan","age":18</code> 拼接到请求中，得到最终的 URL 为：<code>/user/sayHello/1?name=zhangsan&amp;age=18</code>，返回的 RequestTemplate 内容为：</p>
<p><code>buildTemplateFromArgs.create(argv)</code> 方法执行完成之后，得到一个完整的 RequestTemplate，下面需要基于这个 RequestTemplate 来执行请求。</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051758648.png" alt="202403051758648" loading="lazy" decoding="async"></p>
<h5 id="执行请求并解码返回值">执行请求并解码返回值</h5>
<p><code>SynchronousMethodHandler#executeAndDecode(RequestTemplate, Options)</code> 方法负责执行请求并解码返回值，具体执行逻辑如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051804120.png" alt="202403051804120" loading="lazy" decoding="async"></p>
<p>方法中主要做三件事：应用所有的 RequestInterceptor（即执行 RequestInterceptor#apply()方法）、通过 LoadBalancerFeignClient 做负载均衡执行请求，使用 Decoder 对请求返回结果解码或处理返回结果。</p>
<p>下面分开来看</p>
<h6 id="应用所有的-requestinterceptor">应用所有的 RequestInterceptor</h6>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051813337.png" alt="202403051813337" loading="lazy" decoding="async"></p>
<p>遍历所有的请求拦截器 <code>RequestInterceptor</code>，将每个请求拦截器都应用到 RequestTemplate 请求模版上面去，也就是让每个请求拦截器都对请求进行处理（调用拦截器的 apply（RequestTemplate）方法）。</p>
<blockquote>
<ul>
<li>其实这里本质上就是基于 RequestTemplate，创建一个Request</li>
<li>Request 是基于之前的 HardCodedTarget（包含了目标请求服务信息的一个 Target，服务名也在其中），处理 RequestTemplate，生成一个 Request</li>
</ul>
</blockquote>
<p>应用完所有的 RequestInterceptor 之后，如果 Feign 日志的隔离级别不等于 <code>Logger.Level.NONE</code>，则打印即将要发送的 Request 请求日志；
打印完请求日志之后，会通过 <code>SynchronousMethodHandler</code> 中的成员 Client 来执行请求，对于 OpenFeign 旧版而言，Client 是 <code>LoadBalancerFeignClient</code>。</p>
<h6 id="loadbalancerfeignclient-负载均衡执行请求详述">LoadBalancerFeignClient 负载均衡执行请求详述</h6>
<p>基于 LoadBalancerFeignClient 完成了请求的处理和发送，这里肯定是将 HTTP 请求发送到对应 server 的某个实例上去，同时获取到 Response 响应。</p>
<p><code>LoadBalancerFeignClient#execute()</code> 方法处理逻辑：</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Response</span><span style="color:#61AFEF"> execute</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Request</span><span style="color:#E06C75"> request</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Request</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Options</span><span style="color:#E06C75"> options) throws IOException {</span></span>
<span class="line"><span style="color:#C678DD">  try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 将请求的 url 封装成 URI</span></span>
<span class="line"><span style="color:#E5C07B">    URI</span><span style="color:#E06C75"> asUri </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> URI</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">request</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">url</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 获取要请求的服务名</span></span>
<span class="line"><span style="color:#E5C07B">    String</span><span style="color:#E06C75"> clientName </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> asUri</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getHost</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 从 URI 中剔除服务名</span></span>
<span class="line"><span style="color:#E5C07B">    URI</span><span style="color:#E06C75"> uriWithoutHost </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> cleanUrl</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">request</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">url</span><span style="color:#ABB2BF">(),</span><span style="color:#E06C75"> clientName)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 将请求封装为 RibbonRequest</span></span>
<span class="line"><span style="color:#E5C07B">    FeignLoadBalancer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">RibbonRequest</span><span style="color:#E06C75"> ribbonRequest </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#E06C75"> FeignLoadBalancer</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">RibbonRequest</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">delegate</span><span style="color:#ABB2BF">, request, uriWithoutHost);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 将 options 封装为请求配置传给 Ribbon</span></span>
<span class="line"><span style="color:#E5C07B">    IClientConfig</span><span style="color:#E06C75"> requestConfig </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getClientConfig</span><span style="color:#ABB2BF">(options, clientName);</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 通过集成的 Ribbon 执行请求</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> ((</span><span style="color:#E5C07B">FeignLoadBalancer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">RibbonResponse</span><span style="color:#E06C75">)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">lbClient</span><span style="color:#ABB2BF">(clientName).</span><span style="color:#61AFEF">executeWithLoadBalancer</span><span style="color:#ABB2BF">(ribbonRequest, requestConfig)</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toResponse</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">  } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">ClientException</span><span style="color:#E06C75;font-style:italic"> var8</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">    IOException</span><span style="color:#E06C75"> io </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">findIOException</span><span style="color:#ABB2BF">(var8);</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (io </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">      throw</span><span style="color:#E06C75"> io</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">      throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> RuntimeException</span><span style="color:#E06C75">(var8)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>方法逻辑解析：</p>
<blockquote>
<ol>
<li>首先将请求的url封装成一个URI，然后从请求URL地址中，获取到要访问的服务名称clientName（示例为ServiceA）</li>
<li>然后将请求URI中的服务名称剔除，比如这里的 <a href="http://Service-A/user/sayHello/">http://Service-A/user/sayHello/</a> 变为 http:///user/sayHello/</li>
<li>接着基于去除了服务名称的uri地址，创建了一个适用于Ribbon的请求（FeignLoadBalancer.RibbonRequest）</li>
<li>根据服务名从SpringClientFactory（Feign上下文）中获取Ribbon相关的配置IClientConfig，比如（连接超时时间、读取数据超时时间），如果获取不到，则创建一个FeignOptionsClientConfig</li>
<li>最后根据服务名从CachingSpringLoadBalancerFactory获取对应的FeignLoadBalancer；在FeignLoadBalancer里封装了ribbon的ILoadBalancer</li>
</ol>
</blockquote>
<p>既然Feign中集成了Ribbon，那它们是怎么整合到一起的？FeignLoadBalancer中用了Ribbon的那个ILoadBalancer？Feign如何使用Ribbon进行负载均衡？最终发送出去的请求URI是什么样的？</p>
<p><strong>1&gt; Feign 是如何和 Ribbon、eureka 整合在一起的？FeignLoadBalancer 中用了 Ribbon 的那个 ILoadBalancer？</strong></p>
<ol>
<li>
<p>FeignLoadBalancer中用了Ribbon的那个ILoadBalancer?</p>
<p>FeignLoadBalancer的类继承结构如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403061818220.png" alt="202403061818220" loading="lazy" decoding="async"></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403061819814.png" alt="202403061819814" loading="lazy" decoding="async"></p>
<p>FeignLoadBalancer间接继承自LoadBalancerContext，LoadBalancerContext中有一个ILoadBalancer类型的成员，其就是FeignLoadBalancer中集成的Ribbon的ILoadBalancer。从代码执行流程来看，集成的ILoadBalancer为Ribbon默认的ZoneAwareLoadBalancer：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403061830279.png" alt="202403061830279" loading="lazy" decoding="async"></p>
<p>到这里，可以看到根据服务名获取到的FeignLoadBalancer中组合了Ribbon的ZoneAwareLoadBalancer负载均衡器。</p>
</li>
<li>
<p>Ribbon和Eureka的集成?
RibbonClientConfiguration#ribbonLoadBalancer</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">Bean</span></span>
<span class="line"><span style="color:#ABB2BF">@</span><span style="color:#E5C07B">ConditionalOnMissingBean</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">// serverList: 服务实例列表信息</span></span>
<span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> ILoadBalancer</span><span style="color:#61AFEF"> ribbonLoadBalancer</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">IClientConfig</span><span style="color:#E06C75"> config</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ServerList</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">Server</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> serverList</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ServerListFilter</span><span style="color:#56B6C2">&lt;</span><span style="color:#E06C75">Server</span><span style="color:#56B6C2">&gt;</span><span style="color:#E06C75"> serverListFilter</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> IRule</span><span style="color:#E06C75"> rule</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> IPing</span><span style="color:#E06C75"> ping</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> ServerListUpdater</span><span style="color:#E06C75"> serverListUpdater) {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> (ILoadBalancer)(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">propertiesFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isSet</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ILoadBalancer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">    ?</span><span style="color:#E06C75"> (ILoadBalancer)</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">propertiesFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">get</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">ILoadBalancer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, config, </span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">name</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">    :</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> ZoneAwareLoadBalancer</span><span style="color:#E06C75">(config</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> rule</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> ping</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> serverList</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> serverListFilter</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> serverListUpdater))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>Ribbon自己和Eureka集成的流程：Ribbon的配置类RibbonClientConfiguration，会初始化ZoneAwareLoadBalancer并将其注入到Spring容器；ZoneAwareLoadBalancer内部持有跟eureka进行整合的DomainExtractingServerList（Eureka和Ribbon集成的配置类EurekaRibbonClientConfiguration（spring-cloud-netflix-eureka-client项目下）中负责将其注入到Spring容器）,nacos 和 ribbon 集成的配置类 NacosRibbonClientConfiguration。</p>
<p>小结：
在spring boot启动，要去获取一个ribbon的ILoadBalancer的时候，会去从那个服务对应的一个独立的spring容器（Ribbon子上下文）中获取；获取到一个服务对应的ZoneAwareLoadBalancer，其中组合了DomainExtractingServerList，DomainExtractingServerList自己会去eureka的注册表里去拉取服务对应的注册表（即：服务的实例列表）。</p>
</li>
</ol>
<p><strong>2&gt; Feign如何使用Ribbon进行负载均衡？</strong>
feign是基于ribbon的ZoneAwareLoadBalancer来进行负载均衡的，从一个server list中选择出来一个server。</p>
<p>接着上面的内容，进入到FeignLoadBalancer的executeWithLoadBalancer()方法；</p>
<p>由于AbstractLoadBalancerAwareClient是FeignLoadBalancer的父类，FeignLoadBalancer类中没有重写executeWithLoadBalancer()方法，进入到AbstractLoadBalancerAwareClient#executeWithLoadBalancer()方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071635683.png" alt="202403071635683" loading="lazy" decoding="async"></p>
<p>方法逻辑解析：</p>
<blockquote>
<ol>
<li>
<p>首先构建一个LoadBalancerCommand，LoadBalancerCommand刚创建的时候里面的server是null，也就是还没确定要对哪个server发起请求；</p>
</li>
<li>
<p>command.submit()方法的代码块，本质上是重写了LoadBalancerCommand#submit(ServerOperation<t>)方法入参ServerOperation的call()方法。</t></p>
<ul>
<li>call()方法内部根据选择出的Server构造出具体的http请求地址，然后基于底层的http通信组件，发送出去这个请求。</li>
<li>call()方法是被内嵌到LoadBalancerCommand#submit()方法中的，也就是在执行LoadBalancerCommand的时候会调用call()方法；</li>
</ul>
</li>
<li>
<p>最后通过command.toBlocking().single()方法，进行阻塞式的同步执行，获取到响应结果。</p>
</li>
</ol>
</blockquote>
<p>从整体来看，ServerOperation中封装了负载均衡选择出来的server，然后直接基于这个server替换掉请求URL中的服务名，拼接出最终的请求URL地址，然后基于底层的http组件发送请求。</p>
<p>LoadBalancerCommand肯定是在某个地方使用Ribbon的ZoneAwareLoadBalancer负载均衡选择出来了一个server，然后将这个server，交给ServerOpretion中的call()方法去处理。</p>
<p>结合方法的命名找到LoadBalancerCommand#selectServer()：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071639910.png" alt="202403071639910" loading="lazy" decoding="async"></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071640043.png" alt="202403071640043" loading="lazy" decoding="async"></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071642161.png" alt="202403071642161" loading="lazy" decoding="async"></p>
<p>selectServer()方法逻辑解析：</p>
<blockquote>
<p>在这个方法中，就是直接基于Feign集成的Ribbon的<code>ZoneAwareLoadBalancer</code>的 chooseServer() 方法，通过负载均衡机制选择了一个server出来。</p>
<ul>
<li>先通过LoadBalancerContext#getServerFromLoadBalancer()方法获取到ILoadBalancer；</li>
<li>在利用ILoadBalancer#chooseServer()方法选择出一个Server。</li>
</ul>
</blockquote>
<p>选择出一个Server之后，再去调用ServerOperation.call()方法，由call()方法拼接出最终的请求URI，发送http请求；</p>
<p><strong>3&gt; 最终发送出去的请求URI是什么样的？</strong>
ServerOperation#call()方法里负责发送请求，在executeWithLoadBalancer()方法中重写了LoadBalancerCommand#command()方法中入参ServerOperation的call()方法；</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071648955.png" alt="202403071648955" loading="lazy" decoding="async"></p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> URI</span><span style="color:#61AFEF"> reconstructURIWithServer</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Server</span><span style="color:#E06C75"> server</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> URI</span><span style="color:#E06C75"> original) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 获取服务 ip</span></span>
<span class="line"><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> host </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> server</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getHost</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 获取服务的 port</span></span>
<span class="line"><span style="color:#C678DD">  int</span><span style="color:#E06C75"> port </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> server</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPort</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 获取请求协议，这里为 http</span></span>
<span class="line"><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> scheme </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> server</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getScheme</span><span style="color:#ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">  if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">host</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getHost</span><span style="color:#ABB2BF">())</span></span>
<span class="line"><span style="color:#56B6C2">        &amp;&amp;</span><span style="color:#E06C75"> port </span><span style="color:#56B6C2">==</span><span style="color:#E5C07B"> original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getPort</span><span style="color:#ABB2BF">()</span></span>
<span class="line"><span style="color:#56B6C2">        &amp;&amp;</span><span style="color:#E06C75"> scheme </span><span style="color:#56B6C2">==</span><span style="color:#E5C07B"> original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getScheme</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> original</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"><span style="color:#C678DD">  if</span><span style="color:#E06C75"> (scheme </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">    scheme </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getScheme</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"><span style="color:#C678DD">  if</span><span style="color:#E06C75"> (scheme </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">    scheme </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> deriveSchemeAndPortFromPartialUri</span><span style="color:#E06C75">(original)</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">first</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C678DD">  try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#E5C07B">    StringBuilder</span><span style="color:#E06C75"> sb </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> StringBuilder</span><span style="color:#E06C75">()</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 拼接请求协议，此时请求为 http://</span></span>
<span class="line"><span style="color:#E5C07B">    sb</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(scheme).</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"://"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">Strings</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isNullOrEmpty</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRawUserInfo</span><span style="color:#ABB2BF">())</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">      sb</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRawUserInfo</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"@"</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 拼接请求 ip，此时请求为 http://192.168.1.3</span></span>
<span class="line"><span style="color:#E5C07B">    sb</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(host);</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (port </span><span style="color:#56B6C2">&gt;=</span><span style="color:#D19A66"> 0</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">      // 拼接请求 post，此时请求为 http://192.168.1.3:8082</span></span>
<span class="line"><span style="color:#E5C07B">      sb</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">":"</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(port);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 拼接请求路径，此时请求为 http://192.168.1.3:8082/user/sayHello/1</span></span>
<span class="line"><span style="color:#E5C07B">    sb</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRawPath</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 拼接请求查询参数，此时请求为 http:///user/sayHello/1?name=zhangsan&amp;age=18</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">Strings</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isNullOrEmpty</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRawQuery</span><span style="color:#ABB2BF">())</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">      sb</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"?"</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRawQuery</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#56B6C2">!</span><span style="color:#E5C07B">Strings</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isNullOrEmpty</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRawFragment</span><span style="color:#ABB2BF">())</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">      sb</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#98C379">"#"</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">append</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">original</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getRawFragment</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"><span style="color:#E5C07B">    URI</span><span style="color:#E06C75"> newURI </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> URI</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">sb</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toString</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E06C75"> newURI</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">URISyntaxException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">    throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> RuntimeException</span><span style="color:#E06C75">(e)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>方法逻辑解析：</p>
<blockquote>
<p>根据之前处理好的请求URI和Server的地址拼接出真实的地址； 依次拼接http://，服务的IP、服务的Port、请求路径、查询参数，最终体现为：</p>
<ul>
<li>原request的uri：GET http:///user/sayHello/1?name=saint&amp;age=18 HTTP/1.1</li>
<li>server地址：192.168.1.3:8082</li>
<li>拼接后的地址：<a href="http://192.168.1.3:8082/user/sayHello/1?name=saint&amp;age=18">http://192.168.1.3:8082/user/sayHello/1?name=saint&amp;age=18</a></li>
</ul>
</blockquote>
<p>接着使用拼接后的地址替换掉request.uri，再调用FeignLoadBalacner#execute()方法发送一个http请求；其中发送请求的超时时间默认为1000ms，即1s；最后返回结果封装到FeignLoadBalancer.RibbonResponse。</p>
<h6 id="指定decoder时对请求返回结果解码">指定Decoder时对请求返回结果解码</h6>
<p>如果配置了decoder，则使用Decoder#decode()方法对结果进行解码；</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#C678DD"> interface</span><span style="color:#E5C07B"> Decoder</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  /**</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * Decodes an http response into an object corresponding to its</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * {</span><span style="color:#C678DD;font-style:italic">@link</span><span style="color:#E5C07B;font-style:italic"> java.lang.reflect.Method</span><span style="color:#7F848E;font-style:italic">#</span><span style="color:#E06C75;font-style:italic">getGenericReturnType()</span><span style="color:#7F848E;font-style:italic"> generic return type}. If you need to</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * wrap exceptions, please do so via {@link DecodeException}.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   *</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * </span><span style="color:#C678DD;font-style:italic">@param</span><span style="color:#E06C75;font-style:italic"> response</span><span style="color:#7F848E;font-style:italic"> the response to decode</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * </span><span style="color:#C678DD;font-style:italic">@param</span><span style="color:#E06C75;font-style:italic"> type</span><span style="color:#7F848E;font-style:italic"> {</span><span style="color:#C678DD;font-style:italic">@link</span><span style="color:#E5C07B;font-style:italic"> java.lang.reflect.Method</span><span style="color:#7F848E;font-style:italic">#</span><span style="color:#E06C75;font-style:italic">getGenericReturnType()</span><span style="color:#7F848E;font-style:italic"> generic return type} of the</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   *        method corresponding to this {@code response}.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * </span><span style="color:#C678DD;font-style:italic">@return</span><span style="color:#7F848E;font-style:italic"> instance of {@code type}</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * </span><span style="color:#C678DD;font-style:italic">@throws</span><span style="color:#E5C07B;font-style:italic"> IOException</span><span style="color:#7F848E;font-style:italic"> will be propagated safely to the caller.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * </span><span style="color:#C678DD;font-style:italic">@throws</span><span style="color:#E5C07B;font-style:italic"> DecodeException</span><span style="color:#7F848E;font-style:italic"> when decoding failed due to a checked exception besides IOException.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   * </span><span style="color:#C678DD;font-style:italic">@throws</span><span style="color:#E5C07B;font-style:italic"> FeignException</span><span style="color:#7F848E;font-style:italic"> when decoding succeeds, but conveys the operation failed.</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">   */</span></span>
<span class="line"><span style="color:#E5C07B">  Object</span><span style="color:#61AFEF"> decode</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Response</span><span style="color:#E06C75;font-style:italic"> response</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Type</span><span style="color:#E06C75;font-style:italic"> type</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> IOException</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> DecodeException</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> FeignException</span><span style="color:#ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  /** Default implementation of {@code Decoder}. */</span></span>
<span class="line"><span style="color:#C678DD">  public</span><span style="color:#C678DD"> class</span><span style="color:#E5C07B"> Default</span><span style="color:#C678DD"> extends</span><span style="color:#E5C07B"> StringDecoder</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"></span>
<span class="line"><span style="color:#ABB2BF">    @</span><span style="color:#E5C07B">Override</span></span>
<span class="line"><span style="color:#C678DD">    public</span><span style="color:#E5C07B"> Object</span><span style="color:#61AFEF"> decode</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Response</span><span style="color:#E06C75;font-style:italic"> response</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">Type</span><span style="color:#E06C75;font-style:italic"> type</span><span style="color:#ABB2BF">)</span><span style="color:#C678DD"> throws</span><span style="color:#E5C07B"> IOException</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#C678DD">      if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">status</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 404</span><span style="color:#56B6C2"> ||</span><span style="color:#E5C07B"> response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">status</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> 204</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> Util</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">emptyValueOf</span><span style="color:#ABB2BF">(type);</span></span>
<span class="line"><span style="color:#C678DD">      if</span><span style="color:#ABB2BF"> (</span><span style="color:#E5C07B">response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">body</span><span style="color:#ABB2BF">() </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">)</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">      if</span><span style="color:#ABB2BF"> (</span><span style="color:#C678DD">byte</span><span style="color:#ABB2BF">[].</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">equals</span><span style="color:#ABB2BF">(type)) {</span></span>
<span class="line"><span style="color:#C678DD">        return</span><span style="color:#E5C07B"> Util</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">toByteArray</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">body</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">asInputStream</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#ABB2BF">      }</span></span>
<span class="line"><span style="color:#C678DD">      return</span><span style="color:#E5C07B"> super</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">decode</span><span style="color:#ABB2BF">(response, type);</span></span>
<span class="line"><span style="color:#ABB2BF">    }</span></span>
<span class="line"><span style="color:#ABB2BF">  }</span></span>
<span class="line"><span style="color:#ABB2BF">}</span></span>
<span class="line"></span></code></pre>
<h6 id="默认情况下feign接收到服务返回的结果后如何处理">默认情况下，Feign接收到服务返回的结果后，如何处理？</h6>
<p>即：未指定decoder时，会直接使用AsyncResponseHandler#handleResponse()方法处理接收到的服务返回结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071718925.png" alt="202403071718925" loading="lazy" decoding="async"></p>
<p><img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071723997.png" alt="202403071723997" loading="lazy" decoding="async"></p>
<p>如果响应结果的returnType为Response时，则将return信息的body()解析成byte数组，放到resultFuture的RESULT中；然后SynchronousMethodHandler#executeAndDecode()方法中通过resultFuture.join()方法拿到RESULT（即：请求的真正的响应结果）。</p>
<p>一般而言，会走到如下else if 分支</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#7F848E;font-style:italic">// 请求成功后，返回结果类型为 void，则处理的返回结果赋值 null</span></span>
<span class="line"><span style="color:#C678DD">if</span><span style="color:#E06C75"> (</span><span style="color:#61AFEF">isVoidType</span><span style="color:#E06C75">(returnType)) {</span></span>
<span class="line"><span style="color:#E5C07B">  resultFuture</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">complete</span><span style="color:#ABB2BF">(</span><span style="color:#D19A66">null</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E06C75">} </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 解析请求的返回结果</span></span>
<span class="line"><span style="color:#C678DD">  final</span><span style="color:#E5C07B"> Object</span><span style="color:#E06C75"> result </span><span style="color:#56B6C2">=</span><span style="color:#61AFEF"> decode</span><span style="color:#E06C75">(response</span><span style="color:#ABB2BF">,</span><span style="color:#E06C75"> returnType)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  shouldClose </span><span style="color:#56B6C2">=</span><span style="color:#E06C75"> closeAfterDecode</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">  resultFuture</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">complete</span><span style="color:#ABB2BF">(result);</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>decode()方法中将response处理为我们要的returnType，比如调用的服务方返回给我们一个JSON字符串，decode()方法中会将其转换为我们需要的JavaBean（即：returnType，当前方法的返回值）。</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#E5C07B">Object</span><span style="color:#61AFEF"> decode</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Response</span><span style="color:#E06C75"> response</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Type</span><span style="color:#E06C75"> type) throws IOException {</span></span>
<span class="line"><span style="color:#C678DD">  try</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> decoder</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">decode</span><span style="color:#ABB2BF">(response, type);</span></span>
<span class="line"><span style="color:#E06C75">  } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#C678DD">final</span><span style="color:#E5C07B"> FeignException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">    throw</span><span style="color:#E06C75"> e</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  } </span><span style="color:#C678DD">catch</span><span style="color:#E06C75"> (</span><span style="color:#C678DD">final</span><span style="color:#E5C07B"> RuntimeException</span><span style="color:#E06C75;font-style:italic"> e</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#C678DD">    throw</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> DecodeException</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">status</span><span style="color:#ABB2BF">(),</span><span style="color:#E5C07B"> e</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getMessage</span><span style="color:#ABB2BF">(),</span><span style="color:#E5C07B"> response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">request</span><span style="color:#ABB2BF">(),</span><span style="color:#E06C75"> e)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre>
<p>deocode()方法中会用到一个Decoder，decoder默认是OptionalDecoder，针对JavaBean返回类型，OptionalDecoder将decode委托给ResponseEntityDecoder处理。</p>
<h4 id="总结">总结</h4>
<blockquote>
<ol>
<li>请求达到FeignClient时，会进入到JDK动态代理类，由ReflectiveFeign#FeignInvocationHandler分发处理请求；找到接口方法对应的SynchronousMethodHandler；</li>
<li>SynchronousMethodHandler中首先使用SpringMvcContract解析标注了SpringMvc注解的参数；然后使用encoder对请求进行编码；</li>
<li>RequestInterceptor对Request进行拦截处理；</li>
<li>LoadBalancerFeignClient通过集成的Ribbon的负载均衡器（<code>ZoneAwareLoadBalancer</code>）实现负载均衡找到一个可用的Server，交给RibbonRequest组合的Client去做HTTP请求，这里的Client可以是HttpUrlConnection、HttpClient、OKHttp。</li>
<li>最后Decoder对Response响应进行解码。</li>
</ol>
</blockquote>
<h2 id="openfeign新版本和旧版本之间的差异高版本openfeign底层不使用ribbon做负载均衡">OpenFeign新版本和旧版本之间的差异（高版本OpenFeign底层不使用Ribbon做负载均衡）</h2>
<h3 id="feignclientsregistrar开启对feignclient的扫描">@FeignClientsRegistrar开启对FeignClient的扫描</h3>
<p><strong>此处主流程上无区别:</strong>
在SpringBoot启动流程中 @FeignClientsRegistrar 注解开启OpenFeign的入口、OpenFeign扫描所有的FeignClient的流程，高版本和低版本基本一样。</p>
<p>主要流程如下：</p>
<blockquote>
<p>1&gt; 开启扫描FeignClient的入口:</p>
<ol>
<li>启动类上添加的@EnableFeignClients注解会通过@Import注解在SpringBoot启动流程中将ImportBeanDefinitionRegistrar接口的实现类FeignClientsRegistrar注入到启动类的ConfigurationClass的属性中，在注册启动类的BeanDefinition时，会遍历调用其@Import的所有ImportBeanDefinitionRegistrar接口的 registerBeanDefinitions()方法。</li>
</ol>
<p>2&gt; 扫描FeignClient：</p>
<ol>
<li>拿到@EnableFeignClients注解中配置的扫描包路径相关的属性，得到要扫描的包路径；</li>
<li>获取到扫描器ClassPathScanningCandidateComponentProvider，然后给其添加一个注解过滤器（AnnotationTypeFilter），只过滤出包含@FeignClient注解的BeanDefinition；</li>
<li>扫描器的findCandidateComponents(basePackage)方法从包路径下扫描出所有标注了@FeignClient注解并符合条件装配的接口；然后将其在BeanDefinitionRegistry中注册一下；</li>
</ol>
</blockquote>
<h3 id="为feignclient生成动态代理类">为FeignClient生成动态代理类</h3>
<p><strong>区别主要体现在这里:</strong>
在注册FeignClient到Spring容器时，构建的BeanDefinition的beanClas是FeignClientFactoryBean；FeignClientFactoryBean是一个工厂，保存了@FeignClient注解的所有属性值，在Spring容器初始化的过程中，其会根据之前扫描出的FeignClient信息构建FeignClient的动态代理类。</p>
<p><strong>底层通信Client的区别？</strong>
在使用Feign.Builder构建FeignClient的时候，获取到的Client是FeignBlockingLoadBalancerClient（这其中的逻辑后面聊，在OpenFeign低版本是LoadBalancerFeignClient）；用于生成FeignClient的Targeter是DefaultTargeter（在OpenFeign低版本是HystrixTargeter，高版本移除了Hystrix，采用Spring Cloud Circuit Breaker 做限流熔断）；</p>
<p>具体体现在FeignClientFactoryBean#loadBalance()方法，其是一个进行负载均衡的FeignClient动态代理生成方法；</p>
<p><strong>1&gt; FeignBlockingLoadBalancerClient何时注入到Spring容器？</strong></p>
<p>FeignBlockingLoadBalancerClient注入到Spring容器的方式和OpenFeign低版本的LoadBalancerFeignClient是一样的；</p>
<p>进入到FeignBlockingLoadBalancerClient类中，看哪里调用了它唯一一个构造函数；</p>
<p>找到FeignBlockingLoadBalancerClient发现有三个地方调用了它的构造函数，new了一个实例；</p>
<ul>
<li>DefaultFeignLoadBalancedConfiguration</li>
<li>HttpClientFeignLoadBalancedConfiguration</li>
<li>OkHttpFeignLoadBalancedConfiguration</li>
</ul>
<p>再结合默认的配置，只有DefaultFeignLoadBalancedConfiguration中的Client符合条件装配；</p>
<p>可以通过引入Apache HttpClient的maven依赖使用HttpClientFeignLoadBalancedConfiguration，或引入OkHttpClient的maven依赖并在application.yml文件中指定feign.okhttp.enabled属性为true使用OkHttpFeignLoadBalancedConfiguration。</p>
<p><strong>2&gt; DefaultTargeter在哪里注入到Spring容器?</strong></p>
<p>DefaultTargeter注入到Spring容器的方式和OpenFeign低版本的HystrixTargeter是一样的；</p>
<p>在FeignAutoConfiguration类中可以找到Targeter注入到Spring容器的逻辑；</p>
<p><strong>3&gt; 后续生成动态代理类的逻辑和旧版本一样</strong>
都体现在ReflectiveFeign#newInstance()方法中：</p>
<h3 id="client处理负载均衡核心区别">Client处理负载均衡（核心区别）</h3>
<p>上面提到OpenFeign高版本获取到的Client是<code>FeignBlockingLoadBalancerClient</code>，而低版本的是<code>LoadBalancerFeignClient</code>，LoadBalancerFeignClient基于Ribbon实现负载均衡，FeignBlockingLoadBalancerClient就靠OpenFeign（通过loadBalancerClient）实现负载均衡；</p>
<p><strong>FeignBlockingLoadBalancerClient是如何做负载均衡的:</strong>
1&gt; FeignBlockingLoadBalancerClient选择一个服务实例</p>
<pre class="astro-code one-dark-pro" style="color:#abb2bf;white-space:pre-wrap;word-wrap:break-word;background-color:#282c34;overflow-x:auto" tabindex="0" data-language="java"><code><span class="line"><span style="color:#C678DD">public</span><span style="color:#E5C07B"> Response</span><span style="color:#61AFEF"> execute</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">Request</span><span style="color:#E06C75"> request</span><span style="color:#ABB2BF">,</span><span style="color:#E5C07B"> Request</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Options</span><span style="color:#E06C75"> options) throws IOException {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 将请求的 url 封装成 uri</span></span>
<span class="line"><span style="color:#E5C07B">  URI</span><span style="color:#E06C75"> originalUri </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> URI</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">create</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">request</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">url</span><span style="color:#ABB2BF">());</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 获取要请求的服务名</span></span>
<span class="line"><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> serviceId </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> originalUri</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getHost</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">  Assert</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">state</span><span style="color:#ABB2BF">(serviceId </span><span style="color:#56B6C2">!=</span><span style="color:#D19A66"> null</span><span style="color:#ABB2BF">, </span><span style="color:#98C379">"Request URI does not contain a valid hostname: "</span><span style="color:#56B6C2"> +</span><span style="color:#ABB2BF"> originalUri);</span></span>
<span class="line"><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> hint </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getHint</span><span style="color:#ABB2BF">(serviceId);</span></span>
<span class="line"><span style="color:#E5C07B">  DefaultRequest</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">RequestDataContext</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> lbRequest </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> DefaultRequest</span><span style="color:#E06C75">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> RequestDataContext</span><span style="color:#E06C75">(</span><span style="color:#E5C07B">LoadBalancerUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">buildRequestData</span><span style="color:#ABB2BF">(request),</span><span style="color:#E06C75"> hint))</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">  Set</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">LoadBalancerLifecycle</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> supportedLifecycleProcessors </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> LoadBalancerLifecycleValidator</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getSupportedLifecycleProcessors</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">loadBalancerClientFactory</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">getInstances</span><span style="color:#ABB2BF">(serviceId, </span><span style="color:#E5C07B">LoadBalancerLifecycle</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">), </span><span style="color:#E5C07B">RequestDataContext</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">ResponseData</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">, </span><span style="color:#E5C07B">ServiceInstance</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">class</span><span style="color:#ABB2BF">);</span></span>
<span class="line"><span style="color:#E5C07B">  supportedLifecycleProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forEach</span><span style="color:#ABB2BF">((lifecycle) </span><span style="color:#C678DD">-&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">    lifecycle</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">onStart</span><span style="color:#ABB2BF">(lbRequest);</span></span>
<span class="line"><span style="color:#ABB2BF">  });</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">  // 选择一个服务实例</span></span>
<span class="line"><span style="color:#E5C07B">  ServiceInstance</span><span style="color:#E06C75"> instance </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">loadBalancerClient</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">choose</span><span style="color:#ABB2BF">(serviceId, lbRequest);</span></span>
<span class="line"><span style="color:#E5C07B">  org</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">springframework</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">cloud</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">client</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">loadbalancer</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">Response</span><span style="color:#ABB2BF">&lt;</span><span style="color:#E5C07B">ServiceInstance</span><span style="color:#ABB2BF">&gt;</span><span style="color:#E06C75"> lbResponse </span><span style="color:#56B6C2">=</span><span style="color:#C678DD"> new</span><span style="color:#61AFEF"> DefaultResponse</span><span style="color:#E06C75">(instance)</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#E5C07B">  String</span><span style="color:#E06C75"> message</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">  if</span><span style="color:#E06C75"> (instance </span><span style="color:#56B6C2">==</span><span style="color:#D19A66"> null</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E06C75">    message </span><span style="color:#56B6C2">=</span><span style="color:#98C379"> "Load balancer does not contain an instance for the service "</span><span style="color:#56B6C2"> +</span><span style="color:#E06C75"> serviceId</span><span style="color:#ABB2BF">;</span></span>
<span class="line"><span style="color:#C678DD">    if</span><span style="color:#E06C75"> (</span><span style="color:#E5C07B">LOG</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">isWarnEnabled</span><span style="color:#ABB2BF">()</span><span style="color:#E06C75">) {</span></span>
<span class="line"><span style="color:#E5C07B">      LOG</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">warn</span><span style="color:#ABB2BF">(message);</span></span>
<span class="line"><span style="color:#E06C75">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C07B">    supportedLifecycleProcessors</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">forEach</span><span style="color:#ABB2BF">((lifecycle) </span><span style="color:#C678DD">-&gt;</span><span style="color:#ABB2BF"> {</span></span>
<span class="line"><span style="color:#E5C07B">      lifecycle</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">onComplete</span><span style="color:#ABB2BF">(</span><span style="color:#C678DD">new</span><span style="color:#61AFEF"> CompletionContext</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">Status</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">DISCARD</span><span style="color:#ABB2BF">, lbRequest, lbResponse));</span></span>
<span class="line"><span style="color:#ABB2BF">    });</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> Response</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">builder</span><span style="color:#ABB2BF">().</span><span style="color:#61AFEF">request</span><span style="color:#ABB2BF">(request).</span><span style="color:#61AFEF">status</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">HttpStatus</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">SERVICE_UNAVAILABLE</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">value</span><span style="color:#ABB2BF">()).</span><span style="color:#61AFEF">body</span><span style="color:#ABB2BF">(message, </span><span style="color:#E5C07B">StandardCharsets</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">UTF_8</span><span style="color:#ABB2BF">).</span><span style="color:#61AFEF">build</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E06C75">  } </span><span style="color:#C678DD">else</span><span style="color:#E06C75"> {</span></span>
<span class="line"><span style="color:#7F848E;font-style:italic">    // 构建完整的请求 url</span></span>
<span class="line"><span style="color:#E06C75">    message </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">loadBalancerClient</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">reconstructURI</span><span style="color:#ABB2BF">(instance, originalUri).</span><span style="color:#61AFEF">toString</span><span style="color:#ABB2BF">();</span></span>
<span class="line"><span style="color:#E5C07B">    Request</span><span style="color:#E06C75"> newRequest </span><span style="color:#56B6C2">=</span><span style="color:#E5C07B"> this</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">buildRequest</span><span style="color:#ABB2BF">(request, message, instance);</span></span>
<span class="line"><span style="color:#C678DD">    return</span><span style="color:#E5C07B"> LoadBalancerUtils</span><span style="color:#ABB2BF">.</span><span style="color:#61AFEF">executeWithLoadBalancerLifecycleProcessing</span><span style="color:#ABB2BF">(</span><span style="color:#E5C07B">this</span><span style="color:#ABB2BF">.</span><span style="color:#E5C07B">delegate</span><span style="color:#ABB2BF">, options, newRequest, lbRequest, lbResponse, supportedLifecycleProcessors);</span></span>
<span class="line"><span style="color:#E06C75">  }</span></span>
<span class="line"><span style="color:#E06C75">}</span></span>
<span class="line"></span></code></pre> </article> <ul class="astro-vj4tpspi my-8"> <li class="inline-block astro-blwjyjpt my-1 underline-offset-4"> <a href="/astro/tags/java/" class="astro-blwjyjpt group pr-2 text-sm" data-astro-transition-scope="astro-36ssibgs-2"> <svg xmlns="http://www.w3.org/2000/svg" class="astro-blwjyjpt scale-75"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-blwjyjpt"></path> </svg>
&nbsp;<span class="astro-blwjyjpt">java</span> </a> </li> <li class="inline-block astro-blwjyjpt my-1 underline-offset-4"> <a href="/astro/tags/feign/" class="astro-blwjyjpt group pr-2 text-sm" data-astro-transition-scope="astro-36ssibgs-3"> <svg xmlns="http://www.w3.org/2000/svg" class="astro-blwjyjpt scale-75"><path d="M16.018 3.815 15.232 8h-4.966l.716-3.815-1.964-.37L8.232 8H4v2h3.857l-.751 4H3v2h3.731l-.714 3.805 1.965.369L8.766 16h4.966l-.714 3.805 1.965.369.783-4.174H20v-2h-3.859l.751-4H21V8h-3.733l.716-3.815-1.965-.37zM14.106 14H9.141l.751-4h4.966l-.752 4z" class="astro-blwjyjpt"></path> </svg>
&nbsp;<span class="astro-blwjyjpt">feign</span> </a> </li>  </ul> <div class="astro-vj4tpspi flex items-center flex-col-reverse gap-6 justify-between sm:flex-row-reverse sm:gap-4 sm:items-end"> <button id="back-to-top" class="astro-vj4tpspi focus-outline hover:opacity-75 py-1 whitespace-nowrap"> <svg xmlns="http://www.w3.org/2000/svg" class="astro-vj4tpspi rotate-90"> <path d="M13.293 6.293 7.586 12l5.707 5.707 1.414-1.414L10.414 12l4.293-4.293z" class="astro-vj4tpspi"></path> </svg> <span class="astro-vj4tpspi">Back to Top</span> </button> <div class="astro-wkojbtzc social-icons"> <span class="astro-wkojbtzc italic">Share this post on:</span> <div class="astro-wkojbtzc text-center"> <a href="https://wa.me/?text=https://chou401.github.io/astro/posts/feign-and-open-feign-definition/" class="astro-wkojbtzc group hover:text-skin-accent inline-block link-button" title="Share this post via WhatsApp"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 21l1.65 -3.8a9 9 0 1 1 3.4 2.9l-5.05 .9"></path>
      <path d="M9 10a0.5 .5 0 0 0 1 0v-1a0.5 .5 0 0 0 -1 0v1a5 5 0 0 0 5 5h1a0.5 .5 0 0 0 0 -1h-1a0.5 .5 0 0 0 0 1"></path>
    </svg> <span class="astro-wkojbtzc sr-only">Share this post via WhatsApp</span> </a><a href="https://www.facebook.com/sharer.php?u=https://chou401.github.io/astro/posts/feign-and-open-feign-definition/" class="astro-wkojbtzc group hover:text-skin-accent inline-block link-button" title="Share this post on Facebook"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path d="M7 10v4h3v7h4v-7h3l1 -4h-4v-2a1 1 0 0 1 1 -1h3v-4h-3a5 5 0 0 0 -5 5v2h-3"></path>
  </svg> <span class="astro-wkojbtzc sr-only">Share this post on Facebook</span> </a><a href="https://twitter.com/intent/tweet?url=https://chou401.github.io/astro/posts/feign-and-open-feign-definition/" class="astro-wkojbtzc group hover:text-skin-accent inline-block link-button" title="Tweet this post"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z"></path>
    </svg> <span class="astro-wkojbtzc sr-only">Tweet this post</span> </a><a href="https://t.me/share/url?url=https://chou401.github.io/astro/posts/feign-and-open-feign-definition/" class="astro-wkojbtzc group hover:text-skin-accent inline-block link-button" title="Share this post via Telegram"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
        <path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4"></path>
      </svg> <span class="astro-wkojbtzc sr-only">Share this post via Telegram</span> </a><a href="https://pinterest.com/pin/create/button/?url=https://chou401.github.io/astro/posts/feign-and-open-feign-definition/" class="astro-wkojbtzc group hover:text-skin-accent inline-block link-button" title="Share this post on Pinterest"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <line x1="8" y1="20" x2="12" y2="11"></line>
      <path d="M10.7 14c.437 1.263 1.43 2 2.55 2c2.071 0 3.75 -1.554 3.75 -4a5 5 0 1 0 -9.7 1.7"></path>
      <circle cx="12" cy="12" r="9"></circle>
    </svg> <span class="astro-wkojbtzc sr-only">Share this post on Pinterest</span> </a><a href="mailto:?subject=See%20this%20post&amp;body=https://chou401.github.io/astro/posts/feign-and-open-feign-definition/" class="astro-wkojbtzc group hover:text-skin-accent inline-block link-button" title="Share this post via email"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <rect x="3" y="5" width="18" height="14" rx="2"></rect>
      <polyline points="3 7 12 13 21 7"></polyline>
    </svg> <span class="astro-wkojbtzc sr-only">Share this post via email</span> </a> </div> </div>  </div> </main> <footer class="astro-sz7xmlte mt-auto"> <div class="max-w-3xl mx-auto px-0"> <hr class="border-skin-line" aria-hidden="true"> </div> <div class="astro-sz7xmlte footer-wrapper"> <div class="astro-upu6fzxr flex social-icons"> <a href="https://github.com/chou401/astro" class="inline-block group hover:text-skin-accent link-button astro-upu6fzxr" title=" 知道的越多，才知知道的越少 on Github"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path>
  </svg> <span class="sr-only astro-upu6fzxr"> 知道的越多，才知知道的越少 on Github</span> </a><a href="https://github.com/chou401/astro" class="inline-block group hover:text-skin-accent link-button astro-upu6fzxr" title="知道的越多，才知知道的越少 on Facebook"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <path d="M7 10v4h3v7h4v-7h3l1 -4h-4v-2a1 1 0 0 1 1 -1h3v-4h-3a5 5 0 0 0 -5 5v2h-3"></path>
  </svg> <span class="sr-only astro-upu6fzxr">知道的越多，才知知道的越少 on Facebook</span> </a><a href="https://github.com/chou401/astro" class="inline-block group hover:text-skin-accent link-button astro-upu6fzxr" title="知道的越多，才知知道的越少 on Instagram"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <rect x="4" y="4" width="16" height="16" rx="4"></rect>
    <circle cx="12" cy="12" r="3"></circle>
    <line x1="16.5" y1="7.5" x2="16.5" y2="7.501"></line>
  </svg> <span class="sr-only astro-upu6fzxr">知道的越多，才知知道的越少 on Instagram</span> </a><a href="https://github.com/chou401/astro" class="inline-block group hover:text-skin-accent link-button astro-upu6fzxr" title="知道的越多，才知知道的越少 on LinkedIn"> <svg xmlns="http://www.w3.org/2000/svg" class="icon-tabler" stroke-linecap="round" stroke-linejoin="round">
    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
    <rect x="4" y="4" width="16" height="16" rx="2"></rect>
    <line x1="8" y1="11" x2="8" y2="16"></line>
    <line x1="8" y1="8" x2="8" y2="8.01"></line>
    <line x1="12" y1="16" x2="12" y2="11"></line>
    <path d="M16 16v-3a2 2 0 0 0 -4 0"></path>
  </svg> <span class="sr-only astro-upu6fzxr">知道的越多，才知知道的越少 on LinkedIn</span> </a> </div>  <div class="astro-sz7xmlte copyright-wrapper"> <span class="astro-sz7xmlte">Copyright © 2024</span> <span class="astro-sz7xmlte separator">&nbsp;|&nbsp;</span> <span class="astro-sz7xmlte">All rights reserved.</span> </div> </div> </footer>     <script>function addHeadingLinks(){let c=Array.from(document.querySelectorAll("h2, h3, h4, h5, h6"));for(let d of c){d.classList.add("group");let t=document.createElement("a");t.innerText="#",t.className="heading-link hidden group-hover:inline-block ml-2",t.href="#"+d.id,t.ariaHidden="true",d.appendChild(t)}}addHeadingLinks();function attachCopyButtons(){let c="Copy",d=Array.from(document.querySelectorAll("pre"));for(let e of d){let o=document.createElement("div");o.style.position="relative";let n=document.createElement("button");n.className="copy-code absolute right-3 -top-3 rounded bg-skin-card px-2 py-1 text-xs leading-4 text-skin-base font-medium",n.innerHTML=c,e.setAttribute("tabindex","0"),e.appendChild(n),e?.parentNode?.insertBefore(o,e),o.appendChild(e),n.addEventListener("click",async()=>{await t(e,n)})}async function t(e,o){let i=e.querySelector("code")?.innerText;await navigator.clipboard.writeText(i??""),o.innerText="Copied",setTimeout(()=>{o.innerText=c},700)}}attachCopyButtons();function backToTop(){document.querySelector("#back-to-top")?.addEventListener("click",()=>{document.body.scrollTop=0,document.documentElement.scrollTop=0})}backToTop();
</script></body></html>